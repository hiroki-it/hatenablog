---
Title: 【ArgoCD🐙️】KubernetesのマルチテナントパターンとArgoCDの実践テナント設計
Category:
  - ArgoCD
  - Kubernetes
  - ソフトウェアアーキテクチャ
  - 認証/認可
Date: 2023-08-18T11:06:46+09:00
URL: https://hiroki-hasegawa.hatenablog.jp/entry/2023/08/18/110646
EditURL: https://blog.hatena.ne.jp/hiroki-hasegawa/hiroki-hasegawa.hatenablog.jp/atom/entry/820878482959441002
---

<br>

# この記事から得られる知識

この記事を読むと、以下を **"完全に理解"** できます✌️

- Kubernetesのマルチテナントパターンの種類
- マルチテナントパターンをArgoCDで実践する場合にオススメのパターン (★)
- ArgoCDのNamespacedスコープモードとClusterスコープモード
- ArgoCDのテナントが防いでくれる誤った操作の具体例

記事のざっくりした内容は、以下のスライドからキャッチアップできちゃいます！

<iframe class="speakerdeck-iframe" frameborder="0" src="https://speakerdeck.com/player/1bca797dbeaf43a2ae8ccd80dea3a1eb" title="🐙 KubernetesのマルチテナントパターンとArgoCDの実践テナント設計" allowfullscreen="true" style="border: 0px; background: padding-box padding-box rgba(0, 0, 0, 0.1); margin: 0px; padding: 0px; border-radius: 6px; box-shadow: rgba(0, 0, 0, 0.2) 0px 5px 40px; width: 100%; height: auto; aspect-ratio: 560 / 315;" data-ratio="1.7777777777777777"></iframe>

<br>

[:contents]

<br>

# 01. はじめに

<br>

『先日助けて頂いたアルトバイエルンです』

<figure><img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_community-board.png" alt="argocd_community-board"><figcaption>画像引用元：<a href="https://github.com/argoproj">Argo Project</a></figcaption></figure>

<br>

さて最近の業務で、全プロダクトの技術基盤開発チームに携わっており、全プロダクト共有のArgoCD🐙のマルチテナント化を担当しました。

プロダクトが稼働するKubernetes Clusterが数十個あり、Clusterによっては複数のチームが合計`100`個以上のマイクロサービスを動かしています。

このような大規模なマイクロサービスシステムがいくつもある状況下で、ArgoCDのマルチテナント設計の知見を深められたため、記事で解説しました。

書きたいことを全部書いたところ、情報量がエグいことになってしまったため、気になる章だけでも拾って帰っていただけるとハッピーです🙏

- [Kubernetesのマルチテナントパターン](#03-Kubernetesのマルチテナントパターン) (3章)
- [ArgoCDでのテナントパターン実践の一覧](#04-ArgoCDでのテナントパターン実践の一覧) (4章)
- [ArgoCDのClusterスコープモードとNamespacedスコープモード](#05-CLモードなArgoCD) (5章)
- [AppProjectテナントのデプロイ制限の仕組み](#06-AppProjectテナントのデプロイ制限の仕組み) (6章)

それでは、もりもり布教していきます😗

<div class="text-box">
記事中のこのボックスは、補足情報を記載しています。
<br>
<br>
飛ばしていただいても大丈夫ですが、読んでもらえるとより理解が深まるはずです👍
</div>

<br>

# 02. なぜArgoCDにマルチテナントが必要なのか

## シングルテナントの場合

そもそも、なぜArgoCDにマルチテナントが必要なのでしょうか。

例えば、マニフェストのデプロイ先となるプロダクト用Cluster (例：`foo`、`bar`、`baz`) があると仮定します。

ArgoCDをシングルテナントにする場合、各プロダクトチームの操作するApplicationを同じテナントに共存させることになります。

この場合、単一のargocd-server (ダッシュボード) から全てのApplicationを操作できて便利です。

しかし、プロダクト用Cluster数が増えていくにつれて、問題が起こり始めます。

例えば、いずれかのプロダクトチームが誤ったApplicationを操作し、結果的に誤ったプロダクト用Clusterにマニフェストをデプロイしてしまう可能性があります。

もちろん、システムでインシデントを起こしてやろうという悪意を持った人が、誤ったプロダクト用Clusterを意図的に選ぶ可能性もあります😈

![argocd_single-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_single-tenant.png)

<br>

## マルチテナントの場合

その一方で、いい感じのマルチテナントにしたとします。

プロダクトチームは、認可されたテナントに所属するApplicationにのみを操作でき、反対に無認可のテナントのApplicationは操作できません。

これにより、誤ったプロダクト用Clusterにマニフェストをデプロイすることを防げます。

![argocd_multi-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant.png)

<br>

# 03. Kubernetesのマルチテナントパターン

## マルチテナントパターンの一覧

ArgoCDのテナント設計を実践する前に、Kubernetesにはどんなマルチテナントパターンがあるのでしょうか。

Kubernetesのマルチテナントパターンは、以下に大別できます。

<table>
   <tbody>
      <thead>
      <tr>
         <th colspan="2" style="text-align: center;"></th>
         <th style="text-align: center;">Clusters<br><nobr>as-a-Service</nobr></th>
         <th style="text-align: center;">Control Planes<br><nobr>as-a-Service</nobr></th>
         <th style="text-align: center;">Namespaces<br><nobr>as-a-Service</nobr></th>
         <th style="text-align: center;">カスタムリソース<br>テナント</th>
      </tr>
      </thead>
      <tr>
         <td colspan="2" style="text-align: center;">テナント単位</td>
         <td style="text-align: center;">実Cluster</td>
         <td style="text-align: center;">仮想Cluster</td>
         <td style="text-align: center;">Namespace</td>
         <td style="text-align: center;">ツール固有の論理空間</td>
      </tr>
      <tr>
         <td rowspan="2" style="text-align: center;">テナント間でKubernetesリソースを分離できるか</td>
         <td style="text-align: center;">Cluster<br>スコープ<br>リソース</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;">ツールによる</td>
      </tr>
      <tr>
         <td style="text-align: center;">Namespaced<br>スコープ<br>リソース</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;"></td>
         <td style="text-align: center;">ツールによる</td>
      </tr>
      <tr>
         <td colspan="2" style="text-align: center;">ツール</td>
         <td><ul><li>AWS EKS</li><li>GCP GKE</li><li>Azure AKE</li><li>Kubeadm</li></ul>など</td>
         <td><ul><li>Kcp</li><li>tensile-kube</li><li>vcluster</li><li>VirtualCluster</li></ul>など</td>
         <td>Namespaceを増やすだけなので特別なツール不要</td>
         <td><ul><li>ArgoCDのAppProject</li><li>CapsuleのTenant</li><li>kioskのAccount</li><li>KubeZooのTenant</li></ul>など</td>
      </tr>
   </tbody>
</table>

<br>

<div class="text-box">
<div class="text-box-title">▶ 他のマルチテナントの分類方法について</div>
<br>
本記事では言及しませんが、<b>"ソフトマルチテナンシー"</b> と <b>"ハードマルチテナンシー"</b> といった分類方法もあります。
<br>
<br>
この分類方法では、テナント間の分離度の観点で各マルチテナントを種別します。
<br>
<br>
ソフトマルチテナンシーは、互いに信頼できる前提の上で、テナント間を弱く分離します。
<br>
<br>
その一方で、ハードマルチテナンシーは、互いに信頼できない前提の上でテナント間を強く分離します。
<br>
<br>
分離度がソフトとハードのいずれであるかに客観的な指標がなく、やや曖昧な種別になってしまうため、本記事の X as-a-Service の方が個人的には好みです♡♡♡
<br>
<br>
<blockquote>
<ul>
<li>[asin:B072TS9ZQZ:title]</li>
<li>[https://kubernetes.io/docs/concepts/security/multi-tenancy/#isolation:title]</li>
<li>[https://aws.github.io/aws-eks-best-practices/security/docs/multitenancy/:title]</li>
</ul>
</blockquote>
</div>

<br>

## Clusters as-a-Service

Clusters as-a-Serviceは、テナントごとに独立したClusterを提供します。

ツールとして、AWS EKS、GCP GKE、Azure AKE、Kubeadm、などがあります。

![argocd_multi-tenant_k8s_clusters-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_clusters-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

<br>

## Control Planes as-a-Service

Control Planes as-a-Serviceは、テナントごとに独立したコントロールプレーン (言い換えば仮想Cluster) を提供します。

ツールとして、<a href="https://github.com/kcp-dev/kcp">Kcp</a>、<a href="https://github.com/virtual-kubelet/tensile-kube">tensile-kube</a>、<a href="https://github.com/loft-sh/vcluster">vcluster</a>、<a href="https://github.com/kubernetes-sigs/cluster-api-provider-nested/tree/main/virtualcluster">VirtualCluster</a>、などがあります。

![argocd_multi-tenant_k8s_control-planes-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_control-planes-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

<br>

## Namespaces as-a-Service

Namespaces as-a-Serviceは、テナントごとに独立したNamespaceを提供します。

Namespaceを増やすだけなため、ツールは不要です。

![argocd_multi-tenant_k8s_namespaces-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_namespaces-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

<br>

## カスタムリソーステナント

カスタムリソーステナントは、テナントごとにツール固有の論理空間 (例：<a href="https://argo-cd.readthedocs.io/en/stable/user-guide/projects/">ArgoCD</a>のAppProject、<a href="https://github.com/clastix/capsule">Capsule</a>のTenant、<a href="https://github.com/loft-sh/kiosk">kiosk</a>のAccount、<a href="https://github.com/kubewharf/kubezoo">KubeZoo</a>のTenant、など) を提供します。

ツールによっては、X as-a-Service も兼ねている場合があります。

今回紹介するAppProjectはNamespaceテナントを兼ねており、[カスタムリソーステナント](#04-05-カスタムリソーステナントの実践) で解説しています。

![argocd_multi-tenant_k8s_tool](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_tool.png)

<br>

# 04. ArgoCDでのテナントパターン実践の一覧

お待たせしました。

ここからは、KubernetesのマルチテナントパターンをArgoCDで具体的に実践し、おすすめのパターン実践を解説していきます。

なお、オススメするものを ★ としています。

<table>
   <tbody>
      <thead>
      <tr>
         <th colspan="2" style="text-align: center;"></th>
         <th style="text-align: center;"><a href="#実Clusterテナント">実Cluster<br>テナント</a></th>
         <th style="text-align: center;"><a href="#仮想Clusterテナント---">仮想Cluster<br>テナント</a></th>
         <th style="text-align: center;"><a href="#04-04-Namespaces-as-a-Service-の実践">Namespace<br>テナント</a></th>
         <th style="text-align: center;"><a href="#05-CLモードなArgoCD">AppProject<br>テナント<br><nobr>CLモード</nobr></a></th>
         <th style="text-align: center;"><a href="#05-02-NSモードなArgoCD---">AppProject<br>テナント<br><nobr>NSモード</nobr></a></th>
      </tr>
      </thead>
      <tr>
         <td colspan="2" style="text-align: center;">対応するテナントパターン</td>
         <td style="text-align: center;">Clusters<br><nobr>as-a-Service</nobr></td>
         <td style="text-align: center;">Control Planes<br><nobr>as-a-Service</nobr></td>
         <td style="text-align: center;">Namespaces<br><nobr>as-a-Service</nobr></td>
         <td colspan="2" style="text-align: center;">カスタムリソース<br>テナント</td>
      </tr>
      <tr>
         <td colspan="2" style="text-align: center;">ArgoCDがテナント間で占有 / 共有</td>
         <td style="text-align: center;">占有</td>
         <td style="text-align: center;">占有</td>
         <td style="text-align: center;">占有</td>
         <td style="text-align: center;">共有</td>
         <td style="text-align: center;">占有</td>
      </tr>
      <tr>
         <td rowspan="2" style="text-align: center;">テナント間でKubernetesリソースを分離できるか</td>
         <td style="text-align: center;">Namespaced<br>スコープ<br>リソース</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;">✅</td>
      </tr>
      <tr>
         <td style="text-align: center;">Cluster<br>スコープ<br>リソース</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;"></td>
         <td style="text-align: center;"></td>
         <td style="text-align: center;"></td>
      </tr>
      <tr>
         <td colspan="2" style="text-align: center;">オススメ</td>
         <td style="text-align: center;"></td>
         <td style="text-align: center;">★</td>
         <td style="text-align: center;"></td>
         <td style="text-align: center;"></td>
         <td style="text-align: center;">★★</td>
      </tr>
   </tbody>
</table>

> - [https://akuity.io/blog/argo-cd-architectures-explained/:title]

<br>

以降の図の凡例です。

ArgoCDの各コンポーネント (application-controller、argocd-server、dex-server、repo-server) と各リソース (Application、AppProject) を区別しています。

![argocd_multi-tenant_legend](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_legend.png)

<br>

# 04-02. Clusters as-a-Service の実践

## 実Clusterテナント

実Clusterテナントは、Clusters as-a-Serviceなテナントの実践であり、実際のClusterをテナントの単位とします。

後述の仮想Clusterと対比させるために、**"実Cluster"** と呼ぶことにします。

各プロダクトチームは、実Clusterテナント内のApplicationを操作し、正しいプロダクト用Clusterにマニフェストをデプロイします。

![argocd_multi-tenant_physical_cluster](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_physical_cluster.png)

<br>

## オススメしない理由

実Clusterテナントには、以下のメリデメがあります。

デメリットの回避策も考慮して、独断と偏見でオススメしませんでした。

<blockquote class="twitter-tweet tw-align-center" data-width="300"><p lang="ja" dir="ltr">半年以内にアップグレードしないとサポートが切れるKubernetesクラスターが33個もあって、泣いちゃった</p>&mdash; 長谷川 広樹 (俺です) (@Hiroki__IT) <a href="https://twitter.com/Hiroki__IT/status/1615710926489124865?ref_src=twsrc%5Etfw">January 18, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                                                                          | デメリット **×**                                                                                |     | デメリットの回避策                                                                   |
| :---------------------------------: | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- | --- | ------------------------------------------------------------------------------------ |
|               拡張性                | -                                                                                                                                                                    | テナントを増やすために実Clusterを用意する必要があり、作業量が多い。                             | ➡︎ | IaCツールで実Clusterを用意するようにすれば作業量を減らせるが、やっぱりとてもつらい😭 |
|      安全性<br>(セキュリティ)       | ClusterからClusterへの名前解決を不可能にすれば、他のテナントからの通信を遮断できる。                                                                                 | -                                                                                               | ➡︎ | -                                                                                    |
|               保守性                | ClusterスコープまたはNamespacedスコープなKubernetesリソースを他のテナントから分離できる。<br>これらのKubernetesリソース (特にCRD) の変更が他のテナントに影響しない。 | 各テナントが、個別に実Clusterを保守しないといけない。<nobr>(例：アップグレード、機能修正、など) | ➡︎ | 回避できず、とてもつらい😭                                                           |
|                性能                 | Clusterのハードウェアリソースを他のテナントと奪い合うことなく、これを独占できる。                                                                                    | -                                                                                               | ➡︎ | -                                                                                    |
|               信頼性                | テナントごとに実Clusterが独立しており、他の実Clusterから障害の影響を受けない。                                                                                       | -                                                                                               | ➡︎ | -                                                                                    |

<br>

# 04-03. Control Planes as-a-Service の実践

## 仮想Clusterテナント - ★

仮想Clusterテナントは、Control Planes as-a-Serviceなテナントの実践であり、仮想Clusterをテナントの単位とします。

各プロダクトチームは、仮想Clusterテナント内のApplicationを操作し、正しいプロダクト用Clusterにマニフェストをデプロイします。

![argocd_multi-tenant_virtual_cluster](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_virtual_cluster.png)

> - [https://blog.argoproj.io/using-argo-cd-with-vclusters-5df53d1c51ce:title]

<br>

## オススメした理由

仮想Clusterテナントには、以下のメリデメがあります。

デメリットの回避策も考慮して、独断と偏見で **<font color="#FF0000">オススメ</font>** しました。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                                                                          | デメリット **×**                                                                                         |     | デメリットの回避策                                                                     |
| :---------------------------------: | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- | --- | -------------------------------------------------------------------------------------- |
|               拡張性                | テナントを増やすためにマニフェストで定義した仮想Clusterを用意するだけでよく、実Clusterを用意することと比べて作業量が少ない。                                         | -                                                                                                        | ➡︎ | -                                                                                      |
|      安全性<br>(セキュリティ)       | 仮想ClusterからホストClusterへの名前解決を不可能にすれば、他のテナントからの通信を遮断できる。                                                                       | -                                                                                                        | ➡︎ | -                                                                                      |
|               保守性                | ClusterスコープまたはNamespacedスコープなKubernetesリソースを他のテナントから分離できる。<br>これらのKubernetesリソース (特にCRD) の変更が他のテナントに影響しない。 | 各テナントが、個別に仮想Clusterを保守しないといけない。<nobr>(例：アップグレード、機能修正、など)</nobr> | ➡︎ | 仮想Clusterに関する知見を持つ組織であれば、各テナントで保守できる。                    |
|                性能                 | -                                                                                                                                                                    | Clusterのハードウェアリソースを他のテナントと奪い合うことになる。                                        | ➡︎ | 多くの利用者が同時並行的にArgoCDを操作する状況になりにくければ、奪い合いも起こらない。 |
|               信頼性                | テナントごとに仮想Clusterが独立しており、他の仮想Clusterから障害の影響を受けない。                                                                                   | -                                                                                                        | ➡︎ | -                                                                                      |

<br>

# 04-04. Namespaces as-a-Service の実践

Namespaceテナントは、Namespaces as-a-Serviceなテナントの実践であり、Namespaceをテナントの単位とします。

後述の [AppProjectテナント](#04-05-カスタムリソーステナントの実践) は二重のテナントを持ち、Namespaceテナントも兼ねています。

そのため、ここではNamespaceテナントの解説は省略します。

<br>

# 04-05. カスタムリソーステナントの実践

## AppProjectテナント

![argocd_multi-tenant_appproject](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject.png)

AppProjectテナントは、カスタムリソーステナントの実践であり、NamespaceとAppProjectをテナントの単位とします。

AppProjectテナントは、二重のテナント (**<font color="#FF0000">第一テナントにNamespace</font>**、**<font color="#FF0000">第二テナントに複数のAppProject</font>**) を持ち、**"あらゆる面から"** マニフェストのデプロイを制限します。

特に、AppProjectはNamespaceスコープなカスタムリソースであり、自身に所属するApplicationを一括して制限します。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: foo-tenant
  namespace: foo
  # 自身に所属するApplicationを制限する
spec: ...
```

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-application
  namespace: foo
spec:
  # foo-tenantに所属する
  project: foo-tenant
  ...
```

> - [asin:B09WF3FDTG:title]
> - [https://argo-cd.readthedocs.io/en/stable/user-guide/projects/:title]

<br>

<div class="text-box">
<div class="text-box-title">▶ カスタムリソースの仕様について</div>
<br>
カスタムリソースのCRDの実装から、ドキュメントに未記載の仕様を読み取れることがあります。
<br>
<br>
例えば、本記事ではAppProjectに自由にNamespaceを設定していますが、ArgoCDのドキュメントには任意のNamespaceを設定できることが明記されていません。
<br>
<br>
しかし、AppProjectのCRDの<code>.spec.scope</code>キーからも分かる通り、AppProjectはNamespacedスコープなカスタムリソースであり、任意のNamespaceを設定できます👍

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  labels:
    app.kubernetes.io/name: appprojects.argoproj.io
    app.kubernetes.io/part-of: argocd
  name: appprojects.argoproj.io
spec:
  group: argoproj.io
  names:
    kind: AppProject

    ...

  # Namespacedスコープなカスタムリソースであるとわかる
  scope: Namespaced

...
```

<blockquote>
<ul>
  <li>[https://github.com/argoproj/argo-cd/blob/master/manifests/crds/appproject-crd.yaml:title]</li>
  <li>[https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/:title]</li>
</ul>
</blockquote>
</div>

<br>

# 05. CLモードなArgoCD

## CLモード vs. NSモード

ArgoCDには、[Clusterスコープモード](#CLモードなArgoCDとは) と [Namespacedスコープモード](#05-02-NSモードなArgoCD---) (以降、**"CLモード"** と **"NSモード"**) があります。

スコープモードに応じて、AppProjectテナントの設計方法が異なります。

本章では、CLモードとNSモードの両方でAppProjectテナントを解説していきます。

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

## CLモードなArgoCDとは

CLモードなArgoCDの場合、各テナント間で共有のArgoCDを管理します

例えば、AppProjectテナントとして、プロダクト別のNamespace (`foo`、`bar`、`baz`) とAppProject (`foo`、`bar`、`baz`) を用意します。

別途、ArgoCD専用のNamespace (`argocd`) を用意し、ここに関連するKubernetesリソース (例：ConfigMap) を配置します。

各プロダクトチームは、AppProjectテナント内のApplicationを操作し、正しいプロダクト用Clusterにマニフェストをデプロイします。

![argocd_multi-tenant_appproject_cluster-scope](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_cluster-scope.png)

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]
> - [https://medium.com/@geoffrey.muselli/argocd-multi-tenancy-strategy-94d72183c94:title]

<br>

## 実装方法

### AppProject

NSモードと同様にして、AppProjectに所属するApplicationによるマニフェストのデプロイを制限できます。

例えば、以下のような実装になります。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: foo-tenant
  namespace: foo
spec:
  destinations:
    # ArgoCD用Clusterに関する認可を設定する
    # App-Of-Appsパターンの場合に使用する
    - namespace: foo
      server: "https://kubernetes.default.svc"
    # プロダクト用Clusterに関する認可を設定する
    - namespace: "*"
      server: https://foo-cluster.gr7.ap-northeast-1.eks.amazonaws.com
  # CLモードでは設定が必要である
  sourceNamespaces:
    - foo
```

Applicationを操作するログインユーザーが、無認可のNamespaceやClusterをデプロイ先に指定できないように、`.spec.destination`キーで制限しています。

一方で後述のNSモードとは異なり、CLモードなArgoCDは任意のNamespaceのApplicationにアクセスできます。

そのため、`.spec.sourceNamespaces`キーで、特定のNamespaceのApplicationがこのAppProjectに所属できないように、ApplicationのNamespaceを制限しています。

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]
> - [https://argo-cd.readthedocs.io/en/stable/user-guide/projects/:title]

### ArgoCDコンポーネント用ConfigMap (`argocd-cmd-params-cm`)

NSモードと同様にして、`argocd-cmd-params-cm`では、ArgoCDの各コンポーネントのコンテナの引数を設定できます。

例えば、以下のような実装になります。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  # 専用のNamespaceを設定する
  namespace: argocd
data:
  # CLモードでは設定が必要である
  # 全てのNamespaceを指定したい場合は、ワイルドカードを設定する
  application.namespaces: "*"
```

`.application.namespaces`キーは、argocd-serverとapplication-controllerの`--application-namespaces`オプションに相当します。

一方での後述のNSモードとは異なり、CLモードなArgoCDは任意のNamespaceのApplicationにアクセスできます。

`--application-namespaces`オプションで、任意のNamespaceにアクセスするための認可を設定できます。

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

<div class="text-box">
<div class="text-box-title">▶ <code>--application-namespaces</code>オプションの設定方法について</div>
<br>
<code>argocd-cmd-params-cm</code>の代わりに、例えば以下のようにPodに引数を直接渡しても良いです🙆🏻‍
<br>
<br>
例えば、以下のような実装になります。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: argocd-server
  namespace: argocd
spec:
  containers:
    - name: argocd-server
      image: quay.io/argoproj/argocd:latest
      args:
        - /usr/local/bin/argocd-server
        # コンテナ起動時の引数として
        - --application-namespaces="*"

  ...
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: argocd-application-controller
  namespace: argocd
spec:
  containers:
    - name: argocd-application-controller
      image: quay.io/argoproj/argocd:latest
      args:
        - /usr/local/bin/argocd-application-controller
        # コンテナ起動時の引数として
        - --application-namespaces="*"

  ...
```

<blockquote>
<ul>
  <li>[https://argo-cd.readthedocs.io/en/stable/operator-manual/server-commands/argocd-application-controller/:title]</li>
  <li>[https://argo-cd.readthedocs.io/en/stable/operator-manual/server-commands/argocd-server/:title]</li>
</ul>
</blockquote>
</div>

### ログインユーザー用ConfigMap (`argocd-rbac-cm`)

NSモードと同様にして、`argocd-rbac-cm`では、Applicationを操作するログインユーザーが、無認可のAppProjectやNamespaceに所属するApplicationを操作できないように制限します。

例えば、以下のような実装になります。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  # 専用のNamespaceを設定する
  namespace: argocd
data:
  # デフォルトのロール
  # @see https://github.com/argoproj/argo-cd/blob/master/assets/builtin-policy.csv#L9-L16
  policy.default: role:readonly
  policy.csv: |
    p, role:foo, *, *, foo/*/*, allow
    p, role:bar, *, *, bar/*/*, allow
    p, role:baz, *, *, baz/*/*, allow

    g, foo-team, role:foo
    g, bar-team, role:bar
    g, baz-team, role:baz
  scopes: "[groups]"
```

認証済みグループ (foo-team、bar-team、baz-team) に対して、無認可のAppProject (`foo`、`bar`、`baz`) に所属するApplicationを操作できないように、認可スコープを制限しています。

<br>

<div class="text-box">
<div class="text-box-title">▶ AppProjectで設定できる認可について</div>
<br>
ConfigMap (argocd-rbac-cm) の認可スコープの定義には、 <a href="https://github.com/casbin/casbin">Casbin</a> の記法を使用します。
<br>
<br>
今回の実装例で使用した<code>p</code> (パーミッション) と<code>g</code> (グループ) では、以下を記法を使用できます👍

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  policy.default: role:readonly
  policy.csv: |
    # ロールとArgoCD系カスタムリソースの認可スコープを定義する
    p, role:<ロール名>, <Kubernetesリソースの種類>, <アクション名>, <AppProject名>/<ApplicationのNamespace名>/<Application名>, <許否>

    # 認証済みグループにロールを紐付ける
    g, <グループ名>, role:<ロール名>
  scopes: "[groups]"
```

<blockquote>
<ul><li>[https://argo-cd.readthedocs.io/en/stable/operator-manual/rbac/:title]</li></ul>
</blockquote>
</div>
<br>

<br>

## オススメしない理由

CLモードなArgoCDのAppProjectテナントには、以下のメリデメがあります。

デメリットの回避策も考慮して、独断と偏見でオススメしませんでした。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                  | デメリット **×**                                                                                                                                                                                                                |     | デメリットの回避策                                                                                                                                             |
| :---------------------------------: | -------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|               拡張性                | テナントを増やすためにNamespaceとAppProjectを用意するだけでよく、作業量が少ない。            | -                                                                                                                                                                                                                               | ➡︎ | -                                                                                                                                                              |
|      安全性<br>(セキュリティ)       | NetworkPolicyでNamespace間の名前解決を不可能にすれば、他のNamespaceからの通信を遮断できる。  | -                                                                                                                                                                                                                               | ➡︎ | -                                                                                                                                                              |
|               保守性                | ArgoCD用Clusterの管理者が単一のClusterを保守すればよい。(例：アップグレード、機能修正、など) | AppProjectはNamespacedスコープなカスタムリソースのため、ClusterスコープなKubernetesリソースを他のテナントと共有しないといけない。<br>そのため、ClusterスコープなKubernetesリソース (特にCRD) の変更は全てのテナントに影響する。 | ➡︎ | ArgoCDのアップグレード時 (CRDの変更時) は、ついでにKubernetesもアップグレードしたい。<br>新しいClusterを別に作成し、そこで新ArgoCDを作成すれば一石二鳥である。 |
|                性能                 | -                                                                                            | Clusterのハードウェアリソースを他のテナントと奪い合うことになる。                                                                                                                                                               | ➡︎ | 多くの利用者が同時並行的にArgoCDを操作する状況になりにくければ、奪い合いも起こらない。                                                                         |
|               信頼性                | -                                                                                            | ClusterまたはArgoCDで障害が起こると、これは全てのテナントに影響する。                                                                                                                                                           | ➡︎ | 代わりにNodeやArgoCDを十分に冗長化して可用性を高めれば、影響を緩和できる。<br>ただ、そもそもの影響範囲が大きすぎる😭                                           |

<br>

# 05-02. NSモードなArgoCD - ★★

## NSモードなArgoCDとは

NSモードなArgoCDの場合、前述のCLモードとは異なり、各AppProjectテナント間でArgoCDを占有します。

例えば、AppProjectテナントとして、プロダクト別のNamespace (`foo`、`bar`、`baz`) とAppProject (`foo`、`bar`、`baz`) を用意します。

各AppProjectテナントに、ArgoCDと関連するKubernetesリソース (例：ConfigMap) を配置します。

各プロダクトチームは、AppProjectテナント内のApplicationを操作し、正しいプロダクト用Clusterにマニフェストをデプロイします。

![argocd_multi-tenant_appproject_namespaced-scope](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope.png)

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

<br>

## 実装方法

### AppProject

CLモードと同様にして、AppProjectに所属するApplicationによるマニフェストのデプロイを制限できます。

例えば、以下のような実装になります。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: foo-tenant
  namespace: foo
spec:
  destinations:
    # ArgoCD用Clusterに関する認可を設定する
    # App-Of-Appsパターンの場合に使用する
    - namespace: foo
      server: "https://kubernetes.default.svc"
    # プロダクト用Clusterに関する認可を設定する
    - namespace: "*"
      server: https://foo-cluster.gr7.ap-northeast-1.eks.amazonaws.com
# NSモードでは設定が不要である
# sourceNamespaces:
#   - foo
```

Applicationを操作するログインユーザーが、無認可のNamespaceやClusterをデプロイ先に指定できないように、`.spec.destination`キーで制限しています。

前述のCLモードとは異なり、NSモードなArgoCDは自身が所属するNamespaceのApplicationのみにアクセスできます。

そのため、`.spec.sourceNamespaces`キーでマニフェストのデプロイを制限する必要はありません。

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]
> - [https://argo-cd.readthedocs.io/en/stable/user-guide/projects/:title]

### ArgoCDコンポーネント用ConfigMap (`argocd-cmd-params-cm`)

CLモードと同様にして、`argocd-cmd-params-cm`では、ArgoCDの各コンポーネントのコンテナの引数を設定できます。

例えば、以下のような実装になります。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: foo
data:
# NSモードでは設定が不要である
# application.namespaces: "*"
```

前述の通り、`.application.namespaces`キーは、argocd-serverとapplication-controllerの`--application-namespaces`オプションに相当します。

前述のCLモードとは異なり、NSモードなArgoCDは自身が所属するNamespaceのApplicationのみにアクセスできます

そのため、`.application.namespaces`キーでNamespaceに関する認可を設定する必要はありません

もちろん、Podのコンテナ引数にも設定は不要です。

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

### ログインユーザー用ConfigMap (`argocd-rbac-cm`)

CLモードと同様にして、`argocd-rbac-cm`では、Applicationを操作するログインユーザーが、無認可のAppProjectやNamespaceに所属するApplicationを操作できないように制限します。

例えば、以下のような実装になります。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: foo
data:
  # デフォルトのロール
  # @see https://github.com/argoproj/argo-cd/blob/master/assets/builtin-policy.csv#L9-L16
  policy.default: role:readonly
  policy.csv: |
    p, role:app, *, *, app/*/*, allow
    p, role:infra, *, *, infra/*/*, allow

    g, app-team, role:app
    g, infra-team, role:infra
  scopes: "[groups]"
```

認証済みグループ (app-team、infra-team) に対して、無認可のAppProject (`app`、`infra`) に所属するApplicationを操作できないように、認可スコープを制限しています。

<br>

## 特にオススメした理由

NSモードなArgoCDのAppProjectテナントには、以下のメリデメがあります。

デメリットの回避策も考慮して、独断と偏見で **<font color="#FF0000">特にオススメ</font>** しました。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                 | デメリット **×**                                                                                                                                                                                                                |     | デメリットの回避策                                                                                                                                             |
| :---------------------------------: | ------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|               拡張性                | テナントを増やすためにNamespaceとAppProjectを用意するだけでよく、作業量が少ない。           | -                                                                                                                                                                                                                               | ➡︎ | -                                                                                                                                                              |
|      安全性<br>(セキュリティ)       | NetworkPolicyでNamespace間の名前解決を不可能にすれば、他のNamespaceからの通信を遮断できる。 | -                                                                                                                                                                                                                               | ➡︎ | -                                                                                                                                                              |
|               保守性                | 単一のClusterを保守すればよい。<nobr>(例：アップグレード、機能修正、など)</nobr>            | AppProjectはNamespacedスコープなカスタムリソースのため、ClusterスコープなKubernetesリソースを他のテナントと共有しないといけない。<br>そのため、ClusterスコープなKubernetesリソース (特にCRD) の変更は全てのテナントに影響する。 | ➡︎ | ArgoCDのアップグレード時 (CRDの変更時) は、ついでにKubernetesもアップグレードしたい。<br>新しいClusterを別に作成し、そこで新ArgoCDを作成すれば一石二鳥である。 |
|                性能                 | -                                                                                           | Clusterのハードウェアリソースを他のテナントと奪い合うことになる。                                                                                                                                                               | ➡︎ | 多くの利用者が同時並行的にArgoCDを操作する状況になりにくければ、奪い合いも起こらない。                                                                         |
|               信頼性                | テナントごとにArgoCDを占有しており、他のArgoCDから障害の影響を受けない。                    | Clusterで障害が起こると、これは全てのテナントに影響する。                                                                                                                                                                       | ➡︎ | 代わりに、Nodeを十分に冗長化して可用性を高める。<br>いずれかのインスタンスで障害が起こっても、正常なインスタンスでArgoCDが稼働できる。                         |

<br>

## AppProjectテナント例の一覧

NSモードなArgoCDを採用する場合、AppProjectテナント例を解説していきます。

前述の通り、AppProjectテナントが二重テナント (第一テナントにNamespace、第二テナントに複数のAppProject) を持つことに留意してください。

なお、オススメするものを ★ としています。

<table>
  <thead>
  <tr>
    <th rowspan="2" style="text-align: center;"></th>
    <th colspan="2" style="text-align: center;">テナント例<br>(二重テナント)</th>
    <th rowspan="2" style="text-align: center;">オススメ</th>
  </tr>
  <tr>
    <th style="text-align: center;">Namespace<br>(第一テナント)</th>
    <th style="text-align: center;">AppProject<br>(第二テナント)</th>
  </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center;"><a href="#テナント例1">テナント例1</a></td>
      <td style="text-align: center;">プロダクトの実行環境別</td>
      <td style="text-align: center;">プロダクトの実行環境別</td>
      <td style="text-align: center;"></td>
    </tr>
    <tr>
      <td style="text-align: center;"><a href="#テナント例2--">テナント例2</a></td>
      <td style="text-align: center;">プロダクト別</td>
      <td style="text-align: center;">プロダクトの実行環境別</td>
      <td style="text-align: center;">★</td>
    </tr>
    <tr>
      <td style="text-align: center;"><a href="#テナント例3---">テナント例3</a></td>
      <td style="text-align: center;">プロダクト別</td>
      <td style="text-align: center;">プロダクトのサブチーム別</td>
      <td style="text-align: center;">★★</td>
    </tr>
  </tbody>
</table>

<br>

<div class="text-box">
<div class="text-box-title">▶ Namespaceの分割パターンについて</div>
<br>
本記事では言及しませんが、Namespaceにはいくつかの分割パターンがあり、本記事ではこれも取り入れてAppProjectテナントを設計しています。
<br>
<br>
例えば、<b>"管理チーム別"</b> (今回でいうプロダクト別) というNamespaceの分割パターンは、様々な著名な書籍やブログで紹介されています👀
<blockquote>
<ul>
  <li>[https://www.amazon.co.jp/dp/1617293725:title]</li>
  <li>[https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-organizing-with-namespaces?hl=en:title]</li>
</ul>
</blockquote>
</div>

<br>

## テナント例1

### Namespace (プロダクトの実行環境別)、AppProject (プロダクトの実行環境別)

プロダクトの実行環境 (Dev環境、Tes環境) 別に管理されたClusterがいる状況と仮定します。

この場合に、プロダクトの実行環境別にNamespace (`dev`、`tes`) とAppProject (`dev`、`tes`) を用意します。

![argocd_multi-tenant_appproject_namespaced-scope_pattern_1](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_pattern_1.png)

### オススメしなかった理由

テナント例1には、以下のメリデメがあります。

独断と偏見でオススメしませんでした。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                                                    | デメリット **×**                                                                                                                             |     | デメリットの回避策                                                                        |
| :---------------------------------: | ---------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------- | --- | ----------------------------------------------------------------------------------------- |
|               拡張性                | -                                                                                                                                              | ArgoCDのPod数が多くなり、将来的にNode当たりのPodやIPアドレスの上限数にひっかかりやすい。<br>その時点で、AppProjectテナントの増やせなくなる。 | ➡︎ | 例えばAWS EKSの場合、Node数を増やしたり、Nodeのスペックを上げる。<br>ただ、お金がかかる😭 |
|      安全性<br>(セキュリティ)       | ログインユーザー用ConfigMap (`argocd-rbac-cm`) を使用すれば、無認可の実行環境別AppProjectに所属するApplicationを操作できないように制限できる。 | -                                                                                                                                            | ➡︎ | -                                                                                         |
|               保守性                | 異なる実行環境に関するApplicationが共存しておらず、別のargocd-serverから操作することになるため、実行環境間の選択ミスが起こりにくい。           | -                                                                                                                                            | ➡︎ | -                                                                                         |

<br>

## テナント例2 - ★

### Namespace (プロダクト別)、AppProject (プロダクトの実行環境別)

プロダクトの実行環境 (Dev環境、Tes環境) 別に管理されたClusterがいる状況と仮定します。

プロダクト別にNamespace (`foo`、`bar`) 、プロダクトの実行環境別にAppProject (`dev`、`tes`) を用意します。

![argocd_multi-tenant_appproject_namespaced-scope_pattern_2](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_pattern_2.png)

### オススメした理由

テナント例2には、以下のメリデメがあります。

独断と偏見で **<font color="#FF0000">オススメ</font>** しました。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                               | デメリット **×**                                                                                                                                     |     | デメリットの回避策                                                                  |
| :---------------------------------: | ------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | --- | ----------------------------------------------------------------------------------- |
|               拡張性                | ArgoCDのPod数が多くなり、将来的にNode当たりのPodやIPアドレスの上限数にひっかかりにくい。                                  | -                                                                                                                                                    | ➡︎ | -                                                                                   |
|      安全性<br>(セキュリティ)       | ログインユーザー用ConfigMap (`argocd-rbac-cm`) を使用すれば、無認可の実行環境別AppProjectを操作できないように制限できる。 | -                                                                                                                                                    | ➡︎ | -                                                                                   |
|               保守性                | -                                                                                                                         | 異なる実行環境に関するApplicationが共存しており、同じargocd-server (ダッシュボード) から操作することになるため、実行環境間の選択ミスが起こりやすい。 | ➡︎ | ダッシュボードにはApplicationのフィルタリング機能があるため、選択ミスを回避できる。 |

<br>

## テナント例3 - ★★

### Namespace (プロダクト別)、AppProject (プロダクトのサブチーム別)

プロダクトの実行環境 (Dev環境、Tes環境) 別に管理されたClusterがいる状況と仮定します。

プロダクト別にNamespace (`foo`、`bar`) 、プロダクトのサブチーム別にAppProject (`app`、`infra`) を用意します。

![argocd_multi-tenant_appproject_namespaced-scope_pattern_3](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_pattern_3.png)

### 特にオススメした理由

テナント例3には、以下のメリデメがあります。

独断と偏見で **<font color="#FF0000">特にオススメ</font>** しました。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                                                      | デメリット **×**                                                                                                                                     |     | デメリットの回避策                                                                  |
| :---------------------------------: | ------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------- | --- | ----------------------------------------------------------------------------------- |
|               拡張性                | ArgoCDのPod数が多くなり、将来的にNode当たりのPodやIPアドレスの上限数にひっかかりにくい。                                                         | -                                                                                                                                                    | ➡︎ | -                                                                                   |
|      安全性<br>(セキュリティ)       | ログインユーザー用ConfigMap (`argocd-rbac-cm`) を使用すれば、無認可のサブチーム別AppProjectに所属するApplicationを操作できないように制限できる。 | -                                                                                                                                                    | ➡︎ | -                                                                                   |
|               保守性                | -                                                                                                                                                | 異なる実行環境に関するApplicationが共存しており、同じargocd-server (ダッシュボード) から操作することになるため、実行環境間の選択ミスが起こりやすい。 | ➡︎ | ダッシュボードにはApplicationのフィルタリング機能があるため、選択ミスを回避できる。 |

<br>

# 06. どのような誤った操作を防いでくれるのか

そろそろ解説を読むのがしんどい方がいるのではないでしょうか。

『君がッ、泣くまで、解説をやめないッ！』

AppProjectテナントとNamespacedスコープモードがマニフェストのデプロイをどのように制限するのかについて、例を挙げて解説します。

ここでは、以下のAppProjectを作成したと仮定します。

AppProjectテナントが二重テナント (第一テナントにNamespace、第二テナントに複数のAppProject) を持つことに留意してください。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  # appチーム
  name: app
  namespace: foo
spec:
  destinations:
    # ArgoCD用Clusterに関する認可を設定する
    # Namespace (foo) へのデプロイを許可する
    - namespace: foo
      server: "https://kubernetes.default.svc"
      # プロダクト用Clusterに関する認可を設定する
      # Namespace (app) へのデプロイを許可する
    - namespace: app
      server: https://foo-cluster.gr7.ap-northeast-1.eks.amazonaws.com
```

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  # infraチーム
  name: infra
  namespace: foo
spec:
  destinations:
    # ArgoCD用Clusterに関する認可を設定する
    # Namespace (foo) へのデプロイを許可する
    - namespace: foo
      server: "https://kubernetes.default.svc"
    # プロダクト用Clusterに関する認可を設定する
    # Namespace (infra) へのデプロイを許可する
    - namespace: infra
      server: https://foo-cluster.gr7.ap-northeast-1.eks.amazonaws.com
```

<br>

## マニフェストのデプロイ制限

プロダクトの実行環境 (Dev環境、Tes環境) 別に管理されたClusterがいる状況と仮定します。

プロダクト別にNamespace (`foo`) 、プロダクトのサブチーム別にAppProject (`app`、`infra`) を用意します。

AppProjectテナントは、例えば **<font color="#FF0000">赤線</font>** の方法で、マニフェストのデプロイを制限します。

![argocd_multi-tenant_appproject_namespaced-scope_restrict-manifest-deploy](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_restrict-manifest-deploy.png)

### マニフェストをデプロイできる場合

マニフェストを正しくデプロイする場合、AppProjectテナントはこれを制限しません。

(1) argocd-serverは、`argocd-cmd-params-cm`からアクセスできるNamespaceを取得します。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: foo
data:
# 設定しないことで、argocd-serverは同じNamespaceにしかアクセスできなくなる。
# application.namespaces: "*"
```

(2) fooプロダクトのinfraチームが、argocd-serverを操作します。

(3) argocd-serverは、`argocd-rbac-cm`からApplication操作に関する認可スコープを取得します

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: foo
data:
  policy.default: role:readonly
  policy.csv: |
    p, role:app, *, *, app/*/*, allow
    p, role:infra, *, *, infra/*/*, allow

    g, app-team, role:app
    g, infra-team, role:infra
  scopes: "[groups]"
```

(4) infraチームは、認可されたAppProjectに所属するApplicationを操作します。

(5) infraチームは、Dev環境のfooプロダクト用ClusterのNamespace (`infra`) にマニフェストをデプロイできます。

### (🚫制限例1) 無認可のNamespaceでApplicationを作成しようとした場合

例えば、fooプロダクトのinfraチームが無認可のNamespace (`bar`) でApplicationを作成しようとします。

すると、argocd-serverは以下のようなエラーを返却し、この操作を制限します。

```sh
namespace bar is not permitted in project 'infra-team'
```

無認可のNamespaceでApplicationを作れてしまうと、そのApplicationから無認可のプロダクト用Clusterにマニフェストをデプロイできてしまいます😈

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/test/e2e/app_management_ns_test.go#L2465-L2484:title]

### (🚫制限例2) 無認可のAppProjectでApplicationを作成しようとした場合

例えば、fooプロダクトのinfraチームが、無認可のAppProject (`app`) でApplicationを作成しようとします。

すると、argocd-serverは以下のようなエラーを返却し、この操作を制限します。

```sh
Application referencing project 'app' which does not exist
```

任意のAppProjectでApplicationを作成できてしまうと、そのApplicationから無認可のプロダクト用Clusterにマニフェストをデプロイできてしまいます😈

### (🚫制限例3) 無認可のClusterをデプロイ先に指定しようとした場合

例えば、fooプロダクトのinfraチームがApplicationを操作し、無認可のプロダクト用Cluster (`bar-cluster`) をデプロイ先として指定しようします。

すると、argocd-serverは以下のようなエラーを返却し、この操作を制限します。

```sh
application destination
{https://bar-cluster.gr7.ap-northeast-1.eks.amazonaws.com infra} is not permitted in project 'infra-team'
```

任意のClusterをデプロイ先に指定できてしまうと、Applicationから無認可のプロダクト用Clusterにマニフェストをデプロイできてしまいます😈

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/util/argo/argo_test.go#L679-L710:title]

### (🚫制限例4) 無認可のNamespaceをデプロイ先に指定しようとした場合

例えば、fooプロダクトのinfraチームがApplicationを操作し、無認可のNamespace (`app`) をデプロイ先に指定しようします。

すると、argocd-serverは以下のようなエラーを返却し、この操作を制限します。

```sh
application destination
{https://foo-cluster.gr7.ap-northeast-1.eks.amazonaws.com app} is not permitted in project 'infra-team'
```

任意のNamespaceをデプロイ先に指定できてしまうと、そのApplicationから無認可のNamespaceにマニフェストをデプロイできてしまいます😈

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/util/argo/argo_test.go#L679-L710:title]

<br>

<div class="text-box">
<div class="text-box-title">▶ AppProjectで設定できる認可について</div>
<br>
AppProjectテナントは、その他にも以下のような認可を設定できます。
<br>
<br>
<ul>
  <li>argocd-serverとapplication-controllerでデプロイできるKubernetesリソースの種類 (<code>.spec.clusterResourceWhitelist</code>キー、<code>.spec.namespaceResourceWhitelist</code>キー、など)</li>
  <li>repo-serverでポーリングできるリポジトリ (<code>.spec.sourceRepos</code>キー)</li>
</ul>

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: foo-tenant
  namespace: foo
spec:
  clusterResourceWhitelist:
    - group: "*"
      kind: "*"
  namespaceResourceWhitelist:
    - group: "*"
      kind: "*"
  sourceRepos:
    - "*"

  ...
```

<br>
<b>"AppProjectテナントによるマニフェストのデプロイ丸ごとの制限"</b> という観点でテーマが異なるため、本記事では言及しませんでした🙇🏻‍

<blockquote>
<ul>
  <li>[https://argo-cd.readthedocs.io/en/stable/user-guide/projects/:title]</li>
  <li>[https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/#projects:title]</li>
</ul>
</blockquote>
</div>

<br>

## カスタムリソースのReconciliation制限

プロダクトの実行環境 (Dev環境、Tes環境) 別に管理されたClusterがいる状況と仮定します。

プロダクト別にNamespace (`foo`) 、プロダクトのサブチーム別にAppProject (`app`、`infra`) を用意します。

AppProjectテナントは、例えば **<font color="#FF0000">赤線</font>** の方法で、ArgoCD系カスタムリソースに対するapplication-controllerのReconciliationを制限します。

![argocd_multi-tenant_appproject_namespaced-scope_restrict-reconciliation](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_restrict-reconciliation.png)

### ArgoCD系カスタムリソースをReconciliationできる場合

正しいNamespaceに対してReconciliationを実行する場合、AppProjectテナントはこれを制限しません。

(1) application-controllerは、`argocd-cmd-params-cm`から自身がアクセスできるNamespaceを取得します。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: foo
data:
# 設定しないことで、application-controllerは同じNamespaceにしかアクセスできなくなる。
# application.namespaces: "*"
```

(2) application-controllerは、同じNamespaceに所属するArgoCD系カスタムリソースに対して、Reconciliationを実行します。

### (🚫制限例1) 無認可のNamespaceにReconciliationを実行しようとした場合

例えば、application-controllerがReconciliationの対象とするNamespaceを選ぼうとしているとします。

すると、application-controllerは内部で検証メソッドを実行し、無認可のNamespace (`bar`) は選ばないようにします。

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/controller/appcontroller_test.go#L1517-L1543:title]

<br>

# 07. おわりに

KubernetesのマルチテナントパターンとArgoCDでのパターン実践をもりもり布教しました。

あらゆる面からマニフェストのデプロイを制限してくれる、AppProjectテナントの素晴らしさが伝わりましたでしょうか。

KubernetesのマルチテナントパターンをArgoCDでどう実践するべきか、について困っている方の助けになれば幸いです👍

<br>

# 謝辞

本記事のタイトルは、私が崇拝しているドメイン駆動設計の書籍 **"[isbn:479813161X:title]"** から拝借しました🙏

また、ArgoCDでのパターン実践の収集にあたり、以下の方からの意見も参考にさせていただきました。

- [`@toversus26`](https://twitter.com/toversus26) さん

この場で感謝申し上げます🙇🏻‍

<br>

# 記事関連のおすすめ書籍

[asin:B0BQL1CBPX:detail]

[isbn:1617297275:detail]

<br>
