---
Title: 【ArgoCD🐙️】KubernetesのマルチテナントパターンとArgoCDの実践テナント設計
Category:
  - ArgoCD
  - Kubernetes
  - ソフトウェアアーキテクチャ
Date: 2023-07-08T22:25:34+09:00
URL: https://hiroki-hasegawa.hatenablog.jp/entry/2023/07/08/222534
EditURL: https://blog.hatena.ne.jp/hiroki-hasegawa/hiroki-hasegawa.hatenablog.jp/atom/entry/820878482948228657
Draft: true
---

<br>

[:contents]

<br>

# この記事から得られる知識

この記事を読むと、以下を "完全に理解" できます✌️

- Kubernetesのマルチテナントパターンの種類
- マルチテナントパターンをArgoCDで実践した場合に適するテナント
- ArgoCDのNamespacedスコープモードとClusterスコープモード

<br>

# 01. はじめに

<br>

<figure><img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_community-board.png" alt="argocd_community-board"><figcaption>画像引用元：<a href="https://github.com/argoproj">Argo Project</a></figcaption></figure>

<br>

Argoくんへの愛ゆえに思います。

3DのArgoくん...キモいな...

さて最近の業務で、全プロダクトの技術基盤開発チームに携わっており、全プロダクト共有のArgoCD🐙のApplicationのマルチテナント化を担当しました。

本記事は、以下の3つの章構成からなります。

- Kubernetesのマルチテナントパターン (3章まで)
- ArgoCDでのテナント設計の実践 (4章以降)
- 各テナント内での認可処理の仕組み (4章以降)

情報量がエグいことになってしまったので、いずれか構成だけでも拾って帰っていただけると嬉しいです🙏

それでは、もりもり布教していきます😗

<div class="text-box">
記事中のこのボックスは、補足情報を記載しています。
<br>
<br>
飛ばしていただいても大丈夫ですが、読んでもらえるとより理解が深まるはずです👍
</div>

<br>

# 02. なぜApplicationにマルチテナントが必要なのか

## シングルテナントの場合

そもそも、なぜArgoCDのApplicationにマルチテナントが必要なのでしょうか。

例えば、ArgoCDによるデプロイ先となっているプロダクト用Clusterがいくつかあると仮定します。

単一のテナント内に各プロダクト用のApplicationを共存させると、単一のArgoCDダッシュボードから全てのApplicationを操作できて便利です。

ただし、プロダクト用Cluster数が増えていくにつれて、問題が起こり始めます。

ヒューマンエラー (例：異なるApplicationを選んでしまう) により、各プロダクトチームが誤ったプロダクト用Clusterにデプロイしてしまう可能性があります。

![argocd_single-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_single-tenant.png)

<br>

## マルチテナントの場合

一方で、いい感じのマルチテナントにしたとします。

プロダクトチームは、テナント内の適切なApplicationを選べるようになります。

また認可の仕組みにより、許可されていないApplicationからのデプロイを防ぐことができます。

![argocd_multi-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant.png)

<br>

# 03. Kubernetesにおけるマルチテナントパターン

## 概要

まず最初に、Kubernetesのマルチテナントパターンを整理しておきます。

マルチテナントパターンは大きく、以下に大別できます。

<table>
   <thead>
      <tr>
         <th rowspan="2" style="text-align: center;">マルチテナント<br>パターン名</th>
         <th rowspan="2" style="text-align: center;"><nobr>テナントの単位</nobr></th>
         <th colspan="2" style="text-align: center;"><nobr>テナント間のArgoCD関連リソース分離</nobr><br>(分離できていれば <code>⭕️</code> )</th>
         <th rowspan="2" >ツール<br>(アルファベット順)</th>
      </tr>
      <tr>
          <th style="text-align: center;"><nobr>Namespacedスコープ</nobr><br>リソース</th>
          <th style="text-align: center;"><nobr>Clusterスコープ</nobr><br>リソース</th>
      </tr>
   </thead>
   <tbody>
      <tr>
         <td style="text-align: center;">Clusters<br>as a Service</td>
         <td style="text-align: center;">実Cluster<br>テナント</td>
         <td style="text-align: center;"><code>⭕️</code></td>
         <td style="text-align: center;"><code>⭕️</code></td>
         <td>Clusterを増やすだけなのでツール不要</td>
      </tr>
      <tr>
         <td style="text-align: center;">Control-planes<br>as a Service</td>
         <td style="text-align: center;">仮想Cluster<br>テナント</td>
         <td style="text-align: center;"><code>⭕️</code></td>
         <td style="text-align: center;"><code>⭕️</code></td>
         <td><a href="https://github.com/kcp-dev/kcp">Kcp</a>、<a href="https://github.com/virtual-kubelet/tensile-kube">tensile-kube</a>、<a href="https://github.com/loft-sh/vcluster">vcluster</a>、<a href="https://github.com/kubernetes-sigs/cluster-api-provider-nested/tree/main/virtualcluster">VirtualCluster</a>、など</td>
      </tr>
      <tr>
         <td style="text-align: center;">Namespaces<br>as a Service</td>
         <td style="text-align: center;">Namespace<br>テナント</td>
         <td style="text-align: center;"><code>⭕️</code></td>
         <td></td>
         <td>Namespaceを増やすだけなのでツール不要</td>
      </tr>
      <tr>
         <td style="text-align: center;">各種ツール<br>独自テナント</td>
         <td style="text-align: center;">カスタムリソース<br>テナント</td>
         <td style="text-align: center;">ツールによる</td>
         <td style="text-align: center;">ツールによる</td>
         <td><a href="https://argo-cd.readthedocs.io/en/stable/user-guide/projects/">ArgoCDのAppProject</a>、<a href="https://github.com/clastix/capsule">Capsule</a>、<a href="https://github.com/loft-sh/kiosk">kiosk</a>、<a href="https://github.com/kubewharf/kubezoo">KubeZoo</a>、など</td>
      </tr>
   </tbody>
</table>

<div class="text-box">
本記事では言及しませんが、『ソフトマルチテナンシー』と『ハードマルチテナンシー』といった分類方法もあります。
<br>
<br>
この分類方法では、テナント間の分離度の観点で各マルチテナントを種別します。
<br>
<br>
ソフトマルチテナンシーは、互いに信頼できる前提の上で、テナント間を弱く分離します。
<br>
<br>
一方で、ハードマルチテナンシーは、互いに信頼できない前提の上でテナント間を強く分離します。
<br>
<br>
分離度がソフトとハードのいずれであるかに客観的な指標がなく、やや曖昧な種別になってしまうため、本記事の分類方法の方が個人的には好みです♡
<br>
<br>
<blockquote>
<ul>
<li>[asin:B072TS9ZQZ:title]</li>
<li>[https://kubernetes.io/docs/concepts/security/multi-tenancy/#isolation:title]</li>
<li>[https://aws.github.io/aws-eks-best-practices/security/docs/multitenancy/:title]</li>
</ul>
</blockquote>
</div>

<br>

## Clusters as-a-Service

### Clusters as-a-Serviceとは

テナントごとに、独立したClusterを提供します。

![argocd_multi-tenant_k8s_clusters-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_clusters-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

### メリデメ

実Clusterテナントには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット                                                                   | デメリット                                                                                 |
| :---------------------------------: | -------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------ |
|               拡張性                | 他のテナントとClusterスコープなKubernetesリソース (特にCRD) を分離できる。 | 他ー                                                                                       |
|               安全性                | 他のテナントとは通信を分離できる。                                         | -                                                                                          |
|               保守性                | -                                                                          | 各Clusterを継続的に保守しないといけない。<nobr>(例：アップグレード、機能修正、など)</nobr> |
|                性能                 | 他のテナントとはClusterのハードウェアリソースを分離できる。                | -                                                                                          |

<br>

## Control-planes as-a-Service

### Control-planes as-a-Serviceとは

テナントごとに、独立したコントロールプレーンを提供します。

![argocd_multi-tenant_k8s_control-planes-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_control-planes-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

### メリデメ

仮想Clusterテナントには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット                                                                   | デメリット                                                                                   |
| :---------------------------------: | -------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- |
|               拡張性                | 他のテナントとClusterスコープなKubernetesリソース (特にCRD) を分離できる。 | -                                                                                            |
|               安全性                | -                                                                          | 他のテナントとは通信を分離できない。                                                         |
|               保守性                | -                                                                          | 各仮想Clusterを継続的に保守しないといけない<nobr>(例：アップグレード、機能修正、など)</nobr> |
|                性能                 | -                                                                          | 他のテナントとClusterのハードウェアリソースを他と共有しないといけない。                      |

<br>

## Namespaces as-a-Service

### Namespaces as-a-Serviceとは

テナントごとに、独立したNamespaceを提供します。

![argocd_multi-tenant_k8s_namespaces-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_namespaces-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

### メリデメ

Namespaceテナントには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット                                                                                     | デメリット                                                                                                                                       |
| :---------------------------------: | -------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
|               拡張性                | -                                                                                            | 他のテナントとClusterスコープなKubernetesリソース (特にCRD) を共有しないといけない。共有するKubernetesリソースの変更は全てのテナントに影響する。 |
|               安全性                | -                                                                                            | -                                                                                                                                                |
|               保守性                | 各仮想Clusterを継続的に保守しなくてもよい。<nobr>(例：アップグレード、機能修正、など)</nobr> | -                                                                                                                                                |
|                性能                 | -                                                                                            | 他のテナントとClusterのハードウェアリソースを他と共有しないといけない。                                                                          |

<br>

## 独自テナント

AppProjectテナントには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット | デメリット |
| :---------------------------------: | -------- | ---------- |
|               安全性                | -        | -          |
|               保守性                | -        | -          |
|                性能                 | -        | -          |

<br>

# 04. ArgoCDでのテナント設計の実践

## 概要

お待たせしました。

ここからは、KubernetesのマルチテナントをArgoCDで実践していきます。

私が候補として考えたものはの通りです。

<table>
  <thead>
    <tr>
      <th rowspan="2" style="text-align: center;">マルチテナント<br>パターン名</th>
      <th rowspan="2" style="text-align: center;">テナントの実装</th>
      <th rowspan="2" style="text-align: center;">Cluster上ArgoCD<br><nobr>単一 or 複数</nobr></th>
      <th colspan="2" style="text-align: center;"><nobr>テナント間のArgoCD関連リソース分離</nobr><br>(分離できていれば <code>⭕️</code> )</th>
      <th rowspan="2" style="text-align: center;"><nobr>おすすめ</nobr></th>
    </tr>
    <tr>
      <th rowspan="2" style="text-align: center;"><nobr>Namespacedスコープ</nobr><br>リソース<br></th>
      <th rowspan="2" style="text-align: center;"><nobr>Clusterスコープ</nobr><br>リソース</th>
    </tr>
  </thead>
  <tbody style="text-align: center;">
    <tr>
      <td>Clusters<br>as-a-Service</td>
      <td>実Cluster</td>
      <td>単一</td>
      <td><code>⭕️</code></td>
      <td><code>⭕️</code></td>
      <td></td>
    </tr>
    <tr>
      <td>Control-planes<br>as-a-Service</td>
      <td>プロダクト共有Cluster上<br>仮想Cluster</td>
      <td>複数</td>
      <td><code>⭕️</code></td>
      <td><code>⭕️</code></td>
      <td></td>
    </tr>
    <tr>
      <td>Namespaces<br>as-a-Service</td>
      <td>Namespace<br>テナント</td>
      <td>複数</td>
      <td><code>⭕️</code></td>
      <td></td>
      <td>✅</td>
    </tr>
    <tr>
      <td>各種ツール<br>独自テナント</td>
      <td>AppProject<br>テナント</td>
      <td>単一</td>
      <td><code>⭕️</code><br></td>
      <td></td>
      <td>✅</td>
    </tr>
  </tbody>
</table>

<br>

## 凡例

図の中で使用している凡例の説明です。

ArgoCDの各コンポーネント (repo-server、application-controler) と各リソース (Application、AppProject) を区別しています。

![argocd_multi-tenant_legend](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_legend.png)

<br>

# 04-02. 実Clusterテナントの場合

## 実Clusterテナントとは

後述の仮想Clusterと対比させるために、『実Cluster』と呼ぶことにします。

実Clusterテナントでは、デプロイ先のプロダクト用Clusterごとに実Clusterを作成します。

この時の実Clusterをテナントの単位とします。

![argocd_multi-tenant_physical_cluster](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_physical_cluster.png)

<br>

## おすすめしなかった理由

実Clusterテナント間では、各実Cluster上のKubernetesリソースを全く共有しません。

つまり、これはArgoCDの各コンポーネントとApplicationの両方を分離します。

そのため、ClusterスコープなKubernetesリソース (例：ArgoCDの各コンポーネントを動かすDeployment) やArgoCD系カスタムリソース (例：Application、AppProject) 間を完全に分離でき、各ArgoCDは対応するプロダクトのみにデプロイの責務を持つことになります。

一番の致命的なデメリットがCluster数がむやみに増えることであり、運用保守が "とてもつらい" ため、おすすめしませんでした。

<blockquote class="twitter-tweet tw-align-center" data-width="300"><p lang="ja" dir="ltr">半年以内にアップグレードしないとサポートが切れるKubernetesクラスターが33個もあって、泣いちゃった</p>&mdash; 長谷川 広樹 (俺です) (@Hiroki__IT) <a href="https://twitter.com/Hiroki__IT/status/1615710926489124865?ref_src=twsrc%5Etfw">January 18, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<br>

# 04-03. 仮想Clusterテナントの場合

## 仮想Clusterテナントとは

仮想Clusterテナントでは、テナントごとに仮想Clusterを作成します。

具体的には、プロダクト共有Cluster上に仮想Clusterを作成し、各仮想Cluster上でArgoCDを動かします。

![argocd_multi-tenant_virtual_cluster](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_virtual_cluster.png)

> - [https://blog.argoproj.io/using-argo-cd-with-vclusters-5df53d1c51ce:title]

<br>

## おすすめしなかった理由

仮想Clusterテナント間では、ホストClusterのKubernetesリソースを共有しますが、各仮想Cluster上のそれは共有しません。

つまり、これはArgoCDの各コンポーネントとApplicationの両方を分離します。

そのため、実Clusterテナントのよいところ (ClusterスコープなKubernetesリソースの分離) を享受しつつ、また実Clusterが増えなくてよいです。

しかし、仮想Cluster自体が増えてしまうことと、技術的に発展途上で運用保守の難易度が高くなってしまいます。

そのため、おすすめしませんでした。

<br>

# 04-04. Namespaceテナントの場合

## Namespaceテナントとは

<br>


# 04-05. AppProjectテナントの場合

## AppProjectテナントとは

仮想Clusterテナントでは、テナントごとにAppProjectを作成します。

AppProject自体がNamespacedスコープなカスタムリソースのため、**<font color="#FF0000">AppProjectはNamespaceテナントを兼ねるテナントパターン</font>**です。

ArgoCDの各コンポーネント (repo-server、application-controler) には、NamespacedスコープモードとClusterスコープモードがあります。

<br>

# 05. NamespacedスコープモードArgoCD

## NamespacedスコープモードArgoCDとは

NamespacedスコープモードArgoCDでは、各テナントで独立したArgoCDを管理します。

<br>

## これの場合のAppProjectテナント

Namespacedスコープモードの場合、AppProjectテナントではテナントごとにNamespaceとAppProjectを作成します。

例えば、プロダクト共有Cluster上に、プロダクト別のNamespaceと実行環境別のAppProjectを作成します。

この時、もう一方のClusterスコープとは異なり、各テナント間で独立したArgoCDがCluster上にいます。

![argocd_multi-tenant_appproject_namespaced-scope](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope.png)

<br>

## おすすめした理由!!

Namespaceテナント間では、(例：ArgoCDの各コンポーネントを動かすDeployment) やArgoCD系カスタムリソース (例：Application、AppProject) を共有しますが、Applicationは共有しません。

そのため、実Clusterテナントのメリットを享受しつつ、また実Clusterが増えなくてよいです。

前述の通り、私の状況ではArgoCDでデプロイしなければならないプロダクトの数が非常に多く、各ArgoCDの影響範囲がプロダクトに限定できます。

そのため、**<font color="#FF0000">おすすめになりました</font>**。

<br>

# 05-02. ClusterスコープモードArgoCD

## ClusterスコープモードArgoCDとは

ClusterスコープモードArgoCDでは、各テナントで同じArgoCDを管理します。

## これの場合のAppProjectテナント

Clusterスコープモードの場合、AppProjectテナントではテナントごとにNamespaceとAppProjectを作成します。

例えば、プロダクト共有Cluster上に、プロダクト別のNamespaceと実行環境別のAppProjectを作成します。

この時、もう一方のNamespacedスコープとは異なり、各テナント間で共有されたArgoCDがCluster上にいます。

![argocd_multi-tenant_appproject_cluster-scope](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_cluster-scope.png)

<br>

## おすすめしなかった理由

AppProjectテナント間では、(例：ArgoCDの各コンポーネントを動かすDeployment) を共有しますが、ArgoCD系カスタムリソース (例：Application、AppProject) は共有しません。

そのため、実Clusterテナントのよいところ (ClusterスコープなKubernetesリソースの分離) を享受しつつ、また実Clusterが増えなくてよいです。

また、単一のArgoCDを運用保守しさせすればよいので、ハッピーになれます。

しかし私の状況では、単一のArgoCDでデプロイしなければならないプロダクトの数が非常に多く、単一のArgoCDの影響範囲がプロダクト全体に渡ってしまうため、おすすめしませんでした。

単一のArgoCDがデプロイするべきプロダクト数が少ない状況であれば、おすすめする価値があります。

<br>


# 06. おわりに

KubernetesのマルチテナントパターンとArgoCDでのテナント設計の実践をもりもり布教しました。

ArgoCDを使用している場合、プロダクト用Clusterが多くなるにつれて、必ずと言っていいほどマルチテナントは必要になってくるのでないかと思います。

マルチテナント設計をどう実践するのかに困っている組織の助けになれば幸いです。

なお、本記事のタイトルは、私が入信しているドメイン駆動設計の書籍 "[isbn:479813161X:title]" から拝借しました🙏🙏🙏

<br>

# 謝辞

ArgoCDでのテナント設計の実践にあたり、以下の方に有益なプラクティスをご教授いただきました。

- [`@toversus26`](https://twitter.com/toversus26) さん

この場で感謝申し上げます🙇🏻‍

<br>
