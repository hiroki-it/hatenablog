---
Title: 【ArgoCD🐙️】KubernetesのマルチテナントパターンとArgoCDの実践テナント設計
Category:
  - ArgoCD
  - Kubernetes
  - ソフトウェアアーキテクチャ
Date: 2023-07-08T22:25:34+09:00
URL: https://hiroki-hasegawa.hatenablog.jp/entry/2023/07/08/222534
EditURL: https://blog.hatena.ne.jp/hiroki-hasegawa/hiroki-hasegawa.hatenablog.jp/atom/entry/820878482948228657
Draft: true
---

<br>

[:contents]

<br>

# この記事から得られる知識

この記事を読むと、以下を **"完全に理解"** できます✌️

- Kubernetesのマルチテナントパターンの種類
- マルチテナントパターンをArgoCDで実践する場合にオススメのパターン
- NamespacedスコープモードなArgoCDでAppProjectテナントをどう設計するのか
- AppProjectテナントが無許可な空間へのアクセスを防ぐ仕組み

<br>

# 01. はじめに

<br>

<figure><img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_community-board.png" alt="argocd_community-board"><figcaption>画像引用元：<a href="https://github.com/argoproj">Argo Project</a></figcaption></figure>

<br>

彼への愛ゆえに思います。

3DのArgoくん...きめえぇ...

さて最近の業務で、全プロダクトの技術基盤開発チームに携わっており、全プロダクト共有のArgoCD🐙のApplicationのマルチテナント化を担当しました。

ArgoCDでデプロイしなければならないプロダクトが10個以上あり、ArgoCDのイカしたテナント設計が必要な状況でした。

今回は、ここで得られた知見を以下の構成で解説しました。

- [前提としてKubernetesのマルチテナントパターン](#03-前提としてKubernetesのマルチテナントパターン) (1-3章)
- [ArgoCDでのテナント設計の実践](#04-ArgoCDでのテナント設計の実践) (4章以降)

情報量がエグいことになってしまったので、[ArgoCDでのテナント設計の実践](#04-ArgoCDでのテナント設計の実践) だけでも見て帰っていただけると嬉しいです🙏

それでは、もりもり布教していきます😗

<div class="text-box">
記事中のこのボックスは、補足情報を記載しています。
<br>
<br>
飛ばしていただいても大丈夫ですが、読んでもらえるとより理解が深まるはずです👍
</div>

<br>

# 02. なぜApplicationにマルチテナントが必要なのか

## シングルテナントの場合

そもそも、なぜArgoCDにマルチテナントが必要なのでしょうか。

例えば、ArgoCDによるデプロイ先となっているプロダクト用Clusterがいくつかあると仮定します。

ArgoCDでシングルテナント内をオススメする場合、テナント内に各プロダクト用のApplicationを共存させることになります。

この場合、単一のArgoCDダッシュボードから全てのApplicationを操作できて便利です。

ただし、プロダクト用Cluster数が増えていくにつれて、問題が起こり始めます。

例えば、各プロダクトチームが誤ったApplication操作によるデプロイしてしまう可能性があります。

![argocd_single-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_single-tenant.png)

<br>

## マルチテナントの場合

その一方で、いい感じのマルチテナントにしたとします。

プロダクトチームは、テナント内の適切なApplicationを選べるようになります。

また認可の仕組みにより、誤ったApplication操作によるデプロイを防ぐことができます。

![argocd_multi-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant.png)

<br>

# 03. 前提としてKubernetesのマルチテナントパターン

## 概要

ArgoCDのテナントを解説する前に、前提としてKubernetesのマルチテナントパターンを整理しておきます。

Kubernetesのマルチテナントパターンは大きく、以下に大別できます。

<table>
   <thead>
      <tr>
         <th rowspan="2" style="text-align: center;"><nobr>マルチテナント</nobr><br>パターン名</th>
         <th rowspan="2" style="text-align: center;"><nobr>テナントの単位</nobr></th>
         <th colspan="2" style="text-align: center;"><nobr>テナント間のKubernetesリソース分離</nobr><br>(分離できていれば <code>⭕️</code> )</th>
         <th rowspan="2" >ツール<br>(アルファベット順)</th>
      </tr>
      <tr>
          <th style="text-align: center;"><nobr>Namespacedスコープ</nobr><br>リソース</th>
          <th style="text-align: center;"><nobr>Clusterスコープ</nobr><br>リソース</th>
      </tr>
   </thead>
   <tbody>
      <tr>
         <td style="text-align: center;">Clusters<br>as a Service</td>
         <td style="text-align: center;">実Cluster<br>テナント</td>
         <td style="text-align: center;"><code>⭕️</code></td>
         <td style="text-align: center;"><code>⭕️</code></td>
         <td>Clusterを増やすだけなのでツール不要</td>
      </tr>
      <tr>
         <td style="text-align: center;">ControlPlanes<br>as a Service</td>
         <td style="text-align: center;">仮想Cluster<br>テナント</td>
         <td style="text-align: center;"><code>⭕️</code></td>
         <td style="text-align: center;"><code>⭕️</code></td>
         <td>仮想Clusterツール (<a href="https://github.com/kcp-dev/kcp">Kcp</a>、<a href="https://github.com/virtual-kubelet/tensile-kube">tensile-kube</a>、<a href="https://github.com/loft-sh/vcluster">vcluster</a>、<a href="https://github.com/kubernetes-sigs/cluster-api-provider-nested/tree/main/virtualcluster">VirtualCluster</a>、など)</td>
      </tr>
      <tr>
         <td style="text-align: center;">Namespaces<br>as a Service</td>
         <td style="text-align: center;">Namespace<br>テナント</td>
         <td style="text-align: center;"><code>⭕️</code></td>
         <td></td>
         <td>Namespaceを増やすだけなのでツール不要</td>
      </tr>
      <tr>
         <td style="text-align: center;">各種ツール<br>ツール固有テナント</td>
         <td style="text-align: center;"><nobr>カスタムリソース</nobr><br>テナント</td>
         <td style="text-align: center;">ツールによる</td>
         <td style="text-align: center;">ツールによる</td>
         <td><a href="https://argo-cd.readthedocs.io/en/stable/user-guide/projects/">ArgoCD</a>AppProject、<a href="https://github.com/clastix/capsule">Capsule</a>のTenant、<a href="https://github.com/loft-sh/kiosk">kiosk</a>のAccount、<a href="https://github.com/kubewharf/kubezoo">KubeZoo</a>のTenant、など</td>
      </tr>
   </tbody>
</table>

<div class="text-box">
本記事では言及しませんが、『ソフトマルチテナンシー』と『ハードマルチテナンシー』といった分類方法もあります。
<br>
<br>
この分類方法では、テナント間の分離度の観点で各マルチテナントを種別します。
<br>
<br>
ソフトマルチテナンシーは、互いに信頼できる前提の上で、テナント間を弱く分離します。
<br>
<br>
その一方で、ハードマルチテナンシーは、互いに信頼できない前提の上でテナント間を強く分離します。
<br>
<br>
分離度がソフトとハードのいずれであるかに客観的な指標がなく、やや曖昧な種別になってしまうため、本記事の分類方法の方が個人的には好みです♡♡♡
<br>
<br>
<blockquote>
<ul>
<li>[asin:B072TS9ZQZ:title]</li>
<li>[https://kubernetes.io/docs/concepts/security/multi-tenancy/#isolation:title]</li>
<li>[https://aws.github.io/aws-eks-best-practices/security/docs/multitenancy/:title]</li>
</ul>
</blockquote>
</div>

<br>

## Clusters as-a-Service

### Clusters as-a-Serviceとは

テナントごとに、独立したClusterを提供します。

テナントを増やす場合、Clusterを新しく作成します。

![argocd_multi-tenant_k8s_clusters-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_clusters-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

### メリデメ

Clusters as-a-Serviceには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット                                                                                                                                                  | デメリット                                                                                 |
| :---------------------------------: | --------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------ |
|               拡張性                | -                                                                                                                                                         | テナントを増やすために実際のClusterを作成する必要があり、作業量が多い。                    |
|        安全性 (セキュリティ)        | 他のテナントからの通信を遮断できる。                                                                                                                      | -                                                                                          |
|               保守性                | 他のテナントとClusterスコープなKubernetesリソース (特にCRD) を分離できる。そのため、ClusterスコープなKubernetesリソースの変更が他のテナントに影響しない。 | 各Clusterを継続的に保守しないといけない。<nobr>(例：アップグレード、機能修正、など)</nobr> |
|                性能                 | 他のテナントとClusterのハードウェアリソースを分け合わずに、これを独占できる。                                                                             | -                                                                                          |

<br>

## ControlPlanes as-a-Service

### ControlPlanes as-a-Serviceとは

テナントごとに、独立したコントロールプレーンを提供します。

テナントを増やす場合、コントロールプレーンを新しく作成します。

コントロールプレーンの作成方法として、例えば仮想Clusterツール (<a href="https://github.com/kcp-dev/kcp">Kcp</a>、<a href="https://github.com/virtual-kubelet/tensile-kube">tensile-kube</a>、<a href="https://github.com/loft-sh/vcluster">vcluster</a>、<a href="https://github.com/kubernetes-sigs/cluster-api-provider-nested/tree/main/virtualcluster">VirtualCluster</a>、など) があります。

![argocd_multi-tenant_k8s_control-planes-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_control-planes-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

### メリデメ

ControlPlanes as-a-Serviceには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット                                                                                                                                                | デメリット                                                                                   |
| :---------------------------------: | ------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- |
|               拡張性                | -                                                                                                                                                       | テナントを増やすために仮想Clusterを作成する必要があり、作業量が多い。                        |
|        安全性 (セキュリティ)        | -                                                                                                                                                       | 他のテナントからの通信を遮断できない。                                                       |
|               保守性                | 他のテナントとClusterスコープなKubernetesリソース (特にCRD) を分離できる。そのため、ClusterスコープなKubernetesリソース変更が他のテナントに影響しない。 | 各仮想Clusterを継続的に保守しないといけない<nobr>(例：アップグレード、機能修正、など)</nobr> |
|                性能                 | -                                                                                                                                                       | 他のテナントとClusterのハードウェアリソースを分け合わないといけない。                        |

<br>

## Namespaces as-a-Service

### Namespaces as-a-Serviceとは

テナントごとに、独立したNamespaceを提供します。

テナントを増やす場合、Namespaceを新しく作成します。

![argocd_multi-tenant_k8s_namespaces-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_namespaces-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

### メリデメ

Namespaces as-a-Serviceには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット                                                                         | デメリット                                                                                                                                      |
| :---------------------------------: | -------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
|               拡張性                | テナントを増やすためにNamespaceを作成するだけでよく、作業量が少ない。            | -                                                                                                                                               |
|        安全性 (セキュリティ)        | -                                                                                | 他のテナントからの通信を遮断できない。                                                                                                          |
|               保守性                | 単一のClusterを保守すればよい。<nobr>(例：アップグレード、機能修正、など)</nobr> | 他のテナントとClusterスコープなKubernetesリソース (特にCRD) を共有しないといけない。そのため、Clusterスコープの変更は全てのテナントに影響する。 |
|                性能                 | -                                                                                | 他のテナントとClusterのハードウェアリソースを分け合わないといけない。                                                                           |

<br>

## ツール固有テナント

### ツール固有テナントとは

テナントごとに、ツール固有の論理空間 (例：<a href="https://argo-cd.readthedocs.io/en/stable/user-guide/projects/">ArgoCD</a>のAppProject、<a href="https://github.com/clastix/capsule">Capsule</a>のTenant、<a href="https://github.com/loft-sh/kiosk">kiosk</a>のAccount、<a href="https://github.com/kubewharf/kubezoo">KubeZoo</a>のTenant、など) を提供します。

テナントを増やす場合、ツール固有のカスタムリソースを新しく作成します。

ツールによっては、固有の論理空間を提供するだけでなく、前述のX as-a-Serviceも兼ねている場合があります。

![argocd_multi-tenant_k8s_tool](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_tool.png)

### メリデメ

ツール固有テナントの場合、メリデメがツールごとに異なります。

例えば、AppProjectテナントであると、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット                                                                         | デメリット                                                                                                                                                                                                                  |
| :---------------------------------: | -------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|               拡張性                | テナントを増やすためにAppProjectを作成するだけでよく、作業量が少ない。           | -                                                                                                                                                                                                                           |
|        安全性 (セキュリティ)        | -                                                                                | 他のテナントからの通信を遮断できない。                                                                                                                                                                                      |
|               保守性                | 単一のClusterを保守すればよい。<nobr>(例：アップグレード、機能修正、など)</nobr> | AppProjectはNamespacedスコープなカスタムリソースのため、他のテナントとClusterスコープなKubernetesリソース (特にCRD) を共有しないといけない。そのため、ClusterスコープなKubernetesリソースの変更は全てのテナントに影響する。 |
|                性能                 | -                                                                                | 他のテナントとClusterのハードウェアリソースを分け合わないといけない。                                                                                                                                                       |

<br>

# 04. ArgoCDでのテナント設計の実践

## オススメな設計の一覧

お待たせしました。

ここからは、KubernetesのマルチテナントをArgoCDで実践し、おすすめの設計を解説していきます。

なお、オススメするものを ★ としています。

<table>
  <thead>
    <tr>
      <th rowspan="2" style="text-align: center;">マルチテナント<br>パターン名</th>
      <th rowspan="2" style="text-align: center;">テナントの実践</th>
      <th rowspan="2" style="text-align: center;">ArgoCDがテナント間<br><nobr>独立 or 共有</nobr></th>
      <th colspan="2" style="text-align: center;"><nobr>テナント間のKubernetesリソース分離</nobr><br>(分離できていれば <code>⭕️</code> )</th>
      <th rowspan="2" style="text-align: center;"><nobr>オススメ</nobr></th>
    </tr>
    <tr>
      <th rowspan="2" style="text-align: center;"><nobr>Namespacedスコープ</nobr><br>リソース<br></th>
      <th rowspan="2" style="text-align: center;"><nobr>Clusterスコープ</nobr><br>リソース</th>
    </tr>
  </thead>
  <tbody style="text-align: center;">
    <tr>
      <td>Clusters<br>as-a-Service</td>
      <td>実Cluster</td>
      <td>独立</td>
      <td><code>⭕️</code></td>
      <td><code>⭕️</code></td>
      <td></td>
    </tr>
    <tr>
      <td>ControlPlanes<br>as-a-Service</td>
      <td>仮想Cluster</td>
      <td>独立</td>
      <td><code>⭕️</code></td>
      <td><code>⭕️</code></td>
      <td>★</td>
    </tr>
    <tr>
      <td>Namespaces<br>as-a-Service</td>
      <td>Namespace</td>
      <td>独立</td>
      <td><code>⭕️</code></td>
      <td></td>
      <td>★★</td>
    </tr>
    <tr>
      <td rowspan="2">各種ツール<br>ツール固有テナント</td>
      <td>AppProjectテナント<br>(Namespacedスコープ)</td>
      <td>共有</td>
      <td><code>⭕️</code><br></td>
      <td></td>
      <td>★★</td>
    </tr>
    <tr>
      <td>AppProjectテナント<br>(Clusterスコープ)</td>
      <td>独立</td>
      <td><code>⭕️</code></td> 
      <td></td>
      <td></td>
     </tr>
  </tbody>
</table>

<br>

## 凡例

図の中で使用している凡例の説明です。

ArgoCDの各コンポーネント (repo-server、application-controler) と各リソース (Application、AppProject) を区別しています。

![argocd_multi-tenant_legend](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_legend.png)

<br>

# 04-02. Clusters as-a-Serviceの場合

## 実Clusterテナント

実Clusterテナントは、Clusters as-a-Serviceなテナントの実践です。

後述の仮想Clusterと対比させるために、『実Cluster』と呼ぶことにします。

実Clusterテナントでは、デプロイ先のプロダクト用Clusterごとに実Clusterを作成します。

この時の実Clusterをテナントの単位とします。

![argocd_multi-tenant_physical_cluster](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_physical_cluster.png)

<br>

## オススメしなかった理由

| <nobr>アーキテクチャ</nobr><br>特性 | メリット | デメリット |
| :---------------------------------: | -------- | ---------- |
|               拡張性                | -        |            |
|        安全性 (セキュリティ)        | -        |            |
|               保守性                |          | -          |
|                性能                 | -        |            |

実Clusterテナント間では、実Cluster内のClusterスコープなKubernetesリソースやArgoCD系カスタムリソースを共有しません。

そのため、ClusterスコープなKubernetesリソースやArgoCD系カスタムリソース (例：Application、AppProject) 間を完全に分離できます。

その一方で、一番の致命的なデメリットがCluster数がむやみに増えることであり、運用保守が "とてもつらい" です。

これらを総合して、独断と偏見でオススメしませんでした。

<blockquote class="twitter-tweet tw-align-center" data-width="300"><p lang="ja" dir="ltr">半年以内にアップグレードしないとサポートが切れるKubernetesクラスターが33個もあって、泣いちゃった</p>&mdash; 長谷川 広樹 (俺です) (@Hiroki__IT) <a href="https://twitter.com/Hiroki__IT/status/1615710926489124865?ref_src=twsrc%5Etfw">January 18, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<br>

# 04-03. ControlPlanes as-a-Serviceの場合 - ★

## 仮想Clusterテナント

仮想Clusterテナントは、ControlPlanes as-a-Serviceなテナントの実践です。

仮想Clusterテナントでは、テナントごとに仮想Clusterを作成します。

具体的には、プロダクト共有Cluster上に仮想Clusterを作成し、各仮想Cluster上でArgoCDを動かします。

![argocd_multi-tenant_virtual_cluster](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_virtual_cluster.png)

> - [https://blog.argoproj.io/using-argo-cd-with-vclusters-5df53d1c51ce:title]

<br>

## オススメした理由

| <nobr>アーキテクチャ</nobr><br>特性 | メリット | デメリット |
| :---------------------------------: | -------- | ---------- |
|               拡張性                | -        |            |
|        安全性 (セキュリティ)        | -        |            |
|               保守性                |          | -          |
|                性能                 | -        |            |

仮想Clusterテナント間では、仮想Cluster内のClusterスコープなKubernetesリソースやArgoCD系カスタムリソースを共有しません。

そのため、実Clusterテナントのよいところ (ClusterスコープなKubernetesリソースやArgoCD系カスタムリソースの分離) を享受しながら、実Clusterが増えなくてよいです。

その一方で、仮想Cluster自体が増えてしまうことと、技術的に発展途上で運用保守の難易度が高くなってしまいます。

ただ、仮想Clusterを運用保守できるスーパーつよつよ組織であれば、前述のデメリットはカバーできると判断しました。

これらを総合して、独断と偏見でオススメとしました。

<br>

# 04-04. Namespaces as-a-Serviceの場合 - ★★

## Namespaceテナント

Namespaceテナントは、Namespaces as-a-Serviceなテナントの実践です。

ただ、後述の **<font color="#FF0000">AppProjectテナントは、Namespaceテナントを兼ねるパターン</font>** です。

そのため、ここではNamespaceテナントの解説は省略します。

<br>

# 04-05. ツール固有テナントの場合

## AppProjectテナント

AppProjectテナントは、ツール固有テナントの実践です。

AppProjectテナントでは、テナントごとにAppProjectを作成します。

AppProjectのカスタムリソース定義の`spec.scope`キーからも分かる通り、AppProjectはNamespacedスコープなカスタムリソースです。

そのため、**<font color="#FF0000">AppProjectテナントはNamespaceテナントを兼ねるパターン</font>** です。

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  labels:
    app.kubernetes.io/name: appprojects.argoproj.io
    app.kubernetes.io/part-of: argocd
  name: appprojects.argoproj.io
spec:
  group: argoproj.io
  names:
    kind: AppProject

    ...

  # Namespacedスコープなカスタムリソースであるとわかる
  scope: Namespaced

...
```

> - [https://github.com/argoproj/argo-cd/blob/master/manifests/crds/appproject-crd.yaml:title]

<div class="text-box">
AppProjectはカスタムリソースであり、カスタムリソース定義の実装からドキュメントに未記載の仕様を読み取れることがあります。
<br>
<br>
例えば、本記事ではAppProjectに自由にNamespaceを設定していますが、ArgoCDのドキュメントには<code>argocd</code>というNamespace以外を設定できることが明記されていません。
<br>
<br>
カスタムリソース定義の各オプションの意味合いについては、以下が参考になりました👍
<blockquote>
<ul><li>[https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/:title]</li></ul>
</blockquote>
</div>

<br>

## NSモード vs. CLモード

ArgoCDの **"repo-server"** と **"application-controller"** には、NamespacedスコープモードとClusterスコープモード (以降、**NSモード** **CLモード**) があります。

| スコープモードの種類                   | ArgoCDは独立/共有 | ArgoCD自体の認可スコープ                                                  |
| -------------------------------------- | ----------------- | ------------------------------------------------------------------------- |
| Namespacedスコープモード<br>(NSモード) | 各テナントで独立  | ArgoCDの各コンポーネントは、自分自身が属するNamespaceのみにアクセスできる |
| Clusterスコープモード<br>(CLモード)    | 各テナントで共有  | ArgoCDの各コンポーネントは、許可された任意のNamespaceにアクセスできる     |

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

<br>

## NSモードなArgoCDの場合 - ★★

### NSモードなArgoCDとは

NSモードなArgoCDでは、各テナント間で独立したArgoCDを管理します。

また、ArgoCDの各コンポーネントは自分自身が属するNamespaceのみにアクセスできます。

例えば、プロダクト共有Cluster上に、プロダクト別のNamespaceと実行環境別のAppProjectを作成します。

この時、もう一方のClusterスコープとは異なり、各テナント間で独立したArgoCDがCluster上にいます。

![argocd_multi-tenant_appproject_namespaced-scope](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope.png)

### 設定方法

#### ▼ AppProjectの設定

例えば、AppProjectは以下のようになります。

後述のCLモードと同様にして、`.spec.destination`キー配下に、テナント内のApplicationがいずれにデプロイ可能かを設定します。

一方でこれとの違いとして、`.spec.sourceNamespaces`キーを設定は不要です。

これにより、argocd-serverはAppProjectで許可された対象にのみアクセスできるようになります。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: foo-tenant
  namespace: foo
spec:
  destinations:
    # ArgoCD自体が動いているCluster
    - namespace: foo
      server: "https://kubernetes.default.svc"
    # ArgoCDのデプロイ先Cluster
    - namespace: "*"
      server: https://*****.gr7.ap-northeast-1.eks.amazonaws.com
  # 設定しない
  # sourceNamespaces:
  #   - foo
```

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

#### ▼ 専用ConfigMap (`argocd-cmd-params-cm`) の設定

`argocd-cmd-params-cm`には、ArgoCDの各コンポーネントのコンテナのパラメーターを宣言的にできます。

例えば、`argocd-cmd-params-cm`は以下のようになります。

後述のCLモードとの違いとして、`data.application.namespaces`キーの設定は不要です。

これにより、argocd-serverとapplication-controllerは自身が属するNamespaceにしかアクセスできなくなります。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: foo
data:
  # 設定しない
  # application.namespaces: "*"
```

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

### NSモードをオススメした理由

| <nobr>アーキテクチャ</nobr><br>特性 | メリット | デメリット |
| :---------------------------------: | -------- | ---------- |
|               拡張性                | -        |            |
|        安全性 (セキュリティ)        | -        |            |
|               保守性                |          | -          |
|                性能                 | -        |            |

NSモードなArgoCDのAppProjectテナント間では、ClusterスコープなKubernetesリソースは共有してしまいますが、ArgoCDの各コンポーネントを共有します。

そのため、Namespaceテナントのよいところ (NamespacedスコープなKubernetesリソースやArgoCD系カスタムリソースの分離) を享受しつつ、各テナントがArgoCDを自由にカスタマイズできます。

その一方で、ClusterスコープなKubernetesリソース (特にCRD) のアップグレードは、全てのテナントのArgoCD系カスタムリソースに影響を与えてしまいます。

ただ、アップグレード後の新ArgoCD用のClusterを新しく作成してしまえばよいので、前述のデメリットはカバーできると判断しました。

これらを総合して、独断と偏見でオススメしました。

<br>

## CLモードなArgoCDの場合

### CLモードなArgoCDとは

CLモードなArgoCDでは、各テナント間で共有のArgoCDを管理します

また、全てテナントArgoCDの単一のコンポーネントが、許可された任意のNamespaceにアクセスできます。

例えば、プロダクト共有Cluster上に、プロダクト別のNamespaceと実行環境別のAppProjectを作成します。

この時、もう一方のNamespacedスコープとは異なり、各テナント間で共有されたArgoCDがCluster上にいます。

![argocd_multi-tenant_appproject_cluster-scope](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_cluster-scope.png)

### 設定方法

#### ▼ AppProjectの設定

例えば、AppProjectは以下のようになります。

前述のNSモードと同様にして、`.spec.destination`キーで、テナント内のApplicationがいずれにデプロイ可能かを設定する必要があります。

一方でこれとの違いとして、`.spec.sourceNamespaces`キーの設定が必要です。

`.spec.sourceNamespaces`キーでは、このAppProjectへの所属を許可したいApplicationのNamespaceを設定します。

基本的には、AppProjectと同じNamespaceを設定することになると思います。

これにより、argocd-serverはAppProjectで許可された対象にのみアクセスできるようになります。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: foo-tenant
  namespace: foo
spec:
  sourceNamespaces:
    - foo
  # 所属しているApplicationを操作して、いずれにデプロイ可能かを設定する
  destinations:
    # ArgoCD自体が動いているCluster
    - namespace: foo
      server: "https://kubernetes.default.svc"
    # ArgoCDのデプロイ先Cluster
    - namespace: "*"
      server: https://*****.gr7.ap-northeast-1.eks.amazonaws.com
```

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

#### ▼ 専用ConfigMap (`argocd-cmd-params-cm`) の設定

`argocd-cmd-params-cm`には、ArgoCDの各コンポーネントのコンテナのパラメーターを宣言的にできます。

例えば、`argocd-cmd-params-cm`は以下のようになります。

NSモードとの違いとして、`data.application.namespaces`キーで、argocd-serverとapplication-controllerがいずれのNamespaceにアクセスできるかを設定する必要があります (例：全てのNamespaceの場合は`*`)。

これにより、argocd-serverとapplication-controllerは自身が属するNamespace以外にもアクセスできるようになります。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: foo
data:
  application.namespaces: "*"
```

`argocd-cmd-params-cm`の代わりに、これらの起動時にパラメーターとして渡しても良いです。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: argocd-server
  namespace: argocd
spec:
  containers:
    - name: argocd-server
      image: quay.io/argoproj/argocd:latest
      args:
        - /usr/local/bin/argocd-server
        # 起動時のパラメーターとして
        - --application-namespaces="*"

  ...
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: argocd-application-controller
  namespace: argocd
spec:
  containers:
    - name: argocd-application-controller
      image: quay.io/argoproj/argocd:latest
      args:
        - /usr/local/bin/argocd-application-controller
        # 起動時のパラメーターとして
        - --application-namespaces="*"

  ...
```

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]
> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/server-commands/argocd-application-controller/:title]
> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/server-commands/argocd-server/:title]

<br>

### CLモードをオススメしなかった理由

| <nobr>アーキテクチャ</nobr><br>特性 | メリット | デメリット |
| :---------------------------------: | -------- | ---------- |
|               拡張性                | -        |            |
|        安全性 (セキュリティ)        | -        |            |
|               保守性                |          | -          |
|                性能                 | -        |            |

CLモードなArgoCDのAppProjectテナント間では、ClusterスコープなKubernetesリソースは共有してしまいますが、ArgoCDの各コンポーネントを共有します。

そのため、Namespaceテナントのよいところ (NamespacedスコープなKubernetesリソースやArgoCD系カスタムリソースの分離) を享受しつつ、単一のArgoCDを運用保守しさせすればよいです。

その一方で、

これらを総合して、独断と偏見でオススメしませんでした。

<br>

# 05. NSモードなArgoCDのAppProjectテナント例

## オススメな設計の一覧

今度は、NSモードなArgoCDのAppProjectテナントを採用する場合、おすすめのAppProjectテナント例を解説していきます。

前述の通り、NSモードなArgoCDでは、NamespaceとAppProjectの両方を考える必要があります。

<table>
  <thead>
  <tr>
    <th rowspan="2" style="text-align: center;">AppProjectテナント間の分離度</th>
    <th colspan="2" style="text-align: center;">AppProjectテナント例<br>(NamespaceとAppProjectの組み合わせ)</th>
    <th rowspan="2" style="text-align: center;">オススメ</th>
  </tr>
  <tr>
    <th style="text-align: center;">Namespace</th>
    <th style="text-align: center;">AppProject</th>
  </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center;">低</td>
      <td style="text-align: center;">実行環境別</td>
      <td style="text-align: center;">実行環境別</td>
      <td style="text-align: center;"></td>
    </tr>
    <tr>
      <td style="text-align: center;">中</td>
      <td style="text-align: center;">プロダクトチーム別</td>
      <td style="text-align: center;">実行環境別</td>
      <td style="text-align: center;">★</td>
    </tr>
    <tr>
      <td style="text-align: center;">高</td>
      <td style="text-align: center;">プロダクトチーム別</td>
      <td style="text-align: center;">プロダクトのサブチーム別</td>
      <td style="text-align: center;">★</td>
    </tr>
  </tbody>
</table>
<div class="text-box">
本記事では言及しませんが、Namespaceにもいくつかの分割パターンがあり、これも取り入れてAppProjectテナントを設計すると良いです。
<br>
<br>
例えば、"チーム別" という分割パターンは、様々な著名な書籍やブログで紹介されています👍
<blockquote>
<ul>
  <li>[https://www.amazon.co.jp/dp/1617293725:title]</li>
  <li>[https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-organizing-with-namespaces?hl=en:title]</li>
</ul>
</blockquote>
</div>

<br>

## 低分離なAppProjectテナント

### 低分離なAppProjectテナントとは

例えば、プロダクトごとに異なるチームがいると仮定します。

また、ArgoCDのデプロイ対象のプロダクトが複数おり、プロダクトの実行環境 (Dev環境、Tes環境) 別にClusterがいるとします。

この時、プロダクトの実行環境別にNamespaceを作成します。

![argocd_multi-tenant_appproject_namespaced-scope_pattern_1](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_pattern_1.png)

### オススメしなかった理由

プロダクトの実行環境別では、AppProjectテナントの粒度が細かすぎて、将来的に問題が起こることを予想できます。

例えば、Cluster上にArgoCDが増えすぎてIPアドレスが枯渇することや、ArgoCDが増えた分だけ運用が大変になることです。

これらを総合して、独断と偏見でオススメしませんでした。

<br>

## 中分離なAppProjectテナント

### 中分離なAppProjectテナントとは

同様にして、プロダクトごとに異なるチームがおり、プロダクトの実行環境 (Dev環境、Tes環境) 別にClusterがいると仮定します。

この時、プロダクトチーム別にNamespaceを作成します。

![argocd_multi-tenant_appproject_namespaced-scope_pattern_2](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_pattern_2.png)

### オススメした理由

単一のClusterで全プロダクト用の各ArgoCDを運用する必要がありました。

これらを総合して、独断と偏見でオススメしました。

<br>

## 高分離なAppProjectテナント

### 高分離なAppProjectテナントとは

記入中...

![argocd_multi-tenant_appproject_namespaced-scope_pattern_3](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_pattern_3.png)

### オススメした理由

また、`argocd-rbac-cm`というConfigMapを使用して、ログインユーザーのテナント内のArgoCD系カスタムリソースに対する認可スコープを絞ることもできます。

これらを総合して、独断と偏見でオススメしました。

<br>

# 05-02. 高分離なAppProjectテナントが無許可な空間へのアクセスを防ぐ仕組み

そろそろ解説を読むのがしんどい方がいるのではないでしょうか。

『君がッ、泣くまで、解説をやめないッ！』

ここでは、前述の **"高分離なAppProjectテナント"** を採用したと仮定します。

AppProjectテナントは、無許可な空間 (Namespace、AppProject) へのアクセスを防ぎます。

エラー例をいくつか挙げて解説します⚠️

<br>

## ログインユーザーの無許可な空間内でのマニフェスト操作を防ぐ

AppProjectテナントは、ログインユーザーが無許可な空間 (Namespace、AppProject) 内でマニフェストを操作することを防ぎます。

![argocd_multi-tenant_appproject_namespaced-scope_argocd-server](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_argocd-server.png)

### エラーが起こらない場合

(1) argocd-serverは、`argocd-cmd-params-cm`から自分自身のNamespaceの認可スコープを取得します。

(2) fooプロダクトチームのinfraチームが、argocd-serverを操作します。

(3) argocd-serverは、`argocd-rbac-cm`からfooプロダクトチームのArgoCD系カスタムリソースに対する認可スコープを取得します

(4) infraチームは、テナント内で許可されたApplicationを操作します。

(5) infraチームは、fooプロダクト用のdev Clusterの`infra`というNamespaceにマニフェストをデプロイします。

### (例1) 無許可なNamespaceでApplicationを作成しようとした場合

例えば、fooプロダクトチームが無許可なNamespace (例：`bar`) でApplicationを作成しようとします。

すると、argocd-serverは以下のようなエラーを返却します

```sh
namespace bar is not permitted in project 'infra-team'
```

無許可なNamespaceでApplicationを作れてしまうと、そのApplicationから誤ったClusterにマニフェストをデプロイできてしまいます😈

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/util/argo/argo_test.go#L679-L710:title]

### (例2) 無許可なAppProjectでApplicationを作成しようとした場合

もし、fooプロダクトチームが無許可なAppProject (例：`bar-team`) でApplicationを作成しようとします。

すると、argocd-serverは以下のようなエラーを返却します。

```sh
Application referencing project 'bar-team' which does not exist
```

無許可なAppProjectでApplicationを作成できてしまうと、そのApplicationから誤ったClusterにマニフェストをデプロイできてしまいます😈

### (例3) 誤ったデプロイ先Clusterを指定しようとした場合

誤ったデプロイ先Clusterとは、テナント内のApplicationからはデプロイ先として選ぶべきではないClusterのことです。

例えば、fooプロダクトチームがApplicationで誤ったCluster (例：`bar-cluster`) をデプロイ先として指定しようします。

すると、argocd-serverは以下のようなエラーを返却します。

```sh
application destination
{https://bar-cluster.gr7.ap-northeast-1.eks.amazonaws.com infra} is not permitted in project 'infra-team'
```

誤ったClusterをデプロイ先に指定できてしまうと、そのApplicationから誤ったClusterにマニフェストをデプロイできてしまいます😈

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/util/argo/argo_test.go#L679-L710:title]

### (例4) 無許可なデプロイ先Namespaceを指定しようとした場合

最後のエラーは、やや変化球です。

誤ったデプロイ先Namespaceとは、テナント内のApplicationからはデプロイ先として選ぶべきではないNamespaceのことです。

例えば、fooプロダクトチームが、Applicationで無許可なNamespace (例：`app`) をデプロイ先に指定しようします。

すると、argocd-serverは以下のようなエラーを返却します。

```sh
application destination
{https://foo-cluster.gr7.ap-northeast-1.eks.amazonaws.com app} is not permitted in project 'infra-team'
```

無許可なNamespaceをデプロイ先に指定できてしまうと、そのApplicationから誤ったNamespaceにマニフェストをデプロイできてしまいます😈

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/util/argo/argo_test.go#L679-L710:title]

<br>

## application-controllerの無許可な空間へのReconciliationを防ぐ

AppProjectテナントは、application-controllerが無許可な空間 (Namespace、AppProject) 内にReconciliationすることを防ぎます。

![argocd_multi-tenant_appproject_namespaced-scope_application-controller](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_application-controller.png)

### エラーが起こらない場合

(1) application-controllerは、`argocd-cmd-params-cm`から自分自身のNamespaceの認可スコープを取得します。

(2) application-controllerは、同じNamespaceに属するArgoCD系カスタムリソースに対して、Reconciliationを実行します。

### (例1)

例えば、application-controllerが、無許可な空間に属するArgoCD系カスタムリソースに対してReconciliationを実行しようとします。

すると、application-controllerはこれを検証し、Reconciliationの実行を回避しようとします。

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/controller/appcontroller_test.go#L1517-L1543:title]

<br>

# 06. おわりに

KubernetesのマルチテナントパターンとArgoCDでのテナント設計の実践をもりもり布教しました。

情報を詰め込みすぎた感があります。

『拳は読者を置き去りにした』

KubernetesのマルチテナントパターンをArgoCDでどう実践するべきかに困っている組織の助けになれば幸いです👍

<br>

# 謝辞

本記事のタイトルは、私が入信しているドメイン駆動設計の書籍 **"[isbn:479813161X:title]"** から拝借しました🙏🙏🙏

また、ArgoCDでのテナント設計の実践にあたり、以下の方に有益なプラクティスをご教授いただきました。

- [`@toversus26`](https://twitter.com/toversus26) さん

この場で感謝申し上げます🙇🏻‍

<br>
