---
Title: 【ArgoCD🐙️】KubernetesのマルチテナントパターンとArgoCDの実践テナント設計
Category:
  - ArgoCD
  - Kubernetes
  - ソフトウェアアーキテクチャ
  - 認証/認可
Date: 2023-07-08T22:25:34+09:00
URL: https://hiroki-hasegawa.hatenablog.jp/entry/2023/07/08/222534
EditURL: https://blog.hatena.ne.jp/hiroki-hasegawa/hiroki-hasegawa.hatenablog.jp/atom/entry/820878482948228657
Draft: true
---

<br>

[:contents]

<br>

# この記事から得られる知識

この記事を読むと、以下を **"完全に理解"** できます✌️

- Kubernetesのマルチテナントパターンの種類
- マルチテナントパターンをArgoCDで実践する場合にオススメのパターン
- ArgoCDのNamespacedスコープモードとClusterスコープモード
- Projectテナントがマニフェストのデプロイを制限する仕組み

<br>

# 01. はじめに

<br>

<figure><img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_community-board.png" alt="argocd_community-board"><figcaption>画像引用元：<a href="https://github.com/argoproj">Argo Project</a></figcaption></figure>

<br>

彼への愛ゆえに思います。

3DのArgoくん...きめえぇ...

さて最近の業務で、全プロダクトの技術基盤開発チームに携わっており、全プロダクト共有のArgoCD🐙のマルチテナント化を担当しました。

ArgoCDのデプロイ先のClusterが`10`個以上あり、Clusterによっては複数のサブチームが`100`個以上のマイクロサービスを運用しています。

今回は、このような大規模なマイクロサービスシステム群の状況下で得られたマルチテナント実践の知見を、以下の章立てで解説しました。

- [Kubernetesのマルチテナントパターン](#03-Kubernetesのマルチテナントパターン) (3章)
- [ArgoCDでのテナントパターン実践の一覧](#04-ArgoCDでのテナントパターン実践の一覧) (4章)
- [ArgoCDのClusterスコープモードとNamespacedスコープモード](#05-CLモードなArgoCD) (5章)
- [Projectテナントのデプロイ制限の仕組み](#06-Projectテナントのデプロイ制限の仕組み) (6章)

情報量がエグいことになってしまったので、気になる章だけでも見て帰っていただけるとハッピーです🙏

それでは、もりもり布教していきます😗

<div class="text-box">
記事中のこのボックスは、補足情報を記載しています。
<br>
<br>
飛ばしていただいても大丈夫ですが、読んでもらえるとより理解が深まるはずです👍
</div>

<br>

# 02. なぜArgoCDにマルチテナントが必要なのか

## シングルテナントの場合

そもそも、なぜArgoCDにマルチテナントが必要なのでしょうか。

例えば、マニフェストのデプロイ先となるプロダクト用Cluster (例；foo、bar、baz) があると仮定します。

ArgoCDをシングルテナントにする場合、各プロダクトチームの操作するApplicationを同じテナントに共存させることになります。

この場合、単一のArgoCDダッシュボード (argocd-server) から全てのApplicationを操作できて便利です。

しかし、プロダクト用Cluster数が増えていくにつれて、問題が起こり始めます。

例えば、いずれかのプロダクトチームが誤ったApplicationを操作し、誤ったClusterにマニフェストをデプロイしてしまう可能性があります。

![argocd_single-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_single-tenant.png)

<br>

## マルチテナントの場合

その一方で、いい感じのマルチテナントにしたとします。

プロダクトチームは、許可テナント内のApplicationのみを操作できます。

これにより、誤ったプロダクト用Clusterにマニフェストをデプロイすることを防げます。

![argocd_multi-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant.png)

<br>

# 03. Kubernetesのマルチテナントパターン

## マルチテナントパターンの一覧

ArgoCDのテナント設計を実践する前に、Kubernetesにはどんなマルチテナントパターンがあるのでしょうか。

Kubernetesのマルチテナントパターンは大きく、以下に大別できます。

<table>
   <thead>
      <tr>
         <th rowspan="2" style="text-align: center;"><nobr>マルチテナント</nobr><br>パターン名</th>
         <th rowspan="2" style="text-align: center;"><nobr>テナントの単位</nobr></th>
         <th colspan="2" style="text-align: center;"><nobr>テナント間のKubernetesリソース分離</nobr><br>(分離できていれば ✅ )</th>
         <th rowspan="2" >ツール<br>(アルファベット順)</th>
      </tr>
      <tr>
          <th style="text-align: center;"><nobr>Namespacedスコープ</nobr><br>リソース</th>
          <th style="text-align: center;"><nobr>Clusterスコープ</nobr><br>リソース</th>
      </tr>
   </thead>
   <tbody>
      <tr>
         <td style="text-align: center;">Clusters<br>as a Service</td>
         <td style="text-align: center;">実Cluster<br>テナント</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;">✅</td>
         <td>実Cluster管理ツール (AWS EKS、GCP GKE、Azure AKE、Kubeadm、など)</td>
      </tr>
      <tr>
         <td style="text-align: center;">ControlPlanes<br>as a Service</td>
         <td style="text-align: center;">仮想Cluster<br>テナント</td>
         <td style="text-align: center;">✅</td>
         <td style="text-align: center;">✅</td>
         <td>仮想Cluster管理ツール (<a href="https://github.com/kcp-dev/kcp">Kcp</a>、<a href="https://github.com/virtual-kubelet/tensile-kube">tensile-kube</a>、<a href="https://github.com/loft-sh/vcluster">vcluster</a>、<a href="https://github.com/kubernetes-sigs/cluster-api-provider-nested/tree/main/virtualcluster">VirtualCluster</a>、など)</td>
      </tr>
      <tr>
         <td style="text-align: center;">Namespaces<br>as a Service</td>
         <td style="text-align: center;">Namespace<br>テナント</td>
         <td style="text-align: center;">✅</td>
         <td></td>
         <td>Namespaceを増やすだけなのでツール不要</td>
      </tr>
      <tr>
         <td style="text-align: center;">ツール固有テナント</td>
         <td style="text-align: center;"><nobr>カスタムリソース</nobr><br>テナント</td>
         <td style="text-align: center;">ツールによる</td>
         <td style="text-align: center;">ツールによる</td>
         <td><a href="https://argo-cd.readthedocs.io/en/stable/user-guide/projects/">ArgoCD</a>AppProject、<a href="https://github.com/clastix/capsule">Capsule</a>のTenant、<a href="https://github.com/loft-sh/kiosk">kiosk</a>のAccount、<a href="https://github.com/kubewharf/kubezoo">KubeZoo</a>のTenant、など</td>
      </tr>
   </tbody>
</table>

<br>

<div class="text-box">
本記事では言及しませんが、<b>"ソフトマルチテナンシー"</b> と <b>"ハードマルチテナンシー"</b> といった分類方法もあります。
<br>
<br>
この分類方法では、テナント間の分離度の観点で各マルチテナントを種別します。
<br>
<br>
ソフトマルチテナンシーは、互いに信頼できる前提の上で、テナント間を弱く分離します。
<br>
<br>
その一方で、ハードマルチテナンシーは、互いに信頼できない前提の上でテナント間を強く分離します。
<br>
<br>
分離度がソフトとハードのいずれであるかに客観的な指標がなく、やや曖昧な種別になってしまうため、本記事の X as-Service の方が個人的には好みです♡♡♡
<br>
<br>
<blockquote>
<ul>
<li>[asin:B072TS9ZQZ:title]</li>
<li>[https://kubernetes.io/docs/concepts/security/multi-tenancy/#isolation:title]</li>
<li>[https://aws.github.io/aws-eks-best-practices/security/docs/multitenancy/:title]</li>
</ul>
</blockquote>
</div>

<br>

## Clusters as-a-Service

### Clusters as-a-Serviceとは

Clusters as-a-Serviceは、テナントごとに独立したClusterを提供します。

仮想Cluster管理ツールとして、AWS EKS、GCP GKE、Azure AKE、Kubeadm、などがあります。

![argocd_multi-tenant_k8s_clusters-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_clusters-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

### メリデメ

Clusters as-a-Serviceには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                                                               | デメリット **×**                                                                                       |
| :---------------------------------: | --------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
|               拡張性                | -                                                                                                                                                         | テナントを増やすために実際のClusterを用意する必要があり、作業量が多い。                                |
|      安全性<br>(セキュリティ)       | 他のテナントからの通信を遮断できる。                                                                                                                      | -                                                                                                      |
|               保守性                | 他のテナントとClusterスコープなKubernetesリソース (特にCRD) を分離できる。そのため、ClusterスコープなKubernetesリソースの変更が他のテナントに影響しない。 | 各テナントで実Clusterを継続的に保守しないといけない。<nobr>(例：アップグレード、機能修正、など)</nobr> |
|                性能                 | 他のテナントとClusterのハードウェアリソースを奪い合わずに、これを独占できる。                                                                             | -                                                                                                      |

<br>

## Control Planes as-a-Service

### Control Planes as-a-Serviceとは

Control Planes as-a-Serviceは、テナントごとに独立したコントロールプレーン (言い換えば仮想Cluster) を提供します。

仮想Cluster管理ツールとして、<a href="https://github.com/kcp-dev/kcp">Kcp</a>、<a href="https://github.com/virtual-kubelet/tensile-kube">tensile-kube</a>、<a href="https://github.com/loft-sh/vcluster">vcluster</a>、<a href="https://github.com/kubernetes-sigs/cluster-api-provider-nested/tree/main/virtualcluster">VirtualCluster</a>、などがあります。

![argocd_multi-tenant_k8s_control-planes-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_control-planes-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

### メリデメ

Control Planes as-a-Serviceには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                                                                        | デメリット **×**                                                                                       |
| :---------------------------------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------ |
|               拡張性                | テナントを増やすために仮想Clusterを用意するだけでよく、実Clusterを用意するよりは作業量が少ない。                                                                   | -                                                                                                      |
|      安全性<br>(セキュリティ)       | -                                                                                                                                                                  | 他のテナントからの通信を遮断できない。                                                                 |
|               保守性                | 他のテナントとClusterスコープまたはNamespacedスコープなKubernetesリソースを分離できる。<br>これらのKubernetesリソース (特にCRD) の変更が他のテナントに影響しない。 | 各テナントで仮想Clusterを継続的に保守しないといけない<nobr>(例：アップグレード、機能修正、など)</nobr> |
|                性能                 | -                                                                                                                                                                  | 他のテナントとClusterのハードウェアリソースを奪い合わないといけない。                                  |

<br>

## Namespaces as-a-Service

### Namespaces as-a-Serviceとは

Namespaces as-a-Serviceは、テナントごとに独立したNamespaceを提供します。

Namespaceを増やすだけなので、ツールは不要です。

![argocd_multi-tenant_k8s_namespaces-as-a-service](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_namespaces-as-a-service.png)

> - [https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/:title]
> - [https://www.cognixia.com/blog/what-are-the-three-tenancy-models-for-kubernetes/:title]

### メリデメ

Namespaces as-a-Serviceには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                      | デメリット **×**                                                                                                                                |
| :---------------------------------: | -------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
|               拡張性                | テナントを増やすためにNamespaceを用意するだけでよく、作業量が少ない。            | -                                                                                                                                               |
|      安全性<br>(セキュリティ)       | -                                                                                | 他のテナントからの通信を遮断できない。                                                                                                          |
|               保守性                | 単一のClusterを保守すればよい。<nobr>(例：アップグレード、機能修正、など)</nobr> | 他のテナントとClusterスコープなKubernetesリソースを共有しないといけない。そのため、Clusterスコープ (特にCRD) の変更は全てのテナントに影響する。 |
|                性能                 | -                                                                                | 他のテナントとClusterのハードウェアリソースを奪い合わないといけない。                                                                           |

<br>

## ツール固有テナント

### ツール固有テナントとは

ツール固有テナントは、テナントごとに固有の論理空間 (例：<a href="https://argo-cd.readthedocs.io/en/stable/user-guide/projects/">ArgoCD</a>のAppProject、<a href="https://github.com/clastix/capsule">Capsule</a>のTenant、<a href="https://github.com/loft-sh/kiosk">kiosk</a>のAccount、<a href="https://github.com/kubewharf/kubezoo">KubeZoo</a>のTenant、など) を提供します。

ツールによっては、X as-a-Service も兼ねている場合があります。

今回紹介するAppProjectはNamespaceテナントを兼ねており、[ツール固有のテナント](#04-05-ツール固有テナントの実践) で解説しています。

![argocd_multi-tenant_k8s_tool](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_k8s_tool.png)

### メリデメ

ツール固有テナントの場合、メリデメがツールごとに異なります。

ArgoCDのAppPrpjectのメリデメについては、[ツール固有テナント](#04-05-ツール固有テナントの実践) で解説しています。

<br>

# 04. ArgoCDでのテナントパターン実践の一覧

お待たせしました。

ここからは、KubernetesのマルチテナントをArgoCDで実践し、おすすめのテナントパターンを解説していきます。

なお、オススメするものを ★ としています。

<table>
  <thead>
    <tr>
      <th rowspan="2" style="text-align: center;">マルチテナント<br>パターン名</th>
      <th rowspan="2" style="text-align: center;">テナント実践</th>
      <th rowspan="2" style="text-align: center;">ArgoCDがテナント間で<br><nobr>独立 / 共有</nobr></th>
      <th colspan="2" style="text-align: center;"><nobr>テナント間のKubernetesリソース分離</nobr><br>(分離できていれば ✅ )</th>
      <th rowspan="2" style="text-align: center;"><nobr>オススメ</nobr></th>
    </tr>
    <tr>
      <th rowspan="2" style="text-align: center;"><nobr>Namespacedスコープ</nobr><br>リソース<br></th>
      <th rowspan="2" style="text-align: center;"><nobr>Clusterスコープ</nobr><br>リソース</th>
    </tr>
  </thead>
  <tbody style="text-align: center;">
    <tr>
      <td><a href="#04-02-Clusters-as-a-Service-の実践">Clusters<br>as-a-Service</a></td>
      <td>実Clusterテナント</td>
      <td>独立</td>
      <td>✅</td>
      <td>✅</td>
      <td></td>
    </tr>
    <tr>
      <td><a href="#04-03-Control-Planes-as-a-Service-の実践">Control Planes<br>as-a-Service</a></td>
      <td>仮想Clusterテナント</td>
      <td>独立</td>
      <td>✅</td>
      <td>✅</td>
      <td>★</td>
    </tr>
    <tr>
      <td><a href="#04-04-Namespace-as-a-Service-の実践">Namespaces<br>as-a-Service</a></td>
      <td>Namespaceテナント</td>
      <td>独立</td>
      <td>✅</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td rowspan="2"><a href="#04-05-ツール固有テナント-の実践">ツール固有テナント</a></td>
      <td>Projectテナント<br>(CLモード)</td>
      <td>独立</td>
      <td>✅</td> 
      <td></td>
      <td></td>
     </tr>
    <tr>
      <td>Projectテナント<br>(NSモード)</td>
      <td>共有</td>
      <td>✅<br></td>
      <td></td>
      <td>★★</td>
    </tr>
  </tbody>
</table>

> - [https://akuity.io/blog/argo-cd-architectures-explained/:title]

<br>

以降の図の凡例です。

ArgoCDの各コンポーネント (application-controller、argocd-server、dex-server、repo-server) と各リソース (Application、AppProject) を区別しています。

![argocd_multi-tenant_legend](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_legend.png)

<br>

# 04-02. Clusters as-a-Service の実践

## 実Clusterテナント

実Clusterテナントは、Clusters as-a-Serviceなテナントの実践であり、実Clusterをテナントの単位とします。

後述の仮想Clusterと対比させるために、**"実Cluster"** と呼ぶことにします。

各プロダクトチームは、実Clusterテナント内のApplicationを操作し、正しいプロダクト用Clusterにマニフェストをデプロイします。

![argocd_multi-tenant_physical_cluster](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_physical_cluster.png)

<br>

## オススメしない理由

Clusters as-a-Serviceのメリデメも加えて、以下のメリデメがあります。

デメリットの回避策も考慮して、独断と偏見でオススメしませんでした。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                                                                        | デメリット **×**                                                                          |     | デメリットの回避策                                             |
| :---------------------------------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------- | --- | -------------------------------------------------------------- |
|               拡張性                | -                                                                                                                                                                  | テナントを増やすために実Clusterを用意する必要があり、作業量が多い。                       | ➡︎ | IaCツールで実Clusterを用意するようにすれば、作業量を減らせる。 |
|      安全性<br>(セキュリティ)       | 他のテナントからの通信を遮断できる。                                                                                                                               | -                                                                                         | ➡︎ | -                                                              |
|               保守性                | 他のテナントとClusterスコープまたはNamespacedスコープなKubernetesリソースを分離できる。<br>これらのKubernetesリソース (特にCRD) の変更が他のテナントに影響しない。 | 各テナントで実Clusterを継続的に保守しないといけない。(例：アップグレード、機能修正、など) | ➡︎ | 回避できなくてとてもつらい😭                                   |
|                性能                 | 他のテナントとClusterのハードウェアリソースを奪い合わずに、これを独占できる。                                                                                      | -                                                                                         | ➡︎ | -                                                              |
|               可用性                | テナントごとに実Clusterが独立しており、他の仮想Clusterから障害の影響を受けない。                                                                                   | -                                                                                         | ➡︎ | -                                                              |

<blockquote class="twitter-tweet tw-align-center" data-width="300"><p lang="ja" dir="ltr">半年以内にアップグレードしないとサポートが切れるKubernetesクラスターが33個もあって、泣いちゃった</p>&mdash; 長谷川 広樹 (俺です) (@Hiroki__IT) <a href="https://twitter.com/Hiroki__IT/status/1615710926489124865?ref_src=twsrc%5Etfw">January 18, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<br>

# 04-03. Control Planes as-a-Service の実践

## 仮想Clusterテナント - ★

仮想Clusterテナントは、Control Planes as-a-Serviceなテナントの実践であり、仮想Clusterをテナントの単位とします。

各プロダクトチームは、仮想Clusterテナント内のApplicationを操作し、正しいプロダクト用Clusterにマニフェストをデプロイします。

![argocd_multi-tenant_virtual_cluster](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_virtual_cluster.png)

> - [https://blog.argoproj.io/using-argo-cd-with-vclusters-5df53d1c51ce:title]

<br>

## オススメした理由

Control Planes as-a-Serviceのメリデメも加えて、以下のメリデメがあります。

デメリットの回避策も考慮して、独断と偏見で **<font color="#FF0000">オススメ</font>** しました。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                                                                        | デメリット **×**                                                                                       |     | デメリットの回避策                                                                       |
| :---------------------------------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------ | --- | ---------------------------------------------------------------------------------------- |
|               拡張性                | テナントを増やすためにマニフェストで定義した仮想Clusterを用意するだけでよく、実Clusterを用意することと比べて作業量が少ない。                                       | -                                                                                                      | ➡︎ | -                                                                                        |
|      安全性<br>(セキュリティ)       | -                                                                                                                                                                  | 他のテナントからの通信を遮断できない。                                                                 | ➡︎ | ArgoCDの操作に申請が必要な仕組みであれば、利用者を信頼できる。                           |
|               保守性                | 他のテナントとClusterスコープまたはNamespacedスコープなKubernetesリソースを分離できる。<br>これらのKubernetesリソース (特にCRD) の変更が他のテナントに影響しない。 | 各テナントで仮想Clusterを継続的に保守しないといけない<nobr>(例：アップグレード、機能修正、など)</nobr> | ➡︎ | 仮想Clusterに関する知見を持つ組織であれば、各テナントで保守できる。                      |
|                性能                 | -                                                                                                                                                                  | 他のテナントとClusterのハードウェアリソースを奪い合わないといけない。                                  | ➡︎ | 多くの利用者が同時並行的にArgoCDを操作する状況になりにくければ、奪い合いが起こりにくい。 |
|               可用性                | テナントごとに仮想Clusterが独立しており、他の仮想Clusterから障害の影響を受けない。                                                                                 | -                                                                                                      | ➡︎ | -                                                                                        |

<br>

# 04-04. Namespaces as-a-Service の実践

Namespaceテナントは、Namespaces as-a-Serviceなテナントの実践であり、Namespaceをテナントの単位とします。

後述の [Projectテナント](#04-05-ツール固有テナントの実践) は二重のテナントを持ち、Namespaceテナントも兼ねています。

そのため、ここではNamespaceテナントの解説は省略します。

<br>

# 04-05. ツール固有テナントの実践

## Projectテナント

Projectテナントは、ツール固有テナントの実践であり、NamespaceとAppProjectをテナントの単位とします。

すなわち、Projectテナントは二重のテナント (**<font color="#FF0000">第一テナントにNamespace</font>**、**<font color="#FF0000">第二テナントに複数のAppProject</font>**) を持ち、**"あらゆる面から"** マニフェストのデプロイを制限します。

AppProjectはNamespaceスコープなカスタムリソースであり、自身に所属するApplicationを一括して制限します。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: foo-tenant
  namespace: foo
  # 自身に所属するApplicationを制限する
spec: ...
```

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: infra-application
  namespace: foo
spec:
  # foo-tenantに所属する
  project: foo-tenant
  ...
```

> - [asin:B09WF3FDTG:title]
> - [https://argo-cd.readthedocs.io/en/stable/user-guide/projects/:title]

<br>

<div class="text-box">
カスタムリソースのCRDの実装から、ドキュメントに未記載の仕様を読み取れることがあります。
<br>
<br>
例えば、本記事ではAppProjectに自由にNamespaceを設定していますが、ArgoCDのドキュメントには任意のNamespaceを設定できることが明記されていません。
<br>
<br>
しかし、AppProjectのCRDの<code>.spec.scope</code>キーからも分かる通り、AppProjectはNamespacedスコープなカスタムリソースであり、任意のNamespaceを設定できます。

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  labels:
    app.kubernetes.io/name: appprojects.argoproj.io
    app.kubernetes.io/part-of: argocd
  name: appprojects.argoproj.io
spec:
  group: argoproj.io
  names:
    kind: AppProject

    ...

  # Namespacedスコープなカスタムリソースであるとわかる
  scope: Namespaced

...
```

<blockquote>
<ul>
  <li>[https://github.com/argoproj/argo-cd/blob/master/manifests/crds/appproject-crd.yaml:title]</li>
  <li>[https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/:title]</li>
</ul>
</blockquote>
</div>

<br>

## CLモード vs. NSモード

ArgoCDには、[Clusterスコープモード](#05-CLモードなArgoCD) と [Namespacedスコープモード](#05-02-NSモードなArgoCD---) (以降、**"CLモード"** と **"NSモード"**) があります。

スコープモードに応じて、Projectテナントの設計方法が異なります。

次の章からは、CLモードとNSモードの両方でProjectテナントを解説していきます。

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

<br>

# 05. CLモードなArgoCD

## CLモードなArgoCDとは

CLモードなArgoCDの場合、各テナント間で共有のArgoCDを管理します

CLモードなArgoCDは、全てのNamespaceのApplicationにアクセスできます。

例えば、Projectテナントとして、プロダクト別のNamespace (第一テナント) とプロダクトの実行環境別のAppProject (第二テナント) を用意します。

この時、ArgoCDは`argocd`というNamespaceに所属しています。

各プロダクトチームは、Projectテナント内のApplicationを操作し、正しいプロダクト用Clusterにマニフェストをデプロイします。

![argocd_multi-tenant_appproject_cluster-scope](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_cluster-scope.png)

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]
> - [https://medium.com/@geoffrey.muselli/argocd-multi-tenancy-strategy-94d72183c94:title]

### AppProject

NSモードと同様にして、AppProjectに所属するApplicationのマニフェストのデプロイを制限できます。

例えば、以下のようになります。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: foo-tenant
  namespace: foo
spec:
  destinations:
    # ArgoCD用Clusterに関する許可を設定する
    # App-Of-Appsパターンの場合に使用する
    - namespace: foo
      server: "https://kubernetes.default.svc"
    # プロダクト用Clusterに関する許可を設定する
    - namespace: "*"
      server: https://foo-cluster.gr7.ap-northeast-1.eks.amazonaws.com
  # CLモードでは設定が必要である
  sourceNamespaces:
    - foo
```

Applicationを操作するログインユーザーが、無許可なNamespaceやClusterをデプロイ先に指定できないように、`.spec.destination`キーで制限しています。

NSモードとの違いとして、`.spec.sourceNamespaces`キーの設定が必要です。

`.spec.sourceNamespaces`キーで、このAppProjectへの所属を許可したいApplicationのNamespaceを制限しています。

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]
> - [https://argo-cd.readthedocs.io/en/stable/user-guide/projects/:title]

### コンテナ引数用ConfigMap (`argocd-cmd-params-cm`)

NSモードと同様にして、`argocd-cmd-params-cm`では、ArgoCDの各コンポーネントのコンテナの引数を設定できます。

例えば、以下のようになります。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: foo
data:
  # CLモードでは設定が必要である
  application.namespaces: "*"
```

全てのNamespaceのApplicationにアクセスできるように、`--application-namespaces`オプションに`*` (アスタリスク) を設定しています。

NSモードとの違いとして、`.application.namespaces`キーで、argocd-serverとapplication-controllerがいずれのNamespaceのApplicationにアクセスできるかを設定する必要があります。

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

<div class="text-box">
<code>argocd-cmd-params-cm</code>の代わりに、例えば以下のようにPodに引数を直接渡しても良いです。
<br>
<br>
例えば、以下のようになります。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: argocd-server
  namespace: argocd
spec:
  containers:
    - name: argocd-server
      image: quay.io/argoproj/argocd:latest
      args:
        - /usr/local/bin/argocd-server
        # コンテナ起動時の引数として
        - --application-namespaces="*"

  ...
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: argocd-application-controller
  namespace: argocd
spec:
  containers:
    - name: argocd-application-controller
      image: quay.io/argoproj/argocd:latest
      args:
        - /usr/local/bin/argocd-application-controller
        # コンテナ起動時の引数として
        - --application-namespaces="*"

  ...
```

<blockquote>
<ul>
  <li>[https://argo-cd.readthedocs.io/en/stable/operator-manual/server-commands/argocd-application-controller/:title]</li>
  <li>[https://argo-cd.readthedocs.io/en/stable/operator-manual/server-commands/argocd-server/:title]</li>
</ul>
</blockquote>
</div>

### 認可用ConfigMap (`argocd-rbac-cm`)

NSモードと同様にして、`argocd-rbac-cm`では、Applicationを操作するログインユーザーが、無許可なAppProjectに所属するApplicationを操作できないように制限します。

例えば、以下のようになります。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  # デフォルトのロール
  # @see https://github.com/argoproj/argo-cd/blob/master/assets/builtin-policy.csv#L9-L16
  policy.default: role:readonly
  policy.csv: |
    p, role:foo, *, *, foo/*, allow
    p, role:bar, *, *, bar/*, allow
    p, role:baz, *, *, baz/*, allow

    g, foo-team, role:foo
    g, bar-team, role:bar
    g, baz-team, role:baz
  scopes: "[groups]"
```

認証済みのプロダクトチーム (foo-team、bar-team、baz-team) に対して、無許可のAppProject (foo、bar、baz) に所属するApplicationを操作できないように、認可スコープで制限しています。

<br>

<div class="text-box">
ConfigMap (argocd-rbac-cm) の認可スコープの定義には、 <a href="https://github.com/casbin/casbin">Casbin</a> の記法を使用します。
<br>
<br>
今回の実装例で使用した<code>p</code> (パーミッション) と<code>g</code> (グループ) では、以下を定義できます。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  policy.default: role:readonly
  policy.csv: |
    # ロールとArgoCD系カスタムリソースの認可スコープを定義する
    p, role:<ロール名>, <Kubernetesリソースの種類>, <アクション名>, <AppProject名>/<Kubernetesリソースの識別名>, <許否>

    # 認証済みグループにロールを紐付ける
    g, <グループ名>, role:<ロール名>
  scopes: "[groups]"
```

<blockquote>
<ul><li>[https://argo-cd.readthedocs.io/en/stable/operator-manual/rbac/:title]</li></ul>
</blockquote>
</div>
<br>

## オススメしない理由

CLモードなArgoCDのProjectテナントには、以下のメリデメがあります。

デメリットの回避策も考慮して、独断と偏見でオススメしませんでした。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                       | デメリット **×**                                                                                                                                                                                                                |     | デメリットの回避策                                                                                                                                             |
| :---------------------------------: | --------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|               拡張性                | テナントを増やすためにNamespaceとAppProjectを用意するだけでよく、作業量が少ない。 | -                                                                                                                                                                                                                               | ➡︎ | -                                                                                                                                                              |
|      安全性<br>(セキュリティ)       | -                                                                                 | 他のテナントからの通信を遮断できない。                                                                                                                                                                                          | ➡︎ | ArgoCDの利用のためにユーザー認証に申請が必要な仕組みであれば、利用者を信頼できる。                                                                             |
|               保守性                | 単一のClusterを保守すればよい。(例：アップグレード、機能修正、など)               | AppProjectはNamespacedスコープなカスタムリソースのため、他のテナントとClusterスコープなKubernetesリソースを共有しないといけない。<br>そのため、ClusterスコープなKubernetesリソース (特にCRD) の変更は全てのテナントに影響する。 | ➡︎ | ArgoCDのアップグレード時 (CRDの変更時) は、ついでにKubernetesもアップグレードしたい。<br>新しいClusterを別に作成し、そこで新ArgoCDを作成すれば一石二鳥である。 |
|                性能                 | -                                                                                 | 他のテナントとClusterのハードウェアリソースを奪い合わないといけない。                                                                                                                                                           | ➡︎ | 多くの利用者が同時並行的にArgoCDを操作する状況になりにくければ、奪い合いが起こりにくい。                                                                       |
|               可用性                | -                                                                                 | ClusterまたはArgoCDで障害が起こると、これは全てのテナントに影響する。                                                                                                                                                           | ➡︎ | NodeやArgoCDを十分に冗長化すれば回避できるが、影響範囲が大きすぎる😭                                                                                           |

<br>

# 05-02. NSモードなArgoCD - ★★

## NSモードなArgoCDとは

NSモードなArgoCDの場合、CLモードとは異なり、各Projectテナント間で独立したArgoCDを管理します。

NSモードなArgoCDは、自身が所属するNamespaceのApplicationのみにアクセスできます。

例えば、Projectテナントとして、プロダクト別のNamespace (第一テナント) とプロダクトの実行環境別のAppProject (第二テナント) を用意します。

各プロダクトチームは、Projectテナント内のApplicationを操作し、正しいプロダクト用Clusterにマニフェストをデプロイします。

![argocd_multi-tenant_appproject_namespaced-scope](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope.png)

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

### AppProject

CLモードと同様にして、AppProjectに所属するApplicationのマニフェストのデプロイを制限できます。
。

例えば、以下のようになります。

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: foo-tenant
  namespace: foo
spec:
  destinations:
    # ArgoCD用Clusterに関する許可を設定する
    # App-Of-Appsパターンの場合に使用する
    - namespace: foo
      server: "https://kubernetes.default.svc"
    # プロダクト用Clusterに関する許可を設定する
    - namespace: "*"
      server: https://foo-cluster.gr7.ap-northeast-1.eks.amazonaws.com
# NSモードでは設定が不要である
# sourceNamespaces:
#   - foo
```

Applicationを操作するログインユーザーが、無許可なNamespaceやClusterをデプロイ先に指定できないように、`.spec.destination`キーで制限しています。

CLモードとの違いとして、`.spec.sourceNamespaces`キー配下に設定は不要です。

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]
> - [https://argo-cd.readthedocs.io/en/stable/user-guide/projects/:title]

### コンテナ引数用ConfigMap (`argocd-cmd-params-cm`)

CLモードと同様にして、`argocd-cmd-params-cm`では、ArgoCDの各コンポーネントのコンテナの引数を設定できます。

例えば、以下のようになります。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: foo
data:
# NSモードでは設定が不要である
# application.namespaces: "*"
```

CLモードとの違いとして、`.application.namespaces`キーには何も設定しません。

つまり、NSモードの場合は、`argocd-cmd-params-cm`またはPodにコンテナ引数に設定は不要です。

> - [https://argo-cd.readthedocs.io/en/stable/operator-manual/app-any-namespace/:title]

### 認可用ConfigMap (`argocd-rbac-cm`)

CLモードと同様にして、`argocd-rbac-cm`では、ログインユーザーが無許可なProjectテナントに属するApplicationを操作できないようにします。

例えば、以下のようになります。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  # デフォルトのロール
  # @see https://github.com/argoproj/argo-cd/blob/master/assets/builtin-policy.csv#L9-L16
  policy.default: role:readonly
  policy.csv: |
    p, role:foo, *, *, foo/*, allow
    p, role:bar, *, *, bar/*, allow
    p, role:baz, *, *, baz/*, allow

    g, foo, role:foo
    g, bar, role:bar
    g, baz, role:baz
  scopes: "[groups]"
```

認証済みのプロダクトチーム (foo-team、bar-team、baz-team) に対して、無許可のAppProject (foo、bar、baz) に所属するApplicationを操作できないように、認可スコープで制限しています。

<br>

## 特にオススメした理由

NSモードなArgoCDのProjectテナントには、以下のメリデメがあります。

デメリットの回避策も考慮して、独断と偏見で **<font color="#FF0000">特にオススメ</font>** しました。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                       | デメリット **×**                                                                                                                                                                                                                |     | デメリットの回避策                                                                                                                                             |
| :---------------------------------: | --------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|               拡張性                | テナントを増やすためにNamespaceとAppProjectを用意するだけでよく、作業量が少ない。 | -                                                                                                                                                                                                                               | ➡︎ | -                                                                                                                                                              |
|      安全性<br>(セキュリティ)       | -                                                                                 | 他のテナントからの通信を遮断できない。                                                                                                                                                                                          | ➡︎ | ArgoCDの操作に申請が必要な仕組みであれば、利用者を信頼できる。                                                                                                 |
|               保守性                | 単一のClusterを保守すればよい。<nobr>(例：アップグレード、機能修正、など)</nobr>  | AppProjectはNamespacedスコープなカスタムリソースのため、他のテナントとClusterスコープなKubernetesリソースを共有しないといけない。<br>そのため、ClusterスコープなKubernetesリソース (特にCRD) の変更は全てのテナントに影響する。 | ➡︎ | ArgoCDのアップグレード時 (CRDの変更時) は、ついでにKubernetesもアップグレードしたい。<br>新しいClusterを別に作成し、そこで新ArgoCDを作成すれば一石二鳥である。 |
|                性能                 | -                                                                                 | 他のテナントとClusterのハードウェアリソースを奪い合わないといけない。                                                                                                                                                           | ➡︎ | 多くの利用者が同時並行的にArgoCDを操作する状況になりにくければ、奪い合いが起こりにくい。                                                                       |
|               可用性                | テナントごとにArgoCDが独立しており、他のArgoCDから障害の影響を受けない。          | Clusterで障害が起こると、これは全てのテナントに影響する。                                                                                                                                                                       | ➡︎ | Nodeを十分に冗長化すれば、いずれかのインスタンスで障害が起こっても、正常なインスタンスでArgoCDが稼働できる。                                                   |

<br>

## Projectテナント例

NSモードなArgoCDを採用する場合、Projectテナント例を解説していきます。

前述の通り、Projectテナントが二重テナント (第一テナントにNamespace、第二テナントに複数のAppProject) を持つことに留意してください。

なお、オススメするものを ★ としています。

<table>
  <thead>
  <tr>
    <th rowspan="2" style="text-align: center;"></th>
    <th colspan="2" style="text-align: center;">テナントの組み合わせ</th>
    <th rowspan="2" style="text-align: center;">オススメ</th>
  </tr>
  <tr>
    <th style="text-align: center;">Namespace<br>(第一テナント)</th>
    <th style="text-align: center;">AppProject<br>(第二テナント)</th>
  </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center;">パターン1</td>
      <td style="text-align: center;">プロダクトの実行環境別</td>
      <td style="text-align: center;">プロダクトの実行環境別</td>
      <td style="text-align: center;"></td>
    </tr>
    <tr>
      <td style="text-align: center;">パターン2</td>
      <td style="text-align: center;">プロダクト別</td>
      <td style="text-align: center;">プロダクトの実行環境別</td>
      <td style="text-align: center;">★</td>
    </tr>
    <tr>
      <td style="text-align: center;">パターン3</td>
      <td style="text-align: center;">プロダクト別</td>
      <td style="text-align: center;">プロダクトのサブチーム別</td>
      <td style="text-align: center;">★★</td>
    </tr>
  </tbody>
</table>

<br>

<div class="text-box">
本記事では言及しませんが、Namespaceにはいくつかの分割パターンがあり、本記事ではこれも取り入れてProjectテナントを設計しています。
<br>
<br>
例えば、<b>"チーム別"</b> というNamespaceの分割パターンは、様々な著名な書籍やブログで紹介されています👍
<blockquote>
<ul>
  <li>[https://www.amazon.co.jp/dp/1617293725:title]</li>
  <li>[https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-organizing-with-namespaces?hl=en:title]</li>
</ul>
</blockquote>
</div>

<br>

### パターン1

#### ▼ NamespaceとAppProjectの組み合わせ方

プロダクトの実行環境 (Dev、Tes) 別に管理されたClusterがいる状況と仮定します。

この場合に、プロダクトの実行環境別にNamespace (第一テナント) とAppProject (第二テナント) を用意します。

![argocd_multi-tenant_appproject_namespaced-scope_pattern_1](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_pattern_1.png)

#### ▼ オススメしなかった理由

パターン1には、以下のメリデメがあります。

独断と偏見でオススメしませんでした。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                                          | デメリット **×**                                                                                                                          |     | デメリットの回避策                                                                        |
| :---------------------------------: | ------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------- | --- | ----------------------------------------------------------------------------------------- |
|               拡張性                | -                                                                                                                                    | ArgoCDのPod数が多くなり、将来的にNode当たりのPodやIPアドレスの上限数にひっかかりやすい。<br>その時点で、Projectテナントの増やせなくなる。 | ➡︎ | 例えばAWS EKSの場合、Node数を増やしたり、Nodeのスペックを上げる。<br>ただ、お金がかかる😭 |
|      安全性<br>(セキュリティ)       | 認可用ConfigMap (`argocd-rbac-cm`) を使用すれば、無許可の実行環境AppProjectに所属するApplicationを操作できないように制限できる。     | -                                                                                                                                         | ➡︎ | -                                                                                         |
|               保守性                | 異なる実行環境に関するApplicationが共存しておらず、別のargocd-serverから操作することになるため、実行環境間の選択ミスが起こりにくい。 | -                                                                                                                                         | ➡︎ | -                                                                                         |

### パターン2

#### ▼ NamespaceとAppProjectの組み合わせ方

プロダクトの実行環境 (Dev、Tes) 別に管理されたClusterがいる状況と仮定します。

プロダクト別にNamespace (第一テナント) 、プロダクトの実行環境別にAppProject (第二テナント) を用意します。

![argocd_multi-tenant_appproject_namespaced-scope_pattern_2](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_pattern_2.png)

#### ▼ オススメした理由

パターン2には、以下のメリデメがあります。

独断と偏見で **<font color="#FF0000">オススメ</font>** しました。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                 | デメリット **×**                                                                                                                                     |     | デメリットの回避策                                                                  |
| :---------------------------------: | ----------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | --- | ----------------------------------------------------------------------------------- |
|               拡張性                | ArgoCDのPod数が多くなり、将来的にNode当たりのPodやIPアドレスの上限数にひっかかりにくい。                    | -                                                                                                                                                    | ➡︎ | -                                                                                   |
|      安全性<br>(セキュリティ)       | 認可用ConfigMap (`argocd-rbac-cm`) を使用すれば、無許可の実行環境AppProjectを操作できないように制限できる。 | -                                                                                                                                                    | ➡︎ | -                                                                                   |
|               保守性                | -                                                                                                           | 異なる実行環境に関するApplicationが共存しており、同じargocd-server (ダッシュボード) から操作することになるため、実行環境間の選択ミスが起こりやすい。 | ➡︎ | ダッシュボードにはApplicationのフィルタリング機能があるため、選択ミスを回避できる。 |

### パターン3

#### ▼ NamespaceとAppProjectの組み合わせ方

プロダクトの実行環境 (Dev、Tes) 別に管理されたClusterがいる状況と仮定します。

プロダクト別にNamespace (第一テナント) 、プロダクトのサブチーム別にAppProject (第二テナント) を用意します。

![argocd_multi-tenant_appproject_namespaced-scope_pattern_3](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_pattern_3.png)

#### ▼ 特にオススメした理由

パターン3には、以下のメリデメがあります。

独断と偏見で **<font color="#FF0000">特にオススメ</font>** しました。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット ⭕️                                                                                                                        | デメリット **×**                                                                                                                                     |     | デメリットの回避策                                                                  |
| :---------------------------------: | ---------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | --- | ----------------------------------------------------------------------------------- |
|               拡張性                | ArgoCDのPod数が多くなり、将来的にNode当たりのPodやIPアドレスの上限数にひっかかりにくい。                                           | -                                                                                                                                                    | ➡︎ | -                                                                                   |
|      安全性<br>(セキュリティ)       | 認可用ConfigMap (`argocd-rbac-cm`) を使用すれば、無許可のサブチームAppProjectに所属するApplicationを操作できないように制限できる。 | -                                                                                                                                                    | ➡︎ | -                                                                                   |
|               保守性                | -                                                                                                                                  | 異なる実行環境に関するApplicationが共存しており、同じargocd-server (ダッシュボード) から操作することになるため、実行環境間の選択ミスが起こりやすい。 | ➡︎ | ダッシュボードにはApplicationのフィルタリング機能があるため、選択ミスを回避できる。 |

<br>

# 06. Projectテナントのデプロイ制限の仕組み

そろそろ解説を読むのがしんどい方がいるのではないでしょうか。

『君がッ、泣くまで、解説をやめないッ！』

ここでは、前述の **"パターン3"** を採用したと仮定します。

Projectテナントがマニフェストのデプロイをどのように制限するのかについて、エラー例を挙げて解説します⚠️

<br>

## マニフェストのデプロイ制限

Projectテナントは、ログインユーザーが無許可なNamespaceやClusterにマニフェストをデプロイすることを制限します。

![argocd_multi-tenant_appproject_namespaced-scope_argocd-server](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_argocd-server.png)

### エラーが起こらない場合

(1) argocd-serverは、`argocd-cmd-params-cm`から自分自身のNamespaceの認可スコープを取得します。

(2) fooプロダクトチームのinfraチームが、argocd-serverを操作します。

(3) argocd-serverは、`argocd-rbac-cm`からfooプロダクトチームのArgoCD系カスタムリソースに対する認可スコープを取得します

(4) infraチームは、テナント内で許可されたApplicationを操作します。

(5) infraチームは、fooプロダクト用のdev Clusterの`infra`というNamespaceにマニフェストをデプロイします。

### (エラー例1) 無許可なNamespaceでApplicationを作成しようとした場合

例えば、fooプロダクトチームが無許可なNamespace (例：`bar`) でApplicationを作成しようとします。

すると、argocd-serverは以下のようなエラーを返却します

```sh
namespace bar is not permitted in project 'infra-team'
```

無許可なNamespaceでApplicationを作れてしまうと、そのApplicationから誤ったプロダクト用Clusterにマニフェストをデプロイできてしまいます😈

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/test/e2e/app_management_ns_test.go#L2465-L2484:title]

### (エラー例2) 無許可なAppProjectでApplicationを作成しようとした場合

もし、fooプロダクトチームが無許可なAppProject (例：`bar-team`) でApplicationを作成しようとします。

すると、argocd-serverは以下のようなエラーを返却します。

```sh
Application referencing project 'bar-team' which does not exist
```

任意のAppProjectでApplicationを作成できてしまうと、そのApplicationから誤ったプロダクト用Clusterにマニフェストをデプロイできてしまいます😈

### (エラー例3) 誤ったプロダクト用Clusterを指定しようとした場合

このエラー例では、テナント内のApplicationからはデプロイ先として選ぶべきではないClusterを、デプロイ先に指定します。

例えば、fooプロダクトチームがApplicationで誤ったプロダクト用Cluster (例：`bar-cluster`) をデプロイ先として指定しようします。

すると、argocd-serverは以下のようなエラーを返却します。

```sh
application destination
{https://bar-cluster.gr7.ap-northeast-1.eks.amazonaws.com infra} is not permitted in project 'infra-team'
```

任意のClusterをデプロイ先に指定できてしまうと、Applicationから誤ったプロダクト用Clusterにマニフェストをデプロイできてしまいます😈

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/util/argo/argo_test.go#L679-L710:title]

### (エラー例4) 無許可なNamespaceをデプロイ先に指定しようとした場合

最後のエラーは、やや変化球です。

このエラー例では、テナント内のApplicationからはデプロイ先として選ぶべきではないNamespaceを、デプロイ先に指定します。

例えば、fooプロダクトチームが、Applicationで無許可なNamespace (例：`app`) をデプロイ先に指定しようします。

すると、argocd-serverは以下のようなエラーを返却します。

```sh
application destination
{https://foo-cluster.gr7.ap-northeast-1.eks.amazonaws.com app} is not permitted in project 'infra-team'
```

任意のNamespaceをデプロイ先に指定できてしまうと、そのApplicationから誤ったNamespaceにマニフェストをデプロイできてしまいます😈

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/util/argo/argo_test.go#L679-L710:title]

<br>

## 無許可テナントへのReconciliation制限

Projectテナントは、application-controllerが無許可な空間 (Namespace、AppProject) 内にReconciliationすることを制限します。

![argocd_multi-tenant_appproject_namespaced-scope_application-controller](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_application-controller.png)

### エラーが起こらない場合

(1) application-controllerは、`argocd-cmd-params-cm`から自分自身のNamespaceの認可スコープを取得します。

(2) application-controllerは、同じNamespaceに所属するArgoCD系カスタムリソースに対して、Reconciliationを実行します。

### (エラー例1)

例えば、application-controllerが、無許可な空間に所属するArgoCD系カスタムリソースに対してReconciliationを実行しようとします。

すると、application-controllerはこれを検証し、Reconciliationの実行を回避しようとします。

> - [https://github.com/argoproj/argo-cd/blob/v2.7.10/controller/appcontroller_test.go#L1517-L1543:title]

<br>

<div class="text-box">
Projectテナントは、その他にも、例えば以下のようなアクセスを制限できます。
<br>
<br>
<b>"Projectテナントのマニフェストデプロイの制限"</b> という観点でテーマが異なるため、本記事では言及しませんでした。
<ul>
  <li>application-controllerがデプロイするKubernetesリソース (`.spec.clusterResourceWhitelist`キー、`.spec.namespaceResourceWhitelist`キー)</li>
  <li>repo-serverがポーリングするリポジトリ (`.spec.sourceRepos`キー)</li>
</ul>

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: foo-tenant
  namespace: foo
spec:
  clusterResourceWhitelist:
    - group: "*"
      kind: "*"
  namespaceResourceWhitelist:
    - group: "*"
      kind: "*"
  sourceRepos:
    - "*"

  ...
```

<blockquote>
<ul>
  <li>[https://argo-cd.readthedocs.io/en/stable/user-guide/projects/:title]</li>
  <li>[https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/#projects:title]</li>
</ul>
</blockquote>
</div>

<br>

# 07. おわりに

KubernetesのマルチテナントパターンとArgoCDでのテナントパターンの実践をもりもり布教しました。

情報を詰め込みすぎた感があります。

KubernetesのマルチテナントパターンをArgoCDでどう実践するべきかに困っている組織の助けになれば幸いです👍

<br>

# 謝辞

本記事のタイトルは、私が入信しているドメイン駆動設計の書籍 **"[isbn:479813161X:title]"** から拝借しました🙏🙏🙏

また、ArgoCDでのテナントパターンの収集にあたり、以下の方からの意見も参考にさせていただきました。

- [`@toversus26`](https://twitter.com/toversus26) さん

この場で感謝申し上げます🙇🏻‍

<br>
