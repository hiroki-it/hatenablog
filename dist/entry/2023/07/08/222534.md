---
Title: 【ArgoCD🐙️】Kubernetesのマルチテナント設計とArgoCDのテナントパターン
Category:
  - ArgoCD
  - Kubernetes
  - ソフトウェアアーキテクチャ
  - 認証/認可
Date: 2023-07-08T22:25:34+09:00
URL: https://hiroki-hasegawa.hatenablog.jp/entry/2023/07/08/222534
EditURL: https://blog.hatena.ne.jp/hiroki-hasegawa/hiroki-hasegawa.hatenablog.jp/atom/entry/820878482948228657
Draft: true
---

<br>

[:contents]

<br>

# この記事から得られる知識

この記事を読むと、以下を『完全に理解』できます✌️

- Applicationを分離する目的と、マルチテナントパターンについて
- マルチテナント間の認可について

<br>

# 01. はじめに

<br>

<figure><img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_community-board.png" alt="argocd_community-board"><figcaption>画像引用元：<a href="https://github.com/argoproj">Argo Project</a></figcaption></figure>

<br>

Argoくんへの愛ゆえに思います。

3DのArgoくん、まあまあキモいんだが...😂

さて最近の業務で、全プロダクトの技術基盤開発チームに携わっており、全プロダクト共有のArgoCD🐙のApplicationのマルチテナント化を担当しました。

今回は、この時に整理したKubernetesのマルチテナント設計とArgoCDのテナントパターンを記事で解説しました。

それでは、もりもり布教していきます😗

<div class="text-box">
記事中のこのボックスは、補足情報を記載しています。
<br>
<br>
飛ばしていただいても大丈夫ですが、読んでもらえるとより理解が深まるはずです👍
</div>

<br>

# 02. なぜApplicationにマルチテナントが必要なのか

## シングルテナントの場合

そもそも、なぜApplicationのマルチテナントが必要なのでしょうか。

マニフェストのデプロイ先となるプロダクト用Clusterがいくつかある状況を想像してみてください。

単一のテナント内に各プロダクト用のApplicationを共存させると、単一のArgoCDダッシュボードから全てのApplicationを操作できて便利です。

ただし、Applicationやプロダクトの数が増えていくにつれて、問題が起こり始めます。

例えば、ArgoCDを使用したマニフェストのデプロイ時に、デプロイ作業者のヒューマンエラー (例：Applicationの選択ミス) が起こる可能性があります。

![argocd_single-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_single-tenant.png)

<br>

## マルチテナントの場合

一方で、いい感じのマルチテナントにしたとします。

マニフェストのデプロイ作業者は、選択したテナントに属するApplicationを選べるようになります。

また、認可を設計することにより、許可されていないApplicationの操作を禁止し、マニフェストの不正なデプロイを防ぐことができます。

![argocd_multi-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant.png)

<br>

# 03. Kubernetesにおけるマルチテナント

ArgoCDのためのマルチテナントの前に、Kubernetesではマルチテナントをどのように実現するのかを簡単に整理しておきます。

『ソフトマルチテナンシー』と『ハードマルチテナンシー』に大別できます。

## ソフトマルチテナンシー

### ソフトマルチテナンシーとは

テナントは互いに信頼できる前提の上で、テナント間を弱く分離するマルチテナントです。

> - [asin:B072TS9ZQZ:title]
> - [https://aws.github.io/aws-eks-best-practices/security/docs/multitenancy/#soft-multi-tenancy:title]

<br>

## ハードマルチテナンシー

### ハードマルチテナンシーとは

テナントは互いに信頼できない前提の上で、テナント間を強く分離するマルチテナントです。

> - [asin:B072TS9ZQZ:title]
> - [https://aws.github.io/aws-eks-best-practices/security/docs/multitenancy/#hard-multi-tenancy:title]

<br>

# 03. ArgoCDのためのマルチテナントパターン

## 概要

いよいよ、ArgoCDのためのマルチテナントパターンを説明していきます。

ArgoCDの場合、何をテナントの単位とすればよさそうでしょうか。

ここでは、私が検討したマルチテナントパターンをいくつか紹介します。

<table>
  <thead>
    <tr>
      <th rowspan="2">マルチ<br><nobr>テナンシー</nobr><br>モデル</th>
      <th rowspan="2">テナント<br>パターン</th>
      <th rowspan="2">テナントの単位</th>
      <th colspan="2" style="text-align: center;"><nobr>テナント間のリソース分離</nobr><br>(分離できていれば <code>⭕️</code> )</th>
      <th rowspan="2" style="text-align: center;"><nobr>採用</nobr></th>
    </tr>
    <tr>
      <th style="text-align: center;"><nobr>Namespacedスコープ</nobr><br>リソース</th>
      <th style="text-align: center;"><nobr>Clusterスコープ</nobr><br>リソース</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ハード</td>
      <td>実Cluster<br>テナント</td>
      <td>実際のCluster</td>
      <td style="text-align: center;"><code>⭕️</code></td>
      <td style="text-align: center;"><code>⭕️</code></td>
      <td></td>
    </tr>
    <tr>
      <td rowspan="3">ソフト</td>
      <td>仮想Cluster<br>テナント</td>
      <td>プロダクト共有Cluster上の仮想Cluster</td>
      <td style="text-align: center;"><code>⭕️</code></td>
      <td style="text-align: center;"><code>⭕️</code></td>
      <td></td>
    </tr>
    <tr>
      <td>Namespace<br>テナント</td>
      <td>プロダクト共有Cluster上のNamespace</td>
      <td style="text-align: center;"><code>⭕️</code></td>
      <td></td>
      <td style="text-align: center;">✅</td>
    </tr>
    <tr>
      <td>AppProject<br>テナント</td>
      <td>プロダクト共有Cluster上のAppProject</td>
      <td style="text-align: center;"><code>⭕️</code></td>
      <td></td>
      <td></td>
    </tr>
  </tbody>
</table>

<br>

## 凡例

図の中で使用している凡例の説明です。

ArgoCDの各コンポーネント (repo-server、application-controler) と各リソース (Application、AppProject) を区別しています。

![argocd_multi-tenant_legend](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_legend.png)

<br>

# 04. ハードマルチテナンシーの場合

## 実Clusterテナント

### 実Clusterテナントとは

後述の仮想Clusterと対比させるために、『実Cluster』と呼ぶことにします。

実Clusterテナントでは、デプロイ先のプロダクト用Clusterごとに実Clusterを作成します。

この時の実Clusterをテナントの単位とします。

![argocd_multi-tenant_physical_cluster](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_physical_cluster.png)

### 採用せず...

実Clusterテナントには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット                                                   | デメリット                                                                          |
| :---------------------------------: | ---------------------------------------------------------- | ----------------------------------------------------------------------------------- |
|               安全性                | テナント間の通信を制限できるため、安全性が高い。           | -                                                                                   |
|               保守性                | -                                                          | 複数のClusterを継続的に保守 (例：アップグレード、機能修正、など) しないといけない。 |
|                性能                 | 他のテナントのハードウェアリソース消費量の影響を受けない。 | -                                                                                   |

実Clusterテナント間では、各実Cluster上のKubernetesリソースを全く共有しません。

つまり、これはArgoCDの各コンポーネントとApplicationの両方を分離します。

そのため、ClusterスコープなKubernetesリソース (例：ArgoCD系カスタムリソースのCRD) 間を完全に分離でき、各ArgoCDは対応するプロダクトのみにデプロイの責務を持つことになります。

一番の致命的なデメリットがCluster数がむやみに増えることであり、運用保守が "とてもつらい" ため、採用しませんでした。

<blockquote class="twitter-tweet tw-align-center" data-width="300"><p lang="ja" dir="ltr">半年以内にアップグレードしないとサポートが切れるKubernetesクラスターが33個もあって、泣いちゃった</p>&mdash; 長谷川 広樹 (俺です) (@Hiroki__IT) <a href="https://twitter.com/Hiroki__IT/status/1615710926489124865?ref_src=twsrc%5Etfw">January 18, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<br>

## 仮想Clusterテナント

### 仮想Clusterテナントとは

仮想Clusterテナントでは、プロダクト共有Cluster上に仮想Clusterを作成し、各仮想Cluster上でArgoCDを動かします。

この時の仮想Clusterをテナントの単位とします。

仮想Clusterのプロビジョニングツールとして、例えば [vcluster](https://github.com/loft-sh/vcluster) があります。

![argocd_multi-tenant_virtual_cluster](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_virtual_cluster.png)

> - [https://blog.argoproj.io/using-argo-cd-with-vclusters-5df53d1c51ce:title]

### 採用せず...

仮想Clusterテナントには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット | デメリット                                                                        |
| :---------------------------------: | -------- | --------------------------------------------------------------------------------- |
|               安全性                | -        | -                                                                                 |
|               保守性                | -        | 仮想Clusterを継続的に保守 (例：アップグレード、機能修正、など) しないといけない。 |
|                性能                 | -        | -                                                                                 |

仮想Clusterテナント間では、ホストClusterのKubernetesリソースを共有しますが、各仮想Cluster上のそれは共有しません。

つまり、これはArgoCDの各コンポーネントとApplicationの両方を分離します。

そのため、実Clusterテナントのよいところ (ClusterスコープなKubernetesリソースの分離) を享受しつつ、また実Clusterが増えなくてよいです。

しかし、仮想Cluster自体が増えてしまうことと、技術的に発展途上で運用保守の難易度が高くなってしまいます。

そのため、採用しませんでした。

<br>

# 05. ソフトマルチテナンシーの場合

## Namespaceテナント

### Namespaceテナントとは

Namespaceテナントでは、プロダクト共有Cluster上にプロダクト別のNamespaceを作成し、各Namespace内にのみ認可スコープを持つArgoCDを動かします。

また、各Namespaceにプロダクト用ClusterごとのAppProjectを作成します。

この時のNamespaceをテナントの単位とします。

ArgoCDの『Namespacedスコープモード』を有効化し、各Namespace内にArgoCDを動かします。

![argocd_multi-tenant_namespace](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_namespace.png)

### 採用!!

Namespaceテナントには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット | デメリット |
| :---------------------------------: | -------- | ---------- |
|               安全性                | -        | -          |
|               保守性                | -        | -          |
|                性能                 | -        | -          |

Namespaceテナント間では、ClusterスコープなKubernetesリソース (例：ArgoCD系カスタムリソースのCRD) を共有しますが、Applicationは共有しません。

つまり、これはArgoCDの各コンポーネントとApplicationの両方を分離できます。

そのため、実Clusterテナントのメリットを享受しつつ、また実Clusterが増えなくてよいです。

前述の通り、私の状況ではArgoCDでデプロイしなければならないプロダクトの数が非常に多く、各ArgoCDの影響範囲がプロダクトに限定できます。

そのため、**<font color="#FF0000">採用になりました</font>**。

<br>

## AppProjectテナント

### AppProjectテナントとは

AppProjectテナントでは、プロダクト共有Cluster上にプロダクト別のNamespaceを作成し、Cluster全体に認可スコープを持つ単一のArgoCDを動かします。

また、各Namespaceにプロダクト用ClusterごとのAppProjectを作成します。

この時のAppProjectをテナントの単位とします。

ArgoCDの『Clusterスコープモード』を有効化し、Cluster内に単一のArgoCDを動かします。

![argocd_multi-tenant_appproject](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject.png)

### 採用せず...

AppProjectテナントには、以下のメリデメがあります。

| <nobr>アーキテクチャ</nobr><br>特性 | メリット | デメリット |
| :---------------------------------: | -------- | ---------- |
|               安全性                | -        | -          |
|               保守性                | -        | -          |
|                性能                 | -        | -          |

AppProjectテナント間では、ClusterのKubernetesリソースを共有しますが、AppProject内のApplicationは共有しません。

つまり、これはApplicationのみを分離できます。

そのため、実Clusterテナントのよいところ (ClusterスコープなKubernetesリソースの分離) を享受しつつ、また実Clusterが増えなくてよいです。

また、単一のArgoCDを運用保守しさせすればよいので、ハッピーになれます。

しかし私の状況では、単一のArgoCDでデプロイしなければならないプロダクトの数が非常に多く、単一のArgoCDの影響範囲がプロダクト全体に渡ってしまうため、採用しませんでした。

単一のArgoCDがデプロイするべきプロダクト数が少ない状況であれば、採用する価値があります。

<br>

# 06. ArgoCDのためのNamespaceの粒度

## 概要

それでは、Namespaceテナントを採用する場合に、Namespaceをどのような粒度で作成するべきなのかを考えていきましょう。

一般的に、Namespaceには以下のような粒度例があります。

<table>
<thead>
  <tr>
    <th>Namespaceの粒度</th><th>採用</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>実行環境別</td><td></td>
  </tr>
  <tr>
    <td>チーム別</td><td style="text-align: center;"><code>⭕️</code></td>
  </tr>
</tbody>
</table>

> - [asin:1617293725:title]

<br>

## プロダクトの実行環境別

### プロダクトの実行環境別とは

例えば、プロダクトごとに異なるチームがいると仮定します。

また、ArgoCDのデプロイ対象のプロダクトが複数おり、プロダクトの実行環境 (Tes環境、Stg環境) 別にClusterがいるとします。

この時、プロダクトの実行環境別にNamespaceを作成します。

![argocd_multi-tenant_namespace_product-environments](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_namespace_product-environments.png)

### 採用せず...

プロダクトの実行環境別では、粒度が細かすぎるとし、将来的に問題が起こることを予想できました。

例えば、Cluster上にArgoCDが増えすぎてIPアドレスが枯渇することや、ArgoCDが増えた分だけ運用が大変になることです。

そのため、採用しませんでした。

<br>

## プロダクトのチーム別

### プロダクトのチーム別とは

同様にして、プロダクトごとに異なるチームがおり、プロダクトの実行環境 (Tes環境、Stg環境) 別にClusterがいると仮定します。

この時、プロダクトチーム別にNamespaceを作成します。

![argocd_multi-tenant_namespace_products](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_namespace_products.png)

### 採用!!

単一のClusterで全プロダクト用の各ArgoCDを運用する必要がありました。

そこで、**<font color="#FF0000">採用になりました</font>**。

<br>

# 07. Namespaceテナントのマルチテナントの仕組み

Namespaceテナントのマルチテナントを採用した場合、ArgoCD上でどのようなことが起こるのか、その仕組みとNamespacedスコープモードの設定方法を説明していきます。

なおこの仕組みを理解する上で、ArgoCDの特に "argocd-server" "application-controller" "dex-server" の責務を知る必要があります。

これらのコンポーネントついて、今回は簡単にしか説明していません😢

詳しく知りたい方は、以下の記事で全体像を紹介してますので、よろしくどうぞ🙇🏻‍♂️

[https://hiroki-hasegawa.hatenablog.jp/entry/2023/05/02/145115:embed]

<br>

## 概要

![argocd_multi-tenant_namespace_overview](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_namespace_overview.png)

ArgoCD用Clusterがあり、ここで動いているArgoCDは、dev環境とstg環境のプロダクト用Clusterにマニフェストをデプロイします。

Cluster上には、Namespace (`foo`、`bar`、`baz`) があります。

### (1) プロダクト用Cluster管理者のログイン

プロダクトチームは、SSOでargocd-serverにログインします。

### (2) argocd-serverによる認可スコープ制御

argocd-serverは、プロダクトチームのApplicationの認可スコープを制御します。

なお各プロダクトのArgoCDのApplicationは、プロダクトの実行環境別のClusterに対応しています。

### (3) application-controllerによるマニフェストデプロイ

プロダクトチームは、各Namespace上のArgoCD (application-controller) を介して、担当するClusterにのみマニフェストをデプロイできます。

<br>

## argocd-server

わかりやすいように、Namespaceの`foo`のみに着目します。

まず、argocd-serverです。

Namespaceテナントの場合、argocd-serverの『Namespacedスコープモード』を有効化します。

![argocd_multi-tenant_namespace_argocd-server](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_namespace_argocd-server.png)

### (1) プロダクトチームのログイン

プロダクトチームがダッシュボード (argocd-server) にSSOを使用してログインしようとします。

### (2) IDプロバイダーへの認証フェーズ委譲

argocd-serverは、認証フェーズをIDプロバイダーに委譲するために、dex-serverをコールします。

### (3) dex-serverによる認可リクエスト作成

dex-serverは、認可リクエストを作成します。

### (4) dex-serverによる認可リクエスト送信

dex-serverは、前の手順で作成した認可リクエストをIDプロバイダーに送信します。

### (5) IDプロバイダーによる認証フェーズ実施

IDプロバイダー側でSSOの認証フェーズを実施します。

IDプロバイダーは、コールバックURL (`<ArgoCDのドメイン名>/api/dex/callback`) を指定して、認可レスポンスを送信します。

### (6) argocd-serverによる認可フェーズ実施

認可レスポンスは、argocd-serverを介して、dex-serverに届きます。

ConfigMap (argocd-rbac-cm) を参照し、IDプロバイダーから取得したユーザーやグループに、ArgoCD系カスタムリソースに関する認可スコープを付与します。

ここでは、developerロールにはdevというAppProjectに属するArgoCD系カスタムリソースにのみ、またmaintainerロールには全てのAppProjectの操作を許可しています。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
data:
  # デフォルトのロール
  policy.default: role:readonly
  policy.csv: |
    # ロールとArgoCD系カスタムリソースの認可スコープを定義する
    p, role:foo-product, *, *, tes/*, allow
    p, role:foo-product, *, *, stg/*, allow

    # グループにロールを紐付ける
    g, developers, role:foo-product
  scopes: "[groups]"
```

<br>

## application-controller

わかりやすいように、argocd-serverの説明と同様にNamespaceの`foo`のみに着目します。

Namespaceテナントの場合、argocd-serverと同様にapplication-controllerの『Namespacedスコープモード』を有効化します。

![argocd_multi-tenant_namespace_application-controller](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_namespace_application-controller.png)

### (1)

...

### (2)

...

### (3)

...

<br>

# 08. おわりに

Kubernetesのマルチテナント設計とArgoCDのテナントパターンをもりもり布教しました。

ArgoCDを使用している場合、デプロイ先のプロダクトが多くなるにつれて、必ずと言っていいほどマルチテナントは必要になってくるのでないかと思います。

ArgoCDのマルチテナント化に困っている組織の助けになれば幸いです👍

<br>

# 謝辞

ArgoCDのマルチテナントパターンの収集にあたり、以下の方に有益なプラクティスをご教授いただきました。

- [`@toversus26`](https://twitter.com/toversus26) さん

この場で感謝申し上げます🙇🏻‍

<br>
