---
Title: ã€TerraformğŸ§‘ğŸ»â€ğŸš€ã€‘Terraformã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³
Category:
  - AWS
  - Terraform
Date: 2023-07-02T00:00:00+09:00
URL: https://hiroki-hasegawa.hatenablog.jp/entry/2023/07/01/180257
EditURL: https://blog.hatena.ne.jp/hiroki-hasegawa/hiroki-hasegawa.hatenablog.jp/atom/entry/820878482946298820
Draft: true
---

<br>

[:contents]

<br>

# 01. ã¯ã˜ã‚ã«

<br>

![terraform_icon.png](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_icon.png)

<br>

å‰ä¸–ã§å¾³ã‚’ç©ã‚“ã§ã€Mitchell Hashimoto ã¨ã—ã¦ç”Ÿã¾ã‚ŒãŸã‹ã£ãŸ...

ã•ã¦æœ€è¿‘ã®æ¥­å‹™ã§ã€å…¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®æŠ€è¡“åŸºç›¤é–‹ç™ºãƒãƒ¼ãƒ ã«æºã‚ã£ã¦ãŠã‚Šã€ãƒãƒ¼ãƒ ãŒä½¿ã£ã¦ã„ã‚‹TerraformğŸ§‘ğŸ»â€ğŸš€ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒªãƒ—ãƒ¬ã‚¤ã‚¹ã™ã‚‹ä½œæ¥­ã‚’æ‹…å½“ã—ã¾ã—ãŸã€‚

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã§ã¯å˜ä¸€ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒçŠ¶æ…‹ã‚’æŒã¡éãã¦ã„ã‚‹èª²é¡Œã‚’æŠ±ãˆã¦ã„ãŸãŸã‚ã€èª²é¡Œã«åˆã£ãŸé©åˆ‡ãªåˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒªãƒ—ãƒ¬ã‚¤ã‚¹ã—ã¾ã—ãŸã€‚

ä»Šå›ã¯ã€ã“ã®æ™‚ã«æ•´ç†ã—ãŸåˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨˜äº‹ã§ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ãªãŠã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ä¸­ã§ã‚‚AWSå‘ã‘ã®èª¬æ˜ã¨ãªã£ã¦ã—ã¾ã†ã“ã¨ã‚’ã”å®¹èµ¦ãã ã•ã„ã€‚

ãã‚Œã§ã¯ã€ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¦ã„ãã¾ã™ğŸ˜—

<div class="text-box">
è¨˜äº‹ä¸­ã®ã“ã®ãƒœãƒƒã‚¯ã‚¹ã¯ã€è£œè¶³æƒ…å ±ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚
<br>
<br>
é£›ã°ã—ã¦ã„ãŸã ã„ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ãŒã€èª­ã‚“ã§ã‚‚ã‚‰ãˆã‚‹ã¨ã‚ˆã‚Šç†è§£ãŒæ·±ã¾ã‚‹ã¯ãšã§ã™ğŸ‘
</div>

<br>

# 02. ãªãœtfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã™ã‚‹ã®ã‹

### åˆ†å‰²ã—ã¦ã„ãªã„å ´åˆ

ãã‚‚ãã‚‚ã€ãªãœ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã™ã‚‹å¿…è¦ãªã®ã§ã—ã‚‡ã†ã‹ã€‚

æ§˜ã€…ãªã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å˜ä¸€ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã§çŠ¶æ…‹ã‚’æŒã¤ã¨ã€1å›ã®`terraform`ã‚³ãƒãƒ³ãƒ‰å…¨ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çŠ¶æ…‹ã‚’æ“ä½œã§ãã¦æ¥½ã§ã™ã€‚

ãŸã ã—ã€è¤‡æ•°ã®ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚‹çŠ¶æ³ã ã¨ç…©ã‚ã—ã„ã“ã¨ãŒèµ·ã“ã‚Šã¾ã™ã€‚

å„ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çŠ¶æ…‹ã‚’å¤‰æ›´ã—ã‹ã‘ã¦ã„ã‚‹ã¨ã€`terraform`ã‚³ãƒãƒ³ãƒ‰ã§`target`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

![terraform_architecture_same-tfstate](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_same-tfstate.png)

### åˆ†å‰²ã—ã¦ã„ã‚‹å ´åˆ

ä¸€æ–¹ã§ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã„ã„æ„Ÿã˜ã«åˆ†å‰²ã—ãŸã¨ã—ã¾ã™ã€‚

å„ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã§ã¯ã€ã¾ã‚‹ã§æš—é»™çš„ã«`target`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã¤ã„ãŸã‚ˆã†ã«ã€ä»–ã®ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã®å½±éŸ¿ã‚’å—ã‘ãšã«`terraform`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

ã‚ˆã£ã¦ã€å„`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†è€…ã¯äº’ã„ã«å½±éŸ¿ã‚’å—ã‘ãšã«ã€Terraformã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![terraform_architecture_different-tfstate](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate.png)

> - [isbn:1492046906:title]
> - [https://cloudcasts.io/course/terraform/organizing-with-multiple-states:title]

<br>

# 03. tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²

## åˆ†å‰²ã®å¢ƒç›®

ãã‚Œã§ã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã®å¢ƒç•Œã¯ã©ã®ã‚ˆã†ã«ã—ã¦è¦‹ã¤ã‘ã‚Œã°ã‚ˆã„ã®ã§ã—ã‚‡ã†ã‹ã€‚

ã“ã‚Œã‚’è¦‹ã¤ã‘ã‚‹ã‚³ãƒ„ã¯ã€ã€ä»–ã®çŠ¶æ…‹ã«ã§ãã‚‹ã ã‘ä¾å­˜ã—ãªã„ãƒªã‚½ãƒ¼ã‚¹ã®é–¢ä¿‚ã€ã«æ³¨ç›®ã™ã‚‹ã“ã¨ã ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

ã“ã“ã§ã„ã†ä¾å­˜ã¨ã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒä»–ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚

<div class="text-box">
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆã®æ–‡è„ˆã§ã¯ã€ä»–ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ã€ä¾å­˜ã€ã¨è¡¨ç¾ã—ã¾ã™ã€‚
<br>
<br>
ãã®ãŸã‚ä¾¿å®œä¸Šã€<code>tfstate</code>ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ã€ä¾å­˜ã€ã¨è¡¨ç¾ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
</div>

<br>

## çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³

### ä¾å­˜é–¢ä¿‚å›³ã¨ã¯

åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«é–“ã®çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚ã‚’è¡¨ç¾ã—ãŸå›³ã§ã™ã€‚

ã“ã‚Œã¯ä¸€èˆ¬çš„ãªå›³ã§ã¯ãªãã€(ãŠãã‚‰ã) ç§ãŒå‹æ‰‹ã«è€ƒãˆãŸå›³ã§ã™ã€‚

### ä¾å­˜é–¢ä¿‚ã®è¡¨ç¾

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«é–“ã§çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹å ´åˆã€ã“ã‚Œã‚’å›³ã§è¡¨ç¾ã™ã‚‹ã¨åˆ†å‰²ã®çŠ¶æ³ãŒã‚ã‹ã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚

ã€ä¾å­˜ã€ã¯ã€`--->` (æ³¢ç·šçŸ¢å°) ã§è¡¨ç¾ã™ã‚‹ã“ã¨ã¨ã—ã¾ã™ã€‚

è¨­å®šå€¤ã®å‚ç…§æ•°ãŒå°‘ãªã„ã»ã©ã‚ˆã„ã§ã™ã€‚

<div class="text-box">
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆã®æ–‡è„ˆã§ã¯ã€ã€ä¾å­˜ã€ã‚’<code>---></code> (æ³¢ç·šçŸ¢å°) ã§è¡¨ç¾ã—ã¾ã™ã€‚
<br>
<br>
ãã®ãŸã‚ä¾¿å®œä¸Šã€<code>tfstate</code>ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ã€ä¾å­˜ã€ã¨è¡¨ç¾ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
</div>

#### â–¼ ä¾å­˜é–¢ä¿‚ãŒãªã„å ´åˆ

ä¾‹ãˆã°ã€AWSãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰ãªã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’ã„ãã¤ã‹ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ« (`foo-tfstate`ã€`bar-tfstate`ã€`baz-tfstate`) ã«åˆ†å‰²ã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚

ã“ã“ã§ä»®å®šã—ãŸçŠ¶æ³ã§ã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«é–“ã«ä¾å­˜é–¢ä¿‚ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ãã®ãŸã‚ã€æƒ³å®šã•ã‚Œã‚‹çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![terraform_architecture_different-tfstate_independent](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_independent.png)

<div hidden>

```mermaid
---
title: tfstateãƒ•ã‚¡ã‚¤ãƒ«é–“ã«ä¾å­˜é–¢ä¿‚ã¯ãªã„
---
%%{init:{'theme':'default'}}%%
flowchart TB
    subgraph AWS
        foo["foo-tfstate"]
        bar["bar-tfstate"]
    end
```

</div>

#### â–¼ ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹å ´åˆ

åŒæ§˜ã«åˆ†å‰²ã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚

ã“ã“ã§ä»®å®šã—ãŸçŠ¶æ³ã§ã¯ã€`foo-tfstate` â¡ï¸ `bar-tfstate` ã®æ–¹å‘ã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã€`--->` (æ³¢ç·šçŸ¢å°) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ãã®ãŸã‚ã€æƒ³å®šã•ã‚Œã‚‹çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![terraform_architecture_different-tfstate_dependent](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_dependent.png)

<div hidden>

```mermaid
---
title: foo-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€bar-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜
---
%%{init:{'theme':'default'}}%%
flowchart TD
    subgraph AWS
        foo["foo-tfstate"]
        bar["bar-tfstate"]
    end
    foo -. ä¾å­˜ .-> bar
```

</div>

<br>

# 04. `tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ããã®ä»–ã®è¨­è¨ˆ

## ãƒªãƒã‚¸ãƒˆãƒª ğŸ­ ã®è¨­è¨ˆ

### ãƒªãƒã‚¸ãƒˆãƒªåˆ†å‰²

ãƒªãƒã‚¸ãƒˆãƒªè‡ªä½“ã®åˆ†å‰²ã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã—ã‚‡ã†ã€‚

åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã£ã¦ã¯ã€ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãŠã„ãŸæ–¹ãŒè‰¯ã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

```sh
ğŸ­ foo-repository/
â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo/terraform.tfstate
...
```

```sh
ğŸ­ bar-repository/
â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar/terraform.tfstate
...
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª ğŸ“‚ æ§‹æˆ

ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚‚ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã—ã‚‡ã†ã€‚

ç‡ç›´ã«è¨€ã†ã¨ã€Terraformã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ç„¡æ•°ã«ã‚ã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€**<font color="#FF0000">ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆè‡ªä½“ã®è¨­è¨ˆãŒæœ¬è³ªçš„ã§ã¯ãªã„</font>** ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

ä¸€æ–¹ã§ã€ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦è¨­è¨ˆã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€æ„ç¾©ã®ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦æŠ½å‡ºã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```sh
ğŸ­ repository/
â”œâ”€â”€ ğŸ“‚ foo/
â”‚    â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo/terraform.tfstate
â”‚    ...
â”‚
â””â”€â”€ ğŸ“‚ bar/
      â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar/terraform.tfstate
      ...
```

<br>

## ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ğŸª£ ã®è¨­è¨ˆ

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åˆ†å‰²

æœ¬è¨˜äº‹ã§ã¯ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦AWS S3ãƒã‚±ãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®åˆ†å‰²ã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã—ã‚‡ã†ã€‚

åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã£ã¦ã¯ã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãŠã„ãŸæ–¹ãŒè‰¯ã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

```sh
ğŸª£ foo-bucket/
â”‚
â””â”€â”€ terraform.tfstate
```

```sh
ğŸª£ bar-bucket/
â”‚
â””â”€â”€ terraform.tfstate
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚‚ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã—ã‚‡ã†ã€‚

```sh
ğŸª£ bucket/
â”œâ”€â”€ ğŸ“‚ foo/
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ ğŸ“‚ bar/
      â””â”€â”€ terraform.tfstate
```

<br>

# 05. çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚ã®å®šç¾©æ–¹æ³•

## terraform_remote_stateãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ

### terraform_remote_stateãƒ–ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹ä¾å­˜

**<font color="#FF0000">æœ¬è¨˜äº‹ã§ã¯ã€`terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦çŠ¶æ…‹ä¾å­˜é–¢ä¿‚ã‚’å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚</font>**

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒä»–ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ã€`terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã™ã€‚

`terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

- ä¾å­˜å…ˆã®AWSãƒªã‚½ãƒ¼ã‚¹ã«é–¢ã‚ã‚‰ãšã€åŒã˜`terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ã„å›ã™ã“ã¨ãŒã§ãã‚‹

ä¸€æ–¹ã§ã€ä»¥ä¸‹ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

- åˆ¥é€”`output`ãƒ–ãƒ­ãƒƒã‚¯ã®å®šç¾©ãŒå¿…è¦ã«ãªã‚Šã€å¯èª­æ€§ãŒä½ããªã‚‹ã€‚
- ä¾å­˜å…ˆã¨ä¾å­˜å…ƒã®é–“ã§Terraformã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å·®ãŒã‚ã‚Šã™ãã‚‹ã¨ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«é–“ã§äº’æ›æ€§ãŒãªããªã‚Šã€`terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ã§çŠ¶æ…‹ã«ä¾å­˜ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

> [https://developer.hashicorp.com/terraform/language/state/remote-state-data:title]

### çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³

ä¾‹ãˆã°ã€AWSãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰ãªã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’ã„ãã¤ã‹ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ« (`foo-tfstate`ã€`bar-tfstate`) ã«åˆ†å‰²ã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚

ã“ã“ã§ä»®å®šã—ãŸçŠ¶æ³ã§ã¯ã€`bar-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã¯VPCã®çŠ¶æ…‹ã‚’æŒã£ã¦ãŠã‚Šã€`foo-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã¯`bar-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€æƒ³å®šã•ã‚Œã‚‹çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![terraform_architecture_different-tfstate_dependent_terraform-remote-state](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_dependent_terraform-remote-state.png)

<div hidden>

```mermaid
---
title: terraform_remote_stateãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ãŸä¾å­˜é–¢ä¿‚
---
%%{init:{'theme':'default'}}%%
flowchart TD
    subgraph bucket
        foo["foo-tfstate"]
        bar["bar-tfstate"]
    end
    foo -. VPCã®çŠ¶æ…‹ã«ä¾å­˜ .-> bar
```

</div>

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
ğŸ­ repository/
â”œâ”€â”€ ğŸ“‚ foo/
â”‚    â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo/terraform.tfstate
â”‚    â”œâ”€â”€ remote_state.tf # terraform_remote_stateãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã€bar-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ provider.tf
â”‚    ...
â”‚
â””â”€â”€ ğŸ“‚ bar/
      â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar/terraform.tfstate
      â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
      â”œâ”€â”€ provider.tf
      ...
```

`foo-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒ`bar-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹ãŸã‚ã«å¿…è¦ãªå®Ÿè£…ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```terraform
# fooãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã¯ã€bar-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã§æŒã¤
resource "example" "foo" {

  # fooãƒªã‚½ãƒ¼ã‚¹ã¯ã€bar-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®VPCã«ä¾å­˜ã™ã‚‹
  vpc_id = data.terraform_remote_state.bar.outputs.bar_vpc_id

  ...
}

# VPCã®çŠ¶æ…‹ã¯ã€bar-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã§æŒã¤
data "terraform_remote_state" "bar" {

  backend = "s3"

  config = {
    bucket = "bar-tfstate"
    key    = "bar/terraform.tfstate"
    region = "ap-northeast-1"
  }
}
```

```terraform
# VPCã®çŠ¶æ…‹ã¯ã€bar-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã§æŒã¤
output "bar_vpc_id" {
  value = aws_vpc.bar.id
}

resource "aws_vpc" "bar" {
  ...
}
```

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
ğŸª£ bucket/
â”œâ”€â”€ ğŸ“‚ foo
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ ğŸ“‚ bar
      â””â”€â”€ terraform.tfstate
```

<br>

## dataãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ

### dataãƒ–ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹ä¾å­˜ã¨ã¯

ä¾å­˜é–¢ä¿‚ã®å®šç¾©æ–¹æ³•ã¨ã—ã¦ã€`data`ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã™ã€‚

`data`ãƒ–ãƒ­ãƒƒã‚¯ã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªèº«ä»¥å¤– (ä¾‹ï¼šã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã€ä»–ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«) ã§ä½œæˆã•ã‚ŒãŸAWSãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã«ä¾å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚

`data`ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

- `output`ãƒ–ãƒ­ãƒƒã‚¯ãŒä¸è¦ã§å¯èª­æ€§ãŒé«˜ã„ã€‚

ä¸€æ–¹ã§ä»¥ä¸‹ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

- ä¾å­˜å…ˆã®AWSãƒªã‚½ãƒ¼ã‚¹ã”ã¨ã«`data`ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

`terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ã¨ã¯ç•°ãªã‚Šã€ç›´æ¥çš„ã«ã¯`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã—ã¾ã›ã‚“ã€‚

`data`ãƒ–ãƒ­ãƒƒã‚¯ã®å ´åˆã¯ã€å®Ÿéš›ã®AWSãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã«ä¾å­˜ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€é–“æ¥çš„ã«AWSãƒªã‚½ãƒ¼ã‚¹ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

> [https://developer.hashicorp.com/terraform/language/data-sources:title]


### çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³

ä¾‹ãˆã°ã€`data`ãƒ–ãƒ­ãƒƒã‚¯ã‚‚åŒæ§˜ã«ã—ã¦ã€AWSãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰ãªã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’ã„ãã¤ã‹ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ« (`foo-tfstate`ã€`bar-tfstate`) ã«åˆ†å‰²ã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚

ã“ã“ã§ä»®å®šã—ãŸçŠ¶æ³ã§ã¯ã€`bar-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã¯VPCã®çŠ¶æ…‹ã‚’æŒã£ã¦ãŠã‚Šã€`foo-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã¯`bar-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚

æƒ³å®šã•ã‚Œã‚‹çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![terraform_architecture_different-tfstate_dependent_data](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_dependent_data.png)

<div hidden>

```mermaid
---
title: dataãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ãŸä¾å­˜é–¢ä¿‚
---
%%{init:{'theme':'default'}}%%
flowchart TD
    subgraph bucket
        foo["foo-tfstate"]
        bar["bar-tfstate"]
    end
    foo -. VPCã®çŠ¶æ…‹ã«ä¾å­˜ .-> bar
```

</div>

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
ğŸ­ repository/
â”œâ”€â”€ ğŸ“‚ foo/
â”‚    â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo/terraform.tfstate
â”‚    â”œâ”€â”€ data.tf # dataãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã€bar-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ provider.tf
â”‚    ...
â”‚
â””â”€â”€ ğŸ“‚ bar/
      â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar/terraform.tfstate
      â”œâ”€â”€ provider.tf
      ...
```

`foo-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒ`bar-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹ãŸã‚ã«å¿…è¦ãªå®Ÿè£…ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```terraform
# fooãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã¯ã€foo-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã§æŒã¤
resource "example" "foo" {

  # fooãƒªã‚½ãƒ¼ã‚¹ã¯ã€bar-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®VPCã«ä¾å­˜ã™ã‚‹
  vpc_id     = data.aws_vpc.bar.id
}

# VPCã®çŠ¶æ…‹ã¯ã€bar-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã§æŒã¤
data "aws_vpc" "bar" {

  filter {
    name   = "tag:Name"
    values = ["<bar-tfstateãŒæŒã¤VPCã®åå‰>"]
  }
}
```

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
ğŸª£ bucket/
â”œâ”€â”€ ğŸ“‚ foo
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ ğŸ“‚ bar
      â””â”€â”€ terraform.tfstate
```

<br>

# 06. åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³

## ä¸€è¦§

å‰è¿°ã®é€šã‚Šã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã®å¢ƒç•Œã¯ã€ã€ä»–ã®çŠ¶æ…‹ã«ã§ãã‚‹ã ã‘ä¾å­˜ã—ãªã„ãƒªã‚½ãƒ¼ã‚¹ã®é–¢ä¿‚ã€ã‹ã‚‰è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»Šå›ã¯ã€ç§ãŒè€ƒãˆã‚‹åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã„ãã¤ã‹ç´¹ä»‹ã—ã¾ã™ã€‚

ãªãŠã€å…¨ã¦ãŒå®Ÿç”¨çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã„ã†ã‚ã‘ã§ãªã„ã®ã§ã€ãŠã™ã™ã‚ã™ã‚‹ã‚‚ã®ã‚’ `â­•ï¸` ã¨ã—ã¦ã„ã¾ã™ã€‚

<table>
<thead>
  <tr>
    <th>å¿…é ˆ<br>/<br>ä»»æ„</th><th>tfstateãƒ•ã‚¡ã‚¤ãƒ«<br>åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³</th><th>å½±éŸ¿ã™ã‚‹<br>ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ</th><th>ãƒ‘ã‚¿ãƒ¼ãƒ³</th><th>ãŠã™ã™ã‚</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td rowspan="2">å¿…é ˆ</td><td>ä¸Šå±¤</td><td>ãƒªãƒã‚¸ãƒˆãƒªã¾ãŸã¯ä¸Šå±¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</td><td>ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥</td><td align=center><code>â­•ï¸</code></td>
  </tr>
  <tr>
    <td>ä¸‹å±¤</td><td>ä¸‹å±¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</td><td>å®Ÿè¡Œç’°å¢ƒåˆ¥</td><td align=center><code>â­•ï¸</code></td>
  </tr>
  <tr>
    <td rowspan="6">ä»»æ„</td><td rowspan="6">ä¸­é–“å±¤</td><td rowspan="6">ä¸­é–“å±¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</td><td>åŒã˜ãƒ†ãƒŠãƒ³ãƒˆå†…ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¥</td><td></td>
  </tr>
  <tr>
    <td>é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥</td><td align=center><code>â­•ï¸</code></td>
  </tr>
  <tr>
    <td>ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥</td><td align=center><code>â­•ï¸</code></td>
  </tr>
  <tr>
    <td>AWSãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥</td><td></td>
  </tr>
  <tr>
    <td>AWSãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã®å¤‰æ›´é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥</td><td></td>
  </tr>
  <tr>
    <td>é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ã¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã®çµ„ã¿åˆã‚ã›</td><td align=center><code>â­•ï¸</code></td>
  </tr>
</tbody>
</table>

<br>

## å„å±¤ã¨ãƒªãƒã‚¸ãƒˆãƒª/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã®å¯¾å¿œ

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€é«˜/ä¸­é–“/ä½ ã®å±¤ã«å¤§åˆ¥ã§ãã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®å±¤ã¯ã€ä»¥ä¸‹ã®é€šã‚Šãƒªãƒã‚¸ãƒˆãƒªã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã®è¨­è¨ˆæ–¹æ³•ã«å½±éŸ¿ã—ã¾ã™ã€‚

```sh
# ä¸Šå±¤ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ãŒãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ
ğŸ­ ä¸Šå±¤/
â”œâ”€â”€ ğŸ“‚ ä¸­é–“å±¤/
â”‚    â”œâ”€â”€ ğŸ“‚ ä¸‹å±¤/
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®terraform.tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
â”‚    â”‚    ...
â”‚    â”‚
...
```

```sh
# ä¸Šå±¤ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ãŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å ´åˆ
ğŸ­ ãƒªãƒã‚¸ãƒˆãƒª/
â”œâ”€â”€ ğŸ“‚ ä¸Šå±¤/
â”‚    â”œâ”€â”€ ğŸ“‚ ä¸­é–“å±¤/
â”‚    â”‚    â”œâ”€â”€ ğŸ“‚ ä¸‹å±¤/
â”‚    â”‚    â”‚    â”œâ”€â”€ backend.tfvars # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®terraform.tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
â”‚    â”‚    â”‚    ...
â”‚    â”‚    â”‚
...
```

<br>

# 07. ä¸Šå±¤ã®åˆ†å‰² (å¿…é ˆ)

## ä¸Šå±¤ã®åˆ†å‰²ã«ã¤ã„ã¦

ä¸Šå±¤ã®åˆ†å‰²ã¯ **<font color="#FF0000">å¿…é ˆ</font>** ã§ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ã¦åˆ†å‰²ã—ã€ã“ã‚Œã«åŸºã¥ã„ã¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚„ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚‚è¨­è¨ˆã—ã¾ã—ã‚‡ã†ã€‚

<br>

## ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥

### ã“ã®åˆ†å‰²æ–¹æ³•ã«ã¤ã„ã¦

ä¸Šå±¤åˆ†å‰²ã®ä¸­ã§ã‚‚ã€åŸºæœ¬çš„ãªæ–¹æ³•ã®1ã¤ã§ã™ã€‚

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (AWSã€GoogleCloudã€Azure) ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã€ä¸Šå±¤ã‚‚ã“ã‚Œã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã™ã€‚

ã“ã®åˆ†å‰²æ–¹æ³•ã«ã‚ˆã‚Šã€å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ç®¡ç†è€…ãŒäº’ã„ã«å½±éŸ¿ã‚’å—ã‘ãšã«ã€Terraformã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ãŸã„çŠ¶æ³ã¨ä»®å®šã—ã¾ã™ã€‚

- ä¸»è¦ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (AWS)
- ã‚¢ãƒ—ãƒª/ã‚¤ãƒ³ãƒ•ãƒ©ç›£è¦–ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (Datadogã€ãªã©)
- ã‚¸ãƒ§ãƒ–ç›£è¦–ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (Healthchecks)
- ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (PagerDuty)

ã“ã“ã§ä»®å®šã—ãŸçŠ¶æ³ã§ã¯ã€å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«é–“ã§çŠ¶æ…‹ã®ç›¸äº’ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

ãã®ãŸã‚ã€æƒ³å®šã•ã‚Œã‚‹çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![terraform_architecture_different-tfstate_provider-accounts](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_provider-accounts.png)

<div hidden>

```mermaid
---
title: ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥
---
%%{init:{'theme':'default'}}%%
flowchart LR
    subgraph PagerDuty
        pagerDuty["tfstate"]
    end
    subgraph Healthchecks
        healthchecks["tfstate"]
    end
    subgraph Datadog
        datadog["tfstate"]
    end
    subgraph AWS
        aws["tfstate"]
    end
    aws -...-> datadog
    aws -...-> healthchecks
    aws -...-> pagerDuty
    datadog -...-> aws
    healthchecks -...-> aws
    pagerDuty -...-> aws
```

</div>

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
ğŸ­ aws-repository/
â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®AWSç”¨terraform.tfstate
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”œâ”€â”€ provider.tf
...
```

```sh
ğŸ­ datadog-repository/
â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®Datadogç”¨terraform.tfstate
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”œâ”€â”€ provider.tf
...
```

```sh
ğŸ­ healthchecks-repository/
â”œâ”€â”€ backend.tf # Healthchecksç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®terraform.tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”œâ”€â”€ provider.tf
...
```

```sh
ğŸ­ pagerduty-repository/
â”œâ”€â”€ backend.tf # PagerDutyç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®terraform.tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”œâ”€â”€ provider.tf
...
```

#### â–¼ åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
ğŸ­ repository/
â”œâ”€â”€ ğŸ“‚ aws/
â”‚    â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®AWSç”¨terraform.tfstate
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ provider.tf
â”‚    ...
â”‚
â”œâ”€â”€ ğŸ“‚ datadog/
â”‚    â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®Datadogç”¨terraform.tfstate
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ provider.tf
â”‚    ...
â”‚
â”œâ”€â”€ ğŸ“‚ healthchecks/
â”‚    â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®Healthchecksç”¨terraform.tfstate
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ provider.tf
â”‚    ...
â”‚
â””â”€â”€ ğŸ“‚ pagerduty/
      â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®PagerDutyç”¨terraform.tfstate
      â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
      â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹****
      â”œâ”€â”€ provider.tf
      ...
```

<br>

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
ğŸª£ aws-bucket/
â”‚
â””â”€â”€ terraform.tfstate # AWSã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
ğŸª£ datadog-bucket/
â”‚
â””â”€â”€ terraform.tfstate # Datadogã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
ğŸª£ healthchecks-bucket/
â”‚
â””â”€â”€ terraform.tfstate # Healthchecksã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
ğŸª£ pagerduty-bucket/
â”‚
â””â”€â”€ terraform.tfstate # PagerDutyã®çŠ¶æ…‹ã‚’æŒã¤
```

#### â–¼ åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
ğŸª£ bucket/
â”œâ”€â”€ ğŸ“‚ aws
â”‚    â””â”€â”€ terraform.tfstate # AWSã®çŠ¶æ…‹ã‚’æŒã¤
â”‚
â”œâ”€â”€ ğŸ“‚ datadog
â”‚    â””â”€â”€ terraform.tfstate # Datadogã®çŠ¶æ…‹ã‚’æŒã¤
â”‚
â”œâ”€â”€ ğŸ“‚ healthchecks
â”‚    â””â”€â”€ terraform.tfstate # Healthchecksã®çŠ¶æ…‹ã‚’æŒã¤
â”‚
â””â”€â”€ ğŸ“‚ pagerduty
      â””â”€â”€ terraform.tfstate # PagerDutyã®çŠ¶æ…‹ã‚’æŒã¤
```

<br>

# 08. ä¸‹å±¤ã®åˆ†å‰² (å¿…é ˆ)

## ä¸‹å±¤ã®åˆ†å‰²ã«ã¤ã„ã¦

ä¸‹å±¤ã®åˆ†å‰²ã¯ **<font color="#FF0000">å¿…é ˆ</font>** ã§ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ã¦åˆ†å‰²ã—ã€ã“ã‚Œã«åŸºã¥ã„ã¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚„ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚‚è¨­è¨ˆã—ã¾ã—ã‚‡ã†ã€‚

<br>

## å®Ÿè¡Œç’°å¢ƒåˆ¥

### ã“ã®åˆ†å‰²æ–¹æ³•ã«ã¤ã„ã¦

ä¸‹å±¤åˆ†å‰²ã®ä¸­ã§ã‚‚ã€åŸºæœ¬çš„ãªæ–¹æ³•ã®1ã¤ã§ã™ã€‚

å®Ÿè¡Œç’°å¢ƒåˆ¥ (`tes`ã€`stg`ã€`prd`ç’°å¢ƒãªã©) ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã€ä¸‹å±¤ã‚‚ã“ã‚Œã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã™ã€‚

ã“ã®åˆ†å‰²æ–¹æ³•ã«ã‚ˆã‚Šã€å„å®Ÿè¡Œç’°å¢ƒã®ç®¡ç†è€…ãŒäº’ã„ã«å½±éŸ¿ã‚’å—ã‘ãšã«ã€Terraformã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

<div class="text-box">
ã“ã®åˆ†å‰²æ–¹æ³•ã¯ã€æ§˜ã€…ãªãƒ–ãƒ­ã‚°ã‚„è‘—åãªæ›¸ç±ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
<br>
<br>
ç§ã‚’å«ã‚ã€ã»ã¨ã‚“ã©ã®æ–¹ã«æ¡ç”¨ã®çµŒé¨“ãŒã‚ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
</div>

> - [isbn:1098116747:title]
> - [https://blog.gruntwork.io/how-to-manage-terraform-state-28f5697e68fa:title]

### çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®å®Ÿè¡Œç’°å¢ƒã‚’æ§‹ç¯‰ã—ãŸã„çŠ¶æ³ã¨ä»®å®šã—ã¾ã™ã€‚

- `tes` (æ¤œè¨¼ç’°å¢ƒ)
- `stg` (ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ)
- `prd` (æœ¬ç•ªç’°å¢ƒ)

ã‹ã¤ã€ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ãŸã„çŠ¶æ³ã¨ä»®å®šã—ã¾ã™ã€‚

- ä¸»è¦ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (AWS)
- ã‚¢ãƒ—ãƒª/ã‚¤ãƒ³ãƒ•ãƒ©ç›£è¦–ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (datadogã€ãªã©)
- ã‚¸ãƒ§ãƒ–ç›£è¦–ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (Healthchecks)
- ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (PagerDuty)

ã“ã“ã§ä»®å®šã—ãŸçŠ¶æ³ã§ã¯ã€å„å®Ÿè¡Œç’°å¢ƒã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»–ã®å®Ÿè¡Œç’°å¢ƒã«ã¯ä¾å­˜ã—ã¦ã„ãªã„ã¨ã—ã¾ã™ã€‚

ãã®ãŸã‚ã€æƒ³å®šã•ã‚Œã‚‹çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![terraform_architecture_different-tfstate_environments](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_environments.png)

<div hidden>

```mermaid
---
title: å®Ÿè¡Œç’°å¢ƒåˆ¥
---
%%{init:{'theme':'default'}}%%
flowchart LR
    subgraph PagerDuty
        pagerDuty["tfstate"]
    end
    subgraph Healthchecks
        healthchecks["tfstate"]
    end
    subgraph Datadog
        datadog["tfstate"]
    end
    subgraph AWS
        subgraph tes-bucket
            tes["tfstate"]
        end
        subgraph stg-bucket
            stg["tfstate"]
        end
        subgraph prd-bucket
            prd["tfstate"]
        end
    end
    tes -...-> datadog
    tes -...-> healthchecks
    tes -...-> pagerDuty
    datadog -...-> tes
    healthchecks -...-> tes
    pagerDuty -...-> tes
```

</div>

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã™ã‚‹ã“ã¨ã¯å¿…é ˆã¨ã—ã¦ã„ã‚‹ãŸã‚ã€ãã®ä¸Šã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’è€ƒãˆã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
ğŸ­ aws-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”œâ”€â”€ backend.tfvars # AWSç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®terraform.tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
â”‚    ...
â”‚
â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
```

```sh
ğŸ­ datadog-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ ğŸ“‚ tes/
â”œâ”€â”€ ğŸ“‚ stg/
â””â”€â”€ ğŸ“‚ prd/
```

```sh
ğŸ­ healthchecks-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ ğŸ“‚ tes/
â”œâ”€â”€ ğŸ“‚ stg/
â””â”€â”€ ğŸ“‚ prd/
```

```sh
ğŸ­ pagerduty-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ ğŸ“‚ tes/
â”œâ”€â”€ ğŸ“‚ stg/
â””â”€â”€ ğŸ“‚ prd/
```

#### â–¼ åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã™ã‚‹ã“ã¨ã¯å¿…é ˆã¨ã—ã¦ã„ã‚‹ãŸã‚ã€ãã®ä¸Šã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’è€ƒãˆã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
ğŸ­ repository/
â”œâ”€â”€ ğŸ“‚ aws/
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # AWSç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®terraform.tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚
â”œâ”€â”€ ğŸ“‚ datadog/
â”‚    â”œâ”€â”€ ğŸ“‚ tes/
â”‚    â”œâ”€â”€ ğŸ“‚ stg/
â”‚    â””â”€â”€ ğŸ“‚ prd/
â”‚
â”œâ”€â”€ ğŸ“‚ healthchecks/
â”‚    â”œâ”€â”€ ğŸ“‚ tes/
â”‚    â”œâ”€â”€ ğŸ“‚ stg/
â”‚    â””â”€â”€ ğŸ“‚ prd/
â”‚
â””â”€â”€ ğŸ“‚ pagerduty/
      â”œâ”€â”€ ğŸ“‚ tes/
      â”œâ”€â”€ ğŸ“‚ stg/
      â””â”€â”€ ğŸ“‚ prd/

```

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

å®Ÿè¡Œç’°å¢ƒåˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ä¾‹ãˆã°ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
ğŸª£ tes-aws-bucket/
â”‚
â””â”€â”€ terraform.tfstate # AWSã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
ğŸª£ tes-datadog-bucket/
â”‚
â””â”€â”€ terraform.tfstate # Datadogã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
ğŸª£ tes-healthchecks-bucket/
â”‚
â””â”€â”€ terraform.tfstate # Healthchecksã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
ğŸª£ tes-pagerduty-bucket/
â”‚
â””â”€â”€ terraform.tfstate # PagerDutyã®çŠ¶æ…‹ã‚’æŒã¤
```

#### â–¼ åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ x AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã”ã¨ç•°ãªã‚‹å®Ÿè¡Œç’°å¢ƒ ã®å ´åˆ

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

ã¾ãŸã€AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã”ã¨ã«ç•°ãªã‚‹å®Ÿè¡Œç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹ã¨ä»®å®šã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
# tesç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ tes-bucket/
â”œâ”€â”€ ğŸ“‚ aws/
â”‚    â””â”€â”€ terraform.tfstate # AWSã®çŠ¶æ…‹ã‚’æŒã¤
â”‚
â”œâ”€â”€ ğŸ“‚ datadog/
â”‚    â””â”€â”€ terraform.tfstate # Datadogã®çŠ¶æ…‹ã‚’æŒã¤
â”‚
â”œâ”€â”€ ğŸ“‚ healthchecks/
â”‚    â””â”€â”€ terraform.tfstate # Healthchecksã®çŠ¶æ…‹ã‚’æŒã¤
â”‚
â””â”€â”€ ğŸ“‚ pagerduty/
      â””â”€â”€ terraform.tfstate # PagerDutyã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
# stgç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ stg-bucket/
â”‚
...
```

```sh
# prdç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ prd-bucket/
â”‚
...
```

#### â–¼ åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ x å˜ä¸€ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã«å…¨ã¦ã®å®Ÿè¡Œç’°å¢ƒ ã®å ´åˆ

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

ã¾ãŸã€å˜ä¸€ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã«å…¨å®Ÿè¡Œç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
ğŸª£ bucket/
â”œâ”€â”€ ğŸ“‚ aws/
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â””â”€â”€ terraform.tfstate # AWSã®çŠ¶æ…‹ã‚’æŒã¤
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚
â”œâ”€â”€ ğŸ“‚ datadog/
â”‚    â”œâ”€â”€ ğŸ“‚ tes/
â”‚    â”‚    â””â”€â”€ terraform.tfstate # Datadogã®çŠ¶æ…‹ã‚’æŒã¤
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/
â”‚    â””â”€â”€ ğŸ“‚ prd/
â”‚
â”œâ”€â”€ ğŸ“‚ healthchecks/
â”‚    â”œâ”€â”€ ğŸ“‚ tes/
â”‚    â”‚    â””â”€â”€ terraform.tfstate # Healthchecksã®çŠ¶æ…‹ã‚’æŒã¤
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/
â”‚    â””â”€â”€ ğŸ“‚ prd/
â”‚
â””â”€â”€ ğŸ“‚ pagerduty/
      â”œâ”€â”€ ğŸ“‚ tes/
      â”‚    â””â”€â”€ terraform.tfstate # PagerDutyã®çŠ¶æ…‹ã‚’æŒã¤
      â”‚
      â”œâ”€â”€ ğŸ“‚ stg/
      â””â”€â”€ ğŸ“‚ prd/
```

<br>

# 09. ä¸­é–“å±¤ã®åˆ†å‰² (ä»»æ„)

## åŒã˜ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¥

### ã“ã®åˆ†å‰²æ–¹æ³•ã«ã¤ã„ã¦

åŒã˜ãƒ†ãƒŠãƒ³ãƒˆ (ä¾‹ï¼šåŒã˜AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®åŒã˜VPC) å†…ã«è¤‡æ•°ã®å°ã•ãªãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã«ã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¥ã§`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã€ä¸­é–“å±¤ã‚‚ã“ã‚Œã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã™ã€‚

ã“ã“ã§ã„ã†ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã¯ã€ã‚¢ãƒ—ãƒªã‚’å‹•ã‹ã™ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  (ä¾‹ï¼šEKSã€ECSã€AppRunnerã€EC2) ã¨ãã‚Œã‚’å–ã‚Šå·»ãAWSãƒªã‚½ãƒ¼ã‚¹ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚

å„ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ä½¿ç”¨ã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹æ•°ãŒå°‘ãªãã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¥ã«VPCã‚’åˆ†å‰²ã™ã‚‹ã®ãŒç…©é›‘ã¨ã„ã†èƒŒæ™¯ãŒã‚ã‚‹ã¨ã—ã¦ã„ã¾ã™ã€‚

ã“ã®åˆ†å‰²æ–¹æ³•ã«ã‚ˆã‚Šã€å„ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ç®¡ç†è€…ãŒäº’ã„ã«å½±éŸ¿ã‚’å—ã‘ãšã«ã€Terraformã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã«åˆ†å‰²ã—ãŸçŠ¶æ³ã¨ä»®å®šã—ã¾ã™ã€‚

- foo-product
- bar-product
- å…±æœ‰networkç³»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¾‹ï¼šVPCã€Route53)

ã“ã“ã§ä»®å®šã—ãŸçŠ¶æ³ã§ã¯ã€å„ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å…±æœ‰networkç³»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€æƒ³å®šã•ã‚Œã‚‹çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![terraform_architecture_different-tfstate_products](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_products.png)

<div hidden>

```mermaid
---
title: åŒã˜ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¥
---
%%{init:{'theme':'default'}}%%
flowchart TB
    subgraph AWS
        subgraph tes-bucket
            foo["foo-product-tfstate"]-..->network
            bar["bar-product-tfstate"]-..->network
            network["network-tfstate"]
        end
    subgraph stg-bucket
        stg["tfstate"]
    end
    subgraph prd-bucket
        prd["tfstate"]
    end
    end
```

</div>

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

åŒã˜ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
# foo-productã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒã‚¸ãƒˆãƒª
ğŸ­ aws-foo-product-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo-product/terraform.tfstate
â”‚    ...
â”‚
â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo-product/terraform.tfstate
â”‚    ...
â”‚
â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
      â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo-product/terraform.tfstate
      ...
```

```sh
# bar-productã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒã‚¸ãƒˆãƒª
ğŸ­ aws-bar-product-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar-product/terraform.tfstate
â”‚    ...
â”‚
â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar-product/terraform.tfstate
â”‚    ...
â”‚
â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
      â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar-product/terraform.tfstate
      ...
```

```sh
# å…±æœ‰networkç³»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒã‚¸ãƒˆãƒª
ğŸ­ aws-network-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ route53.tf
â”œâ”€â”€ vpc.tf
â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
â”‚    ...
â”‚
â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
â”‚    ...
â”‚
â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
      â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
      ...
```

#### â–¼ åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

åŒã˜ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
ğŸ­ aws-repository/
â”œâ”€â”€ ğŸ“‚ foo-product/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo-product/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo-product/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo-product/terraform.tfstate
â”‚          ...
â”‚
â”œâ”€â”€ ğŸ“‚ bar-product/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar-product/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar-product/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar-product/terraform.tfstate
â”‚          ...
â”‚
â””â”€â”€ ğŸ“‚ network
      â”œâ”€â”€ provider.tf
      â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
      â”œâ”€â”€ route53.tf
      â”œâ”€â”€ vpc.tf
      â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
      â”‚    ...
      â”‚
      â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
      â”‚    ...
      â”‚
      â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
           â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
           ...
```

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

åŒã˜ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¥ã®å ´åˆã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã™ã‚‹ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¢—ãˆéãã¦ã—ã¾ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ã“ã‚Œã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

#### â–¼ åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

åŒã˜ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã®é …ç›®ã«è¨˜è¼‰ã™ã‚‹çŠ¶æ³ã¨åŒã˜ã§ã™ã€‚

```sh
# tesç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ tes-bucket/
â”œâ”€â”€ ğŸ“‚ foo-product
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â”œâ”€â”€ ğŸ“‚ bar-product
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ ğŸ“‚ network
      â””â”€â”€ terraform.tfstate
```

```sh
# stgç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ stg-bucket/
â”‚
...
```

```sh
# prdç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ prd-bucket/
â”‚
...
```

<br>

## é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥

### ã“ã®åˆ†å‰²æ–¹æ³•ã«ã¤ã„ã¦

é‹ç”¨ãƒãƒ¼ãƒ  (ä¾‹ï¼šã‚¢ãƒ—ãƒªãƒãƒ¼ãƒ ã€ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ ) ã®AWSãƒªã‚½ãƒ¼ã‚¹ã®è²¬å‹™ç¯„å›²åˆ¥ã§`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã€ä¸­é–“å±¤ã‚‚ã“ã‚Œã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã™ã€‚

ã“ã®åˆ†å‰²æ–¹æ³•ã«ã‚ˆã‚Šã€å„é‹ç”¨ãƒãƒ¼ãƒ ãŒäº’ã„ã«å½±éŸ¿ã‚’å—ã‘ãšã«Terraformã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

<div class="text-box">
ã“ã®åˆ†å‰²æ–¹æ³•ã¯ã€AWSãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„è‘—åãªæ›¸ç±ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
<br>
<br>
å®Ÿéš›ã«ç§ã‚‚ç¾åœ¨é€²è¡Œå½¢ã§æ¡ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€éå¸¸ã«å®Ÿç”¨çš„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚
</div>

> - [https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/best-practices.html#organizingstacks:title]
> - [asin:B09969GJ7L:title]

### çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®é‹ç”¨ãƒãƒ¼ãƒ ã«åˆ†å‰²ã—ãŸçŠ¶æ³ã¨ä»®å®šã—ã¾ã™ã€‚

- frontendãƒãƒ¼ãƒ  (ã‚¢ãƒ—ãƒªã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é ˜åŸŸæ‹…å½“)
- backendãƒãƒ¼ãƒ  (ã‚¢ãƒ—ãƒªã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é ˜åŸŸæ‹…å½“)
- sreãƒãƒ¼ãƒ  (ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸæ‹…å½“)

ã“ã“ã§ä»®å®šã—ãŸçŠ¶æ³ã§ã¯ã€å„ãƒãƒ¼ãƒ ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«é–“ã§çŠ¶æ…‹ã®ç›¸äº’ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

ãã®ãŸã‚ã€æƒ³å®šã•ã‚Œã‚‹çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![terraform_architecture_different-tfstate_teams](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_teams.png)

<div hidden>

```mermaid
---
title: é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥
---
%%{init:{'theme':'default'}}%%
flowchart TB
    subgraph AWS
        subgraph tes-bucket
            frontend["frontend-team-tfstate<br>(CloudFront, S3, ãªã©)"]
            backend["backend-team-tfstate<br>(API Gateway, ElastiCache, RDS, SES, SNS, ãªã©)"]
            sre["sre-team-tfstate<br>(ALB, CloudWatch, EC2, ECS, EKS, IAM, VPC, ãªã©)"]
            frontend-..->sre
            backend-..->sre
            sre-..->frontend
            sre-..->backend
        end
    subgraph stg-bucket
        stg["tfstate"]
    end
    subgraph prd-bucket
        prd["tfstate"]
    end
    end
```

</div>

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¨åŒã˜çŠ¶æ³ã‚’ä»®å®šã—ã¦ã„ã¾ã™ã€‚

```sh
ğŸ­ aws-frontend-team-repository/ # frontendãƒãƒ¼ãƒ 
â”œâ”€â”€ provider.tf
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”œâ”€â”€ cloudfront.tf
â”œâ”€â”€ s3.tf
â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/terraform.tfstate
â”‚    ...
â”‚
â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/terraform.tfstate
â”‚    ...
â”‚
â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
      â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/terraform.tfstate
      ...
```

```sh
ğŸ­ aws-backend-team-repository/ # backendãƒãƒ¼ãƒ 
â”œâ”€â”€ provider.tf
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”œâ”€â”€ elasticache.tf
â”œâ”€â”€ ses.tf
â”œâ”€â”€ sns.tf
â”œâ”€â”€ rds.tf
â”œâ”€â”€ ğŸ“‚ tes
â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/terraform.tfstate
â”‚    ...
â”‚
â”œâ”€â”€ ğŸ“‚ stg
â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/terraform.tfstate
â”‚    ...
â”‚
â””â”€â”€ ğŸ“‚ prd
      â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/terraform.tfstate
       ...
```

```sh
ğŸ­ aws-sre-team-repository/ # sreãƒãƒ¼ãƒ 
â”œâ”€â”€ provider.tf
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”œâ”€â”€ alb.tf
â”œâ”€â”€ cloudwatch.tf
â”œâ”€â”€ ec2.tf
â”œâ”€â”€ ecs.tf
â”œâ”€â”€ eks.tf
â”œâ”€â”€ iam.tf
â”œâ”€â”€ vpc.tf
â”œâ”€â”€ ğŸ“‚ tes
â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/terraform.tfstate
â”‚    ...
â”‚
â”œâ”€â”€ ğŸ“‚ stg
â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/terraform.tfstate
â”‚    ...
â”‚
â””â”€â”€ ğŸ“‚ prd
      â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/terraform.tfstate
      ...
```

#### â–¼ åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¨åŒã˜çŠ¶æ³ã‚’ä»®å®šã—ã¦ã„ã¾ã™ã€‚

```sh
ğŸ­ aws-repository/
â”œâ”€â”€ ğŸ“‚ frontend-team # frontendãƒãƒ¼ãƒ 
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ cloudfront.tf
â”‚    â”œâ”€â”€ s3.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/terraform.tfstate
â”‚          ...
â”‚
â”œâ”€â”€ ğŸ“‚ backend-team # backendãƒãƒ¼ãƒ 
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ elasticache.tf
â”‚    â”œâ”€â”€ ses.tf
â”‚    â”œâ”€â”€ sns.tf
â”‚    â”œâ”€â”€ rds.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/terraform.tfstate
â”‚          ...
â”‚
â””â”€â”€ ğŸ“‚ sre-team # sreãƒãƒ¼ãƒ 
      â”œâ”€â”€ provider.tf
      â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
      â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
      â”œâ”€â”€ alb.tf
      â”œâ”€â”€ cloudwatch.tf
      â”œâ”€â”€ ec2.tf
      â”œâ”€â”€ ecs.tf
      â”œâ”€â”€ eks.tf
      â”œâ”€â”€ iam.tf
      â”œâ”€â”€ vpc.tf
      â”œâ”€â”€ ğŸ“‚ tes
      â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/terraform.tfstate
      â”‚    ...
      â”‚
      â”œâ”€â”€ ğŸ“‚ stg
      â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/terraform.tfstate
      â”‚    ...
      â”‚
      â””â”€â”€ ğŸ“‚ prd
           â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/terraform.tfstate
           ...
```

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ã®å ´åˆã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã™ã‚‹ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¢—ãˆéãã¦ã—ã¾ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ã“ã‚Œã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

#### â–¼ åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¨åŒã˜çŠ¶æ³ã‚’ä»®å®šã—ã¦ã„ã¾ã™ã€‚

```sh
# tesç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ tes-bucket/
â”œâ”€â”€ ğŸ“‚ frontend-team
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â”œâ”€â”€ ğŸ“‚ backend-team
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ ğŸ“‚ sre-team
      â””â”€â”€ terraform.tfstate
```

```sh
# stgç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ stg-bucket/
â”‚
...
```

```sh
# prdç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ prd-bucket/
â”‚
...
```

<br>

## ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥

### ã“ã®åˆ†å‰²æ–¹æ³•ã«ã¤ã„ã¦

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¾‹ï¼šã‚¢ãƒ—ãƒªã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€èªè¨¼/èªå¯ã€ç›£è¦–ã€ãªã©) åˆ¥ã§`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã€ä¸­é–“å±¤ã‚‚ã“ã‚Œã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã™ã€‚

ã“ã®åˆ†å‰²æ–¹æ³•ã«ã‚ˆã‚Šã€ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ç®¡ç†è€…ãŒäº’ã„ã«å½±éŸ¿ã‚’å—ã‘ãšã«Terraformã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

<div class="text-box">
ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€åˆ†ã‘ã‚ˆã†ã¨æ€ãˆã°ã„ãã‚‰ã§ã‚‚ç´°åˆ†åŒ–ã§ãã¦ã—ã¾ã„ã¾ã™ã€‚
<br>
<br>
ç´°åˆ†åŒ–ã—ãŸæ•°ã ã‘çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ãŒè¤‡é›‘ã«ãªã£ã¦ã„ããŸã‚ã€é©åº¦ãªæ•° (`3`~`4`å€‹ãã‚‰ã„) ã«ã—ã¦ãŠãã‚ˆã†ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
</div>

> - [https://www.endava.com/en/blog/Engineering/2019/11-Things-I-wish-I-knew-before-working-with-Terraform-I:title]
> - [https://charotamine.medium.com/terraform-organization-part-i-what-if-you-split-your-components-2fa3e8bf34b1:title]

### çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆ†å‰²ã—ãŸçŠ¶æ³ã¨ä»®å®šã—ã¾ã™ã€‚

- application (Web3å±¤ç³»)
- auth (èªè¨¼/èªå¯ç³»)
- monitor (ç›£è¦–ç³»)
- network (ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç³»)

ãã®ãŸã‚ã€æƒ³å®šã•ã‚Œã‚‹çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![terraform_architecture_different-tfstate_product_sub-components](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_product_sub-components.png)

<div hidden>

```mermaid
---
title: ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥
---
%%{init:{'theme':'default'}}%%
flowchart TB
    subgraph AWS
        subgraph tes-bucket
            application["application-tfstate<br>Web3å±¤ã¨å‘¨è¾ºAWSãƒªã‚½ãƒ¼ã‚¹<br>(ALB, APIGateway, CloudFront, EC2, ECS, EKS, RDS, S3, SNS, ãªã©)"]
            auth["auth-tfstate<br>(IAMãªã©)"]
            monitor["monitor-tfstate<br>(CloudWatch, ãªã©)"]
            network["network-tfstate<br>(Route53, VPC, ãªã©)"]
            application-..->network
            application-..->auth
            monitor-..->application
        end
        subgraph stg-bucket
            stg["tfstate"]
        end
        subgraph prd-bucket
            prd["tfstate"]
        end
        end
```

</div>

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã€ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹ã¨ãƒªãƒã‚¸ãƒˆãƒªãŒå¢—ãˆéãã¦ã—ã¾ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ã“ã‚Œã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

#### â–¼ åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¨åŒã˜çŠ¶æ³ã‚’ä»®å®šã—ã¦ã„ã¾ã™ã€‚

```sh
ğŸ­ aws-repository/
â”œâ”€â”€ ğŸ“‚ application/
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ alb.tf
â”‚    â”œâ”€â”€ cloudfront.tf
â”‚    â”œâ”€â”€ ec2.tf
â”‚    â”œâ”€â”€ ecs.tf
â”‚    â”œâ”€â”€ eks.tf
â”‚    â”œâ”€â”€ ses.tf
â”‚    â”œâ”€â”€ sns.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/application/terraform.tfstate
â”‚          ...
â”‚
â”œâ”€â”€ ğŸ“‚ auth/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ iam.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/auth/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/auth/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/auth/terraform.tfstate
â”‚          ...
â”‚
â”œâ”€â”€ ğŸ“‚ monitor/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ cloudwatch.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/monitor/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/monitor/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/monitor/terraform.tfstate
â”‚          ...
â”‚
â””â”€â”€ ğŸ“‚ network
      â”œâ”€â”€ provider.tf
      â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
      â”œâ”€â”€ route53.tf
      â”œâ”€â”€ vpc.tf
      â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
      â”‚    ...
      â”‚
      â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
      â”‚    ...
      â”‚
      â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
           â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
           ...
```

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã™ã‚‹ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¢—ãˆéãã¦ã—ã¾ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ã“ã‚Œã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

#### â–¼ åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¨åŒã˜çŠ¶æ³ã‚’ä»®å®šã—ã¦ã„ã¾ã™ã€‚

```sh
# tesç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ tes-bucket/
â”œâ”€â”€ ğŸ“‚ application
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â”œâ”€â”€ ğŸ“‚ auth
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â”œâ”€â”€ ğŸ“‚ monitor
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ ğŸ“‚ network
      â””â”€â”€ terraform.tfstate
```

```sh
# stgç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ stg-bucket/
â”‚
...
```

```sh
# prdç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ prd-bucket/
â”‚
...
```

<br>

## AWSãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥

### ã“ã®åˆ†å‰²æ–¹æ³•ã«ã¤ã„ã¦

AWSãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã§`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã€ä¸­é–“å±¤ã‚‚ã“ã‚Œã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã™ã€‚

ã“ã®åˆ†å‰²æ–¹æ³•ã«ã‚ˆã‚Šã€å„AWSãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚°ãƒ«ãƒ¼ãƒ—ã‚‚ç®¡ç†è€…ãŒäº’ã„ã«å½±éŸ¿ã‚’å—ã‘ãšã«Terraformã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

<div class="text-box">
AWSãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã€åˆ†ã‘ã‚ˆã†ã¨æ€ãˆã°ã„ãã‚‰ã§ã‚‚ç´°åˆ†åŒ–ã§ãã¦ã—ã¾ã„ã¾ã™ã€‚
<br>
<br>
ç´°åˆ†åŒ–ã—ãŸæ•°ã ã‘çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ãŒè¤‡é›‘ã«ãªã£ã¦ã„ããŸã‚ã€é©åº¦ãªæ•° (`3`~`5`å€‹ãã‚‰ã„) ã«ã—ã¦ãŠãã‚ˆã†ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
<br>
<br>
ç‰¹ã«ã“ã®åˆ†å‰²æ–¹æ³•ã¯ã€ã‚°ãƒ«ãƒ¼ãƒ—æ•°ãŒã©ã‚“ã©ã‚“å¢—ãˆã¦ã„ãå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
</div>

### çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ç¨®é¡ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²ã—ãŸçŠ¶æ³ã¨ä»®å®šã—ã¾ã™ã€‚

- application (Webã‚µãƒ¼ãƒãƒ¼ã€Appã‚µãƒ¼ãƒãƒ¼ç³»)
- auth (èªè¨¼/èªå¯ç³»)
- datastore (DBã‚µãƒ¼ãƒãƒ¼ç³»)
- cicd (CI/CDç³»)
- monitor (ç›£è¦–ç³»)
- network (ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç³»)

ãã®ãŸã‚ã€æƒ³å®šã•ã‚Œã‚‹çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![terraform_architecture_different-tfstate_resource-type](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_resource-type.png)

<div hidden>

```mermaid
---
title: AWSãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥
---
%%{init:{'theme':'default'}}%%
flowchart TB
    subgraph AWS
        subgraph tes-bucket
            application["application-tfstate<br>ä¾‹: ALB, API Gateway, CloudFront, EC2, ECS, EKS, SNS, ãªã©"]
            auth["auth-tfstate<br>ä¾‹: IAM, ãªã©"]
            cicd["cicd-tfstate<br>ä¾‹: Code3å…„å¼Ÿ, ãªã©"]
            monitor["monitor-tfstate<br>ä¾‹: CloudWatch, ãªã©"]
            network["network-tfstate<br>ä¾‹: Route53, VPC, ãªã©"]
            datastore["datastore-tfstate<br>ä¾‹: ElastiCache, RDS, S3, ãªã©"]
            application-....->auth
            application-..->datastore
            application-...->network
            cicd-..->application
            datastore-..->network
            monitor-..->application
            monitor-..->datastore
       end
    subgraph stg-bucket
        stg["tfstate"]
    end
    subgraph prd-bucket
        prd["tfstate"]
    end
    end
```

</div>

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

AWSãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã€ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹ã¨ãƒªãƒã‚¸ãƒˆãƒªãŒå¢—ãˆéãã¦ã—ã¾ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ã“ã‚Œã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

#### â–¼ åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

AWSãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¨åŒã˜çŠ¶æ³ã‚’ä»®å®šã—ã¦ã„ã¾ã™ã€‚

```sh
ğŸ­ aws-repository/
â”œâ”€â”€ ğŸ“‚ application/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ alb.tf
â”‚    â”œâ”€â”€ api_gateway.tf
â”‚    â”œâ”€â”€ cloudfront.tf
â”‚    â”œâ”€â”€ ec2.tf
â”‚    â”œâ”€â”€ ecs.tf
â”‚    â”œâ”€â”€ eks.tf
â”‚    â”œâ”€â”€ ses.tf
â”‚    â”œâ”€â”€ sns.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/application/terraform.tfstate
â”‚          ...
â”‚
â”œâ”€â”€ ğŸ“‚ auth/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ iam.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/auth/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/auth/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/auth/terraform.tfstate
â”‚          ...
â”‚
â”œâ”€â”€ ğŸ“‚ cicd/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ codebuild.tf
â”‚    â”œâ”€â”€ codecommit.tf
â”‚    â”œâ”€â”€ codedeploy.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/cicd/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/cicd/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/cicd/terraform.tfstate
â”‚          ...
â”‚
â”œâ”€â”€ ğŸ“‚ datastore/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ elasticache.tf
â”‚    â”œâ”€â”€ rds.tf
â”‚    â”œâ”€â”€ s3.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/datastore/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/datastore/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/datastore/terraform.tfstate
â”‚          ...
â”‚
â”œâ”€â”€ ğŸ“‚ monitor/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ cloudwatch.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/monitor/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/monitor/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/monitor/terraform.tfstate
â”‚          ...
â”‚
â””â”€â”€ ğŸ“‚ network
      â”œâ”€â”€ provider.tf
      â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã€outputãƒ–ãƒ­ãƒƒã‚¯ã‚’å®šç¾©ã™ã‚‹
      â”œâ”€â”€ route53.tf
      â”œâ”€â”€ vpc.tf
      â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
      â”‚    ...
      â”‚
      â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
      â”‚    ...
      â”‚
      â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
           â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/network/terraform.tfstate
           ...
```

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

AWSãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã™ã‚‹ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¢—ãˆéãã¦ã—ã¾ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ã“ã‚Œã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

#### â–¼ åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

AWSãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¨åŒã˜çŠ¶æ³ã‚’ä»®å®šã—ã¦ã„ã¾ã™ã€‚

```sh
# tesç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ tes-bucket/
â”œâ”€â”€ ğŸ“‚ application
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â”œâ”€â”€ ğŸ“‚ auth
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â”œâ”€â”€ ğŸ“‚ cicd
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â”œâ”€â”€ ğŸ“‚ datastore
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â”œâ”€â”€ ğŸ“‚ monitor
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ ğŸ“‚ network
      â””â”€â”€ terraform.tfstate
```

```sh
# stgç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ stg-bucket/
â”‚
...
```

```sh
# prdç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ prd-bucket/
â”‚
...
```

<br>

## AWSãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã®å¤‰æ›´é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥

### ã“ã®åˆ†å‰²æ–¹æ³•ã«ã¤ã„ã¦

AWSãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã®å¤‰æ›´é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã§`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã€ä¸­é–“å±¤ã‚‚ã“ã‚Œã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã™ã€‚

ã“ã®åˆ†å‰²æ–¹æ³•ã«ã‚ˆã‚Šã€å„å¤‰æ›´é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã®ç®¡ç†è€…ãŒäº’ã„ã«å½±éŸ¿ã‚’å—ã‘ãšã«Terraformã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã®åˆ†å‰²æ–¹æ³•ã¯ã€å¤‰æ›´é »åº¦ã®å¢ƒç›®ãŒæ›–æ˜§ãªãŸã‚ã€ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

> - [https://www.reddit.com/r/Terraform/comments/126jwa1/comment/jea9bjk/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button:title]

### çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®å¤‰æ›´é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²ã—ãŸçŠ¶æ³ã¨ä»®å®šã—ã¾ã™ã€‚

- å¤‰æ›´é«˜é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—
- å¤‰æ›´ä¸­é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—
- å¤‰æ›´ä½é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—

ãã®ãŸã‚ã€æƒ³å®šã•ã‚Œã‚‹çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![terraform_architecture_different-tfstate_update-frequence](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_update-frequence.png)

<div hidden>

```mermaid
---
title: AWSãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã®å¤‰æ›´é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥
---
%%{init:{'theme':'default'}}%%
flowchart TB
    subgraph AWS
        subgraph tes-bucket
            high["high-freq-tfstate<br>ä¾‹: API Gateway, CloudFront, CloudWatch, IAM"]
            middle["middle-freq-tfstate<br>ä¾‹: ALB, EC2, ECS, EKS, ElastiCache, RDS, S3, SES, SNS"]
            low["low-freq-tfstate<br>ä¾‹: Route53, VPC"]
            high-...->low
            middle-..->low
        end
    subgraph stg-bucket
        stg["tfstate"]
    end
    subgraph prd-bucket
        prd["tfstate"]
    end
    end
```

</div>

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

AWSãƒªã‚½ãƒ¼ã‚¹ã®å¤‰æ›´é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã€ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹ã¨ãƒªãƒã‚¸ãƒˆãƒªãŒå¢—ãˆéãã¦ã—ã¾ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ã“ã‚Œã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

#### â–¼ åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

AWSãƒªã‚½ãƒ¼ã‚¹ã®å¤‰æ›´é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¨åŒã˜çŠ¶æ³ã‚’ä»®å®šã—ã¦ã„ã¾ã™ã€‚

```sh
ğŸ­ aws-repository/
â”œâ”€â”€ ğŸ“‚ high-freq # é«˜é »åº¦å¤‰æ›´ã‚°ãƒ«ãƒ¼ãƒ—
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ api_gateway.tf
â”‚    â”œâ”€â”€ cloudfront.tf
â”‚    â”œâ”€â”€ cloudwatch.tf
â”‚    â”œâ”€â”€ ec2.tf
â”‚    â”œâ”€â”€ ecs.tf
â”‚    â”œâ”€â”€ eks.tf
â”‚    â”œâ”€â”€ iam.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/high-freq/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/high-freq/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/high-freq/terraform.tfstate
â”‚          ...
â”‚
â”œâ”€â”€ ğŸ“‚ low-freq # ä½é »åº¦å¤‰æ›´ã‚°ãƒ«ãƒ¼ãƒ—
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ route53.tf
â”‚    â”œâ”€â”€ vpc.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/low-freq/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/low-freq/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/low-freq/terraform.tfstate
â”‚          ...
â”‚
â””â”€â”€ ğŸ“‚ middle-freq # ä¸­é »åº¦å¤‰æ›´ã‚°ãƒ«ãƒ¼ãƒ— (é«˜é »åº¦ã¨ã‚‚ä½é »åº¦ã¨ã‚‚è¨€ãˆãªã„ãƒªã‚½ãƒ¼ã‚¹)
      â”œâ”€â”€ provider.tf
      â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
      â”œâ”€â”€ elasticache.tf
      â”œâ”€â”€ rds.tf
      â”œâ”€â”€ s3.tf
      â”œâ”€â”€ ses.tf
      â”œâ”€â”€ ğŸ“‚ tes
      â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/middle-freq/terraform.tfstate
      â”‚    ...
      â”‚
      â”œâ”€â”€ ğŸ“‚ stg
      â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/middle-freq/terraform.tfstate
      â”‚    ...
      â”‚
      â””â”€â”€ ğŸ“‚ prd
           â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/middle-freq/terraform.tfstate
           ...
```

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

AWSãƒªã‚½ãƒ¼ã‚¹ã®å¤‰æ›´é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã™ã‚‹ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¢—ãˆéãã¦ã—ã¾ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ã“ã‚Œã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

#### â–¼ åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

AWSãƒªã‚½ãƒ¼ã‚¹ã®å¤‰æ›´é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¨åŒã˜çŠ¶æ³ã‚’ä»®å®šã—ã¦ã„ã¾ã™ã€‚

```sh
# tesç”¨ãƒã‚±ãƒƒãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
ğŸª£ tes-bucket/
â”œâ”€â”€ ğŸ“‚ high-freq
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â”œâ”€â”€ ğŸ“‚ middle-freq
â”‚    â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ ğŸ“‚ low-freq
      â””â”€â”€ terraform.tfstate
```

```sh
# stgç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ stg-bucket/
â”‚
...
```

```sh
# prdç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ prd-bucket/
â”‚
...
```

<br>

## é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ Ã— ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥

### ã“ã®åˆ†å‰²æ–¹æ³•ã«ã¤ã„ã¦

é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ã¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã‚’çµ„ã¿åˆã‚ã›ã¦`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã€ä¸­é–“å±¤ã‚‚ã“ã‚Œã«åŸºã¥ã„ã¦è¨­è¨ˆã—ã¾ã™ã€‚

ã“ã®åˆ†å‰²æ–¹æ³•ã«ã‚ˆã‚Šã€å„é‹ç”¨ãƒãƒ¼ãƒ å†…ã®è¤‡æ•°ã®é–‹ç™ºè€…ãŒäº’ã„ã«å½±éŸ¿ã‚’å—ã‘ãšã«Terraformã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

<div class="text-box">
ã“ã®åˆ†å‰²æ–¹æ³•ã¯ã€Terraformã«æºã‚ã‚‹é–‹ç™ºè€…ãŒå¤šã„å¤§è¦æ¨¡ãªãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã»ã©åŠ¹åŠ›ã‚’ç™ºæ®ã—ã¾ã™ã€‚
<br>
<br>
å®Ÿéš›ã«ç§ã‚‚ç¾åœ¨é€²è¡Œå½¢ã§æ¡ç”¨ã—ã¦ãŠã‚Šã€éå¸¸ã«å®Ÿç”¨çš„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚
</div>

### çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³

ä»¥ä¸‹ã®é‹ç”¨ãƒãƒ¼ãƒ ã«åˆ†å‰²ã—ãŸçŠ¶æ³ã¨ä»®å®šã—ã¾ã™ã€‚

ã¾ãŸã€å„é‹ç”¨ãƒãƒ¼ãƒ ã§Terraformã‚’å¤‰æ›´ã§ãã‚‹é–‹ç™ºè€…ãŒç›¸å½“æ•°ã™ã‚‹ãŸã‚ã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã«ã‚‚åˆ†å‰²ã—ãŸã¨ã—ã¾ã™ã€‚

- frontendãƒãƒ¼ãƒ 
  - application
  - monitor
- backendãƒãƒ¼ãƒ 
  - application
  - monitor
- sreãƒãƒ¼ãƒ 
  - application
  - auth
  - monitor
  - network

![terraform_architecture_different-tfstate_teams_resource-type](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate_teams_resource-type.png)

<div hidden>

```mermaid
---
title: é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ Ã— ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥
---
%%{init:{'theme':'default'}}%%
flowchart TB
    subgraph AWS
        subgraph tes-bucket
            subgraph frontend-team
               frontendApplication["application-tfstate<br>(CloudFront, S3, ãªã©)"]
               frontendMonitor["monitor-tfstate<br>(CloudWatch, ãªã©)"]
            end
            subgraph backend-team
                backendApplication["application-tfstate<br>(API Gateway, ElastiCache, RDS, SES, SNS, ãªã©)"]
                backendMonitor["monitor-tfstate<br>(CloudWatch, ãªã©)"]
            end
            subgraph sre-team
                sreApplication["application-tfstate<br>Web3å±¤ã¨å‘¨è¾ºAWSãƒªã‚½ãƒ¼ã‚¹<br>(ALB, EC2, ECS, EKS, SNS, ãªã©)"]
                auth["auth-tfstate<br>(IAM, ãªã©)"]
                sreMonitor["monitor-tfstate<br>(CloudWatch, ãªã©)"]
                network["network-tfstate<br>(Route53, VPC, ãªã©)"]
            end
            frontendApplication-...->network
            sreApplication-...->auth
            sreApplication-...->network
            backendApplication-...->auth
            backendApplication-...->network
            frontendMonitor-...->frontendApplication
            sreMonitor-...->sreApplication
            backendMonitor-...->backendApplication
        end
    subgraph stg-bucket
        stg["tfstate"]
    end
    subgraph prd-bucket
        prd["tfstate"]
    end
    end
```

</div>

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ã¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã‚’çµ„ã¿åˆã‚ã›ã¦åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¨åŒã˜çŠ¶æ³ã‚’ä»®å®šã—ã¦ã„ã¾ã™ã€‚

```sh
ğŸ­ aws-frontend-team-repository/
â”œâ”€â”€ ğŸ“‚ application/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ cloudfront.tf
â”‚    â”œâ”€â”€ ses.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/application/terraform.tfstate
â”‚          ...
â”‚
â””â”€â”€ ğŸ“‚ monitor/
      â”œâ”€â”€ provider.tf
      â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
      â”œâ”€â”€ cloudwatch.tf
      â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/monitor/terraform.tfstate
      â”‚    ...
      â”‚
      â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/monitor/terraform.tfstate
      â”‚    ...
      â”‚
      â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
            â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/frontend-team/monitor/terraform.tfstate
            ...
```

```sh
ğŸ­ aws-backend-team-repository/
â”œâ”€â”€ ğŸ“‚ application/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ api_gateway.tf
â”‚    â”œâ”€â”€ elasticache.tf
â”‚    â”œâ”€â”€ rds.tf
â”‚    â”œâ”€â”€ ses.tf
â”‚    â”œâ”€â”€ sns.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/application/terraform.tfstate
â”‚          ...
â”‚
â””â”€â”€ ğŸ“‚ monitor/
      â”œâ”€â”€ provider.tf
      â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
      â”œâ”€â”€ cloudwatch.tf
      â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/monitor/terraform.tfstate
      â”‚    ...
      â”‚
      â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/monitor/terraform.tfstate
      â”‚    ...
      â”‚
      â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
            â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/backend-team/monitor/terraform.tfstate
            ...
```

```sh
ğŸ­ aws-sre-team-repository/
â”œâ”€â”€ ğŸ“‚ application/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ alb.tf
â”‚    â”œâ”€â”€ ec2.tf
â”‚    â”œâ”€â”€ ecs.tf
â”‚    â”œâ”€â”€ eks.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/application/terraform.tfstate
â”‚          ...
â”‚
â”œâ”€â”€ ğŸ“‚ auth/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ iam.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/application/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/application/terraform.tfstate
â”‚          ...
â”‚
â”œâ”€â”€ ğŸ“‚ monitor/
â”‚    â”œâ”€â”€ provider.tf
â”‚    â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚    â”œâ”€â”€ cloudwatch.tf
â”‚    â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # tesç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/monitor/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
â”‚    â”‚    â”œâ”€â”€ backend.tfvars # stgç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/monitor/terraform.tfstate
â”‚    â”‚    ...
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚          â”œâ”€â”€ backend.tfvars # prdç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/monitor/terraform.tfstate
â”‚          ...
â”‚
â””â”€â”€ ğŸ“‚ network
      â”œâ”€â”€ provider.tf
      â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
      â”œâ”€â”€ route53.tf
      â”œâ”€â”€ vpc.tf
      â”œâ”€â”€ ğŸ“‚ tes/ # æ¤œè¨¼ç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/network/terraform.tfstate
      â”‚    ...
      â”‚
      â”œâ”€â”€ ğŸ“‚ stg/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œç’°å¢ƒ
      â”‚    â”œâ”€â”€ backend.tfvars # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/network/terraform.tfstate
      â”‚    ...
      â”‚
      â””â”€â”€ ğŸ“‚ prd/ # æœ¬ç•ªç’°å¢ƒ
            â”œâ”€â”€ backend.tfvars # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/sre-team/network/terraform.tfstate
            ...
```

#### â–¼ åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ã¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã‚’çµ„ã¿åˆã‚ã›ã‚‹åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã€åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹ã¨ãƒªãƒã‚¸ãƒˆãƒªãŒå·¨å¤§ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ã“ã‚Œã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### â–¼ ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ã¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã‚’çµ„ã¿åˆã‚ã›ã‚‹åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã™ã‚‹ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¢—ãˆéãã¦ã—ã¾ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€ã“ã‚Œã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

#### â–¼ åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ã¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã‚’çµ„ã¿åˆã‚ã›ã¦åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€çŠ¶æ…‹ã®ä¾å­˜é–¢ä¿‚å›³ã¨åŒã˜çŠ¶æ³ã‚’ä»®å®šã—ã¦ã„ã¾ã™ã€‚

```sh
# tesç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ tes-bucket/
â”œâ”€â”€ ğŸ“‚ frontend-team
â”‚    â”œâ”€â”€ ğŸ“‚ application
â”‚    â”‚    â””â”€â”€ terraform.tfstate
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ monitor
â”‚         â””â”€â”€ terraform.tfstate
â”‚
â”œâ”€â”€ ğŸ“‚ backend-team
â”‚    â”œâ”€â”€ ğŸ“‚ application
â”‚    â”‚    â””â”€â”€ terraform.tfstate
â”‚    â”‚
â”‚    â””â”€â”€ ğŸ“‚ monitor
â”‚          â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ ğŸ“‚ sre-team
      â”œâ”€â”€ ğŸ“‚ application
      â”‚    â””â”€â”€ terraform.tfstate
      â”‚
      â”œâ”€â”€ ğŸ“‚ auth
      â”‚    â””â”€â”€ terraform.tfstate
      â”‚
      â”œâ”€â”€ ğŸ“‚ monitor
      â”‚    â””â”€â”€ terraform.tfstate
      â”‚
      â””â”€â”€ ğŸ“‚ network
            â””â”€â”€ terraform.tfstate
```

```sh
# stgç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ stg-bucket/
â”‚
...
```

```sh
# prdç”¨ãƒã‚±ãƒƒãƒˆã®å ´åˆ
ğŸª£ prd-bucket/
â”‚
...
```

<br>

# 10. ãŠã‚ã‚Šã«

Terraformã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¾ã—ãŸã€‚

Terraformã®é–‹ç™ºç¾å ´ã®å…·ä½“çš„ãªè¦ä»¶ã¯åƒå·®ä¸‡åˆ¥ã§ã‚ã‚Šã€ç‰¹ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«é–“ã®çŠ¶æ…‹ä¾å­˜é–¢ä¿‚ã¯æ§˜ã€…ã§ã™ã€‚

ãã®ãŸã‚æ­£ç›´ãªã¨ã“ã‚ã€ã‚ã‚‰ã‚†ã‚‹è¦ä»¶ã‚’æŠ½è±¡åŒ–ã—ãŸåˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è€ƒãˆã‚‹ã“ã¨ã¯ãƒã‚¸ã§ä¸å¯èƒ½ã§ã™ğŸ˜­

ã‚‚ã—ã€ã“ã®è¨˜äº‹ã‚’å‚è€ƒã«è¨­è¨ˆã—ã¦ãã ã•ã‚‹æ–¹ã¯ã€åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¾å ´ã«è½ã¨ã—è¾¼ã‚“ã§è§£é‡ˆã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

<br>

> ã€Œè‡ªåˆ†ã‚’ä¿¡ã˜ã¦ã‚‚â€¦ä¿¡é ¼ã«è¶³ã‚‹ä»²é–“ã‚’ä¿¡ã˜ã¦ã‚‚â€¦èª°ã«ã‚‚ã‚ã‹ã‚‰ãªã„â€¦ã€
>
> (ãŠå‹é”ã®[`@nwiizo`](https://twitter.com/nwiizo), 2023, [Terraform Modules ã§å†åˆ©ç”¨ã§ãã‚‹ã®ã§æœ€é«˜ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ](https://syu-m-5151.hatenablog.com/entry/2023/05/19/154346))

<br>

# è¬è¾

ä»Šå›ã€Terraformã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åé›†ã«ã‚ãŸã‚Šã€ä»¥ä¸‹ã®æ–¹ã€…ã‹ã‚‰ã®æ„è¦‹ã‚„å®Ÿè£…æ–¹æ³•ã‚‚å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

- [`@kiyo_12_07`](https://twitter.com/kiyo_12_07)
- [`@masasuzu`](https://twitter.com/masasuz)
- [`@tozastation`](https://twitter.com/tozastation)

(ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †)

ã“ã®å ´ã§æ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ğŸ™‡ğŸ»â€

<br>
