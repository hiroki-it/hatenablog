---
Title: "ã€ArgoCD\U0001F419ï¸ã€‘ArgoCDã®ãŸã‚ã®ãƒ†ãƒŠãƒ³ãƒˆè¨­è¨ˆã¨ãƒ†ãƒŠãƒ³ãƒˆå†…ã®èªå¯å‡¦ç†ã®ä»•çµ„ã¿"
Date: 2023-07-30T17:48:58+09:00
Category:
  - ArgoCD
  - Kubernetes
  - ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
  - èªè¨¼/èªå¯
URL: https://hiroki-hasegawa.hatenablog.jp/entry/2023/07/30/174858
EditURL: https://blog.hatena.ne.jp/hiroki-hasegawa/hiroki-hasegawa.hatenablog.jp/atom/entry/820878482953981415
Draft: true
---

<br>

[:contents]

<br>

# ã“ã®è¨˜äº‹ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹çŸ¥è­˜

ã“ã®è¨˜äº‹ã‚’èª­ã‚€ã¨ã€ä»¥ä¸‹ã‚’ "å®Œå…¨ã«ç†è§£" ã§ãã¾ã™âœŒï¸

- ArgoCDã®Namespacedã‚¹ã‚³ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ã¨ã¯
- ãƒ†ãƒŠãƒ³ãƒˆå†…ã§ã®

<br>

# 01. ã¯ã˜ã‚ã«

Argo autopilotã®ãƒ­ã‚´...ã‚‚ã†ã‚³ãƒ©ã˜ã‚ƒã‚“...

ã•ã¦ã€å‰å›ã®è¨˜äº‹ã§Kubernetesã®ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ArgoCDã®å®Ÿè·µãƒ†ãƒŠãƒ³ãƒˆè¨­è¨ˆã‚’è§£èª¬ã—ã¾ã—ãŸã€‚

ä»Šå›ã¯ã€ArgoCDãŒãƒ†ãƒŠãƒ³ãƒˆå†…ã§ã©ã®ã‚ˆã†ã«èªè¨¼/èªå¯å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã®ã‹ã®ä»•çµ„ã¿ã‚’è§£èª¬ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ãã‚Œã§ã¯ã€ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¦ã„ãã¾ã™ğŸ˜—

<br>

# 02. ãªãœApplicationã«ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆãŒå¿…è¦ãªã®ã‹

å‰å›ã®å¾©ç¿’ã§ã™ã€‚

## ã‚·ãƒ³ã‚°ãƒ«ãƒ†ãƒŠãƒ³ãƒˆã®å ´åˆ

![argocd_single-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_single-tenant.png)

<br>

## ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã®å ´åˆ

![argocd_multi-tenant](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant.png)

<br>

# 03. å„ãƒ†ãƒŠãƒ³ãƒˆã«ãŠã‘ã‚‹èªå¯å‡¦ç†ã®ä»•çµ„ã¿

AppProjectãƒ†ãƒŠãƒ³ãƒˆã®ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚’æ¡ç”¨ã—ãŸå ´åˆã€ArgoCDä¸Šã§ã©ã®ã‚ˆã†ãªã“ã¨ãŒèµ·ã“ã‚‹ã®ã‹ã€ãã®ä»•çµ„ã¿ã¨Namespacedã‚¹ã‚³ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šæ–¹æ³•ã‚’èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

ãªãŠã“ã®ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ä¸Šã§ã€ArgoCDã®ç‰¹ã« "argocd-server" "application-controller" "dex-server" ã®è²¬å‹™ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¤ã„ã¦ã€ä»Šå›ã¯ç°¡å˜ã«ã—ã‹èª¬æ˜ã—ã¦ã„ã¾ã›ã‚“ğŸ˜¢

è©³ã—ãçŸ¥ã‚ŠãŸã„æ–¹ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ã§å…¨ä½“åƒã‚’ç´¹ä»‹ã—ã¦ã¾ã™ã®ã§ã€ã‚ˆã‚ã—ãã©ã†ãğŸ™‡ğŸ»â€â™‚ï¸

[https://hiroki-hasegawa.hatenablog.jp/entry/2023/05/02/145115:embed]

<br>

## æ¦‚è¦

![argocd_multi-tenant_appproject_namespaced-scope_overview](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_overview.png)

ArgoCDç”¨ClusterãŒã‚ã‚Šã€ã“ã“ã§å‹•ã„ã¦ã„ã‚‹ArgoCDã¯ã€Devç’°å¢ƒã¨Tesç’°å¢ƒã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆç”¨Clusterã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

Clusterä¸Šã«ã¯ã€Namespace (`foo`ã€`bar`ã€`baz`) ãŒã‚ã‚Šã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ãƒãƒ¼ãƒ åˆ¥ã«å„AppProjectã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

### (1) ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒ¼ãƒ ã®ãƒ­ã‚°ã‚¤ãƒ³

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒ¼ãƒ ã¯ã€SSOã§argocd-serverã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

### (2) argocd-serverã«ã‚ˆã‚‹èªå¯ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡

argocd-serverã¯ã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒ¼ãƒ ã®Applicationã®èªå¯ã‚¹ã‚³ãƒ¼ãƒ—ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚

ãªãŠå„ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ArgoCDã®Applicationã¯ã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®å®Ÿè¡Œç’°å¢ƒåˆ¥ã®Clusterã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

### (3) application-controllerã«ã‚ˆã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒ¼ãƒ ã¯ã€å„Namespaceä¸Šã®ArgoCD (application-controller) ã‚’ä»‹ã—ã¦ã€æ‹…å½“ã™ã‚‹Clusterã«ã®ã¿ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚

<br>

## argocd-server

ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«ã€Namespaceã®`foo`ã®ã¿ã«ç€ç›®ã—ã¾ã™ã€‚

ã¾ãšã€argocd-serverã§ã™ã€‚

AppProjectãƒ†ãƒŠãƒ³ãƒˆã®å ´åˆã€argocd-serverã®ã€Namespacedã‚¹ã‚³ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ã€ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚

![argocd_multi-tenant_appproject_namespaced-scope_argocd-server](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_argocd-server.png)

### (1) ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒ¼ãƒ ã®ãƒ­ã‚°ã‚¤ãƒ³

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒ¼ãƒ ã¯ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (argocd-server) ã«SSOã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚

### (2) IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¸ã®èªè¨¼ãƒ•ã‚§ãƒ¼ã‚ºå§”è­²

argocd-serverã¯ã€èªè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã‚’IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å§”è­²ã™ã‚‹ãŸã‚ã«ã€dex-serverã‚’ã‚³ãƒ¼ãƒ«ã—ã¾ã™ã€‚

### (3) dex-serverã«ã‚ˆã‚‹èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ

dex-serverã¯ã€èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

### (4) dex-serverã«ã‚ˆã‚‹èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡

dex-serverã¯ã€å‰ã®æ‰‹é †ã§ä½œæˆã—ãŸèªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«é€ä¿¡ã—ã¾ã™ã€‚

### (5) IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«ã‚ˆã‚‹èªè¨¼ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿæ–½

IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å´ã§SSOã®èªè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¯ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URL (`<ArgoCDã®ãƒ‰ãƒ¡ã‚¤ãƒ³å>/api/dex/callback`) ã‚’æŒ‡å®šã—ã¦ã€èªå¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é€ä¿¡ã—ã¾ã™ã€‚

### (6) argocd-serverã«ã‚ˆã‚‹èªå¯ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿæ–½

èªå¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã€argocd-serverã‚’ä»‹ã—ã¦ã€dex-serverã«å±Šãã¾ã™ã€‚

### (7) èªè¨¼æƒ…å ±ã«èªå¯ã‚¹ã‚³ãƒ¼ãƒ—ç´ä»˜ã‘

#### â–¼ argocd-rbac-cm

argocd-serverã¯ã€ConfigMap (`argocd-rbac-cm`) ã‚’å‚ç…§ã—ã¾ã™ã€‚

`argocd-rbac-cm`ã‹ã‚‰ã€IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§èªè¨¼æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ã‚°ãƒ«ãƒ¼ãƒ—ã«ã€ArgoCDç³»ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ (Application) ã«é–¢ã™ã‚‹èªå¯ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€å„ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒ¼ãƒ ã«ä»–ã®ãƒ†ãƒŠãƒ³ãƒˆã®å‚ç…§æ¨©é™ã®ã¿ã‚’ä»˜ä¸ã—ãŸã„ã¨ã—ã¾ã—ã‚‡ã†ã€‚

ãã®å ´åˆã€å®Ÿè£…ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã¨ãªã‚Šã¾ã™ã€‚

```yaml
# fooãƒ†ãƒŠãƒ³ãƒˆã§ä½¿ç”¨ã™ã‚‹argocd-rbac-cm
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: foo
data:
  # ã„ãšã‚Œã®ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚‚å±ã•ãšã«ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆã€å‚ç…§æ¨©é™ã«ãªã‚‹ã€‚
  policy.default: role:readonly
  # èªè¨¼ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã«å¿œã˜ã¦ã€ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹ã€‚
  policy.csv: |
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ­ãƒ¼ãƒ«ã®ArgoCDç³»ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ (ç‰¹ã«Application) ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚‹
    p, role:foo-team, *, *, dev/foo-team/*, allow
    p, role:foo-team, *, *, tes/foo-eam/*, allow

    # ã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒ­ãƒ¼ãƒ«ã‚’ç´ä»˜ã‘ã‚‹
    g, foo-team, role:foo-team
  scopes: "[groups]"
```

ã‚‚ã—ã€Applicationã§è¨±å¯ã•ã‚Œã¦ã„ãªã„æ“ä½œ (ä¾‹ï¼šè¨­å®šå€¤ã®æ›´æ–°) ã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```bash
Unable to save changes: permission denied: applications, update, foo-team/foo-application
```

#### â–¼ `p` (ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³)

ãƒ­ãƒ¼ãƒ«ã¨ArgoCDç³»ãƒªã‚½ãƒ¼ã‚¹ã®èªå¯ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å®šç¾©ã™ã‚‹ã€‚

```bash
p, <ãƒ­ãƒ¼ãƒ«å> <Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡> <ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å> <AppProjectå>/<Namespaceå>/<Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®è­˜åˆ¥å>

p, role:foo, *, *, dev/foo/*, allow
p, role:foo, *, *, tes/foo/*, allow
```

ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€`admin`ã‚„`readonly`ãŒã‚ã‚Šã¾ã™ã€‚

> - [https://github.com/argoproj/argo-cd/blob/master/assets/builtin-policy.csv:title]

#### â–¼ `g` (ã‚°ãƒ«ãƒ¼ãƒ—)

ã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒ­ãƒ¼ãƒ«ã‚’ç´ä»˜ã‘ã‚‹ã€‚

```bash
g, <ã‚°ãƒ«ãƒ¼ãƒ—å> <ãƒ­ãƒ¼ãƒ«å>

g, foo-team, role:foo
```

<br>

### (8) Applicationã§è¨­å®šå¯èƒ½ãªClusterã‚„Namespaceã‚’å–å¾—

argocd-serverã¯ã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒ¼ãƒ ã®èªå¯ã«é–¢ä¿‚ãªãã€Applicationã§è¨­å®šå¯èƒ½ãªClusterã‚„Namespaceã‚’å–å¾—ã—ã¾ã™ã€‚

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: infra-team
  namespace: foo
spec:
  destinations:
    # ArgoCDè‡ªä½“ãŒå‹•ã„ã¦ã„ã‚‹Cluster
    - namespace: foo
      server: "https://kubernetes.default.svc"
    # ArgoCDã®ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆCluster (EKSã®å ´åˆ)
    - namespace: "*"
      server: https://*****.gr7.ap-northeast-1.eks.amazonaws.com
  # è¨­å®šã—ãªã„
  # sourceNamespaces:
  #   - "<ApplicationãŒå±ã™ã‚‹Namespace>"

  ...
```

ã‚‚ã—ã€argocd-serverä¸Šã§è¨±å¯ã•ã‚Œã¦ã„ãªã„Namespace (ä¾‹ï¼š`bar`) ã§Applicationã‚’ä½œæˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```bash
application destination {https://kubernetes.default.svc bar} is not permitted in project 'infra-team'
```

ã‚‚ã—ã€argocd-serverä¸Šã§è¨±å¯ã•ã‚Œã¦ã„ãªã„Clusterã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```bash
application destination {https://*****.gr7.ap-northeast-1.eks.amazonaws.com bar} is not permitted in project 'infra-team'
```

<br>

## application-controller

ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«ã€argocd-serverã®èª¬æ˜ã¨åŒæ§˜ã«Namespaceã®`foo`ã®ã¿ã«ç€ç›®ã—ã¾ã™ã€‚

AppProjectãƒ†ãƒŠãƒ³ãƒˆã®å ´åˆã€argocd-serverã¨åŒæ§˜ã«application-controllerã®ã€Namespacedã‚¹ã‚³ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ã€ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚

![argocd_multi-tenant_appproject_namespaced-scope_application-controller](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/argocd/argocd_multi-tenant_appproject_namespaced-scope_application-controller.png)

### (1) ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒ¼ãƒ ã®ãƒ­ã‚°ã‚¤ãƒ³

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒ¼ãƒ ã¯ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (argocd-server) ã«SSOã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚

### (3) application-controllerãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªNamespaceå–å¾—

argocd-serverã¯ã€ConfigMap (`argocd-cmd-params-cm`) ã‚’å‚ç…§ã—ã¾ã™ã€‚

`argocd-cmd-params-cm`ã‹ã‚‰ã€ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªNamespaceã‚’å–å¾—ã—ã¾ã™ã€‚

Namespaceã‚¹ã‚³ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€`argocd-cmd-params-cm`ã«ã¯**<font color="#FF0000">è¨­å®šã—ãªã„</font>**ã‚ˆã†ã«ã—ã¾ã™ã€‚

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: argocd
data:
  # è¨­å®šã—ãªã„
  # ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªNamespaceã‚’è¨­å®šã™ã‚‹ã€‚AppProjectã®spec.sourceNamespacesã‚­ãƒ¼ã§ã‚‚è¨­å®šãŒå¿…è¦ã«ãªã‚‹
  # application.namespaces: "<ApplicationãŒå±ã™ã‚‹Namespace>"
```

### (3)

...

<br>
