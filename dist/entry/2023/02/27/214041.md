---
Title: ã€Istioâ›µï¸ã€‘å®‰å…¨ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®ä»•çµ„ã¿ (å¾Œç·¨)
Date: 2023-02-27T21:40:41+09:00
Category:
  - Istio
  - Envoy
URL: https://hiroki-hasegawa.hatenablog.jp/entry/2023/02/27/214041
EditURL: https://blog.hatena.ne.jp/hiroki-hasegawa/hiroki-hasegawa.hatenablog.jp/atom/entry/4207112889967052381
Draft: true
---

<br>

[:contents]

<br>

ã“ã¡ã‚‰ã®è¨˜äº‹ã¯ã€ä»¥ä¸‹ã®å¾Œç·¨ã§ã™ğŸ‘‡

[https://hiroki-hasegawa.hatenablog.jp/entry/2023/02/26/202400:embed]

<br>

# 01. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®è©³ç´°

ã“ã“ã‹ã‚‰ã¯ã€[å‰ç·¨ã§èª¬æ˜ã—ãŸæ¦‚è¦](https://hiroki-hasegawa.hatenablog.jp/entry/2023/02/26/202548#03-%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89%E6%89%8B%E6%B3%95%E3%81%AE%E6%A6%82%E8%A6%81) ã‚’æ·±ã¼ã£ã¦ã„ãã¾ã™ã€‚

**Istioãƒã‚·ãƒã‚·ã«ãªã£ã¦ã—ã¾ã£ãŸã®ã§ã€å‰ç·¨ã‚’é£Ÿã¹åˆ‡ã‚ŒãŸæ–¹ã®ã¿é€²ã‚€ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™**ğŸ˜‡

<br>

## å‰æ

### å…¨ä½“åƒ

ä»¥é™ã®ã€ï¼‘ã€‘ã€œã€ï¼˜ã€‘ã¯ã€[03. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®æ¦‚è¦](#03-ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®æ¦‚è¦) ã®ç•ªå·ã«å¯¾å¿œã•ã›ã¦ã„ã¾ã™ã€‚

**<font color="#FF0000">è©±ãŒé€¸ã‚Œãªã„ã‚ˆã†ã«Helmã‚„ArgoCDã‚’ä½¿ç”¨ã›ãšã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ä¸€ç•ªå„ªå…ˆã—ã¦è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹`istioctl`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ãŸæ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚</font>**

ã‚‚ã¡ã‚ã‚“ã€ä»–ã®ãƒ„ãƒ¼ãƒ« (ä¾‹ï¼šHelmã€ArgoCD) ã‚’ä½¿ç”¨ã—ã¦ã‚‚ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

ç´°ã‹ãªæ‰‹é †ãŒç•°ãªã‚‹ã ã‘ã§ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®æ¦‚è¦ã«é–¢ã—ã¦ã¯åŒã˜ã§ã™ğŸ™†â€â™‚ï¸

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_rollout-restart_1.png" alt="istio_canary-upgrade_rollout-restart_1" style="zoom:100%;">

### Namespace

ã¾ãšæœ€åˆã«ã€å‰æã¨ãªã‚‹çŠ¶æ³ã‚’è¨­å®šã—ã¦ãŠãã¾ã™ã€‚

å„Namespaceã®`istio.io/rev`ãƒ©ãƒ™ãƒ«ã«`default`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚

```sh
$ kubectl get namespace -L istio.io/rev

NAME              STATUS   AGE   REV
foo               Active   34d   default
bar               Active   34d   default
baz               Active   34d   default
qux               Active   34d   default
istio-ingress     Active   34d   default
```

ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«æ›¸ãèµ·ã“ã™ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: foo
  labels:
    istio.io/rev: default
```

ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ã©ã‚“ãªå€¤ã§ã‚‚å•é¡Œãªãã€ã‚ˆãã‚ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦`default`ã‚„`stable`ãªã©ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ã“ã®`istio.io/rev`ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹ã“ã¨ã§ã€ãã®Namespaceã®Podã«`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚

`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯ã€ã“ã¡ã‚‰è¨˜äº‹ã§èª¬æ˜ã—ã¦ãŠã‚Šã€ã‚‚ã—æ°—ã«ãªã‚‹æ–¹ã¯ã“ã¡ã‚‰ã‚‚ã‚ˆã‚ã—ãã©ã†ãğŸ™‡ğŸ»â€â™‚ï¸

[https://hiroki-hasegawa.hatenablog.jp/entry/2023/01/14/223815:embed]

### Istiod

ã™ã§ã«`1-14-6`ã®IstiodãŒå‹•ã„ã¦ãŠã‚Šã€`1-15-4`ã«ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

ã“ã®Deploymenté…ä¸‹ã®Podã€Istiodã®å®Ÿä½“ã§ã‚ã‚‹`discovery`ã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¡ã¾ã™ã€‚

```sh
$ kubectl get deployment -n istio-system -l app=istiod

NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
istiod-1-14-6          1/1     1            1           47s # 1-14-6
```

### IngressGateway

IngressGatewayã¯Istiodã¨ã¯ç•°ãªã‚‹Namespaceã§å‹•ã„ã¦ãŠã‚Šã€ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

IngressGatewayã¯`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¡ã¾ã™ã€‚

```sh
$ kubectl get deployment -n istio-ingress

NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
istio-ingressgateway   1/1     1            1           47s
```

è£œè¶³ã¨ã—ã¦ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã—ã¦ã€Istiodã¨Gatewayã¯ç•°ãªã‚‹Namespaceã§å‹•ã‹ã™ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

> â†ªï¸ å‚è€ƒï¼šhttps://istio.io/latest/docs/setup/additional-setup/gateway/#deploying-a-gateway:title

### ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹

å„Namespaceã§ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒå‹•ã„ã¦ã„ã¾ã™ã€‚

ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®Podã¯`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¡ã¾ã™ã€‚

```sh
$ kubectl get deployment -n foo

NAME   READY   UP-TO-DATE   AVAILABLE   AGE
foo    2/2     1            1           47s
...
```

```sh
$ kubectl get deployment -n bar

NAME   READY   UP-TO-DATE   AVAILABLE   AGE
bar    2/2     1            1           47s
..
```

```sh
$ kubectl get deployment -n baz

NAME   READY   UP-TO-DATE   AVAILABLE   AGE
baz    2/2     1            1           47s
...
```

<br>

## ã€ï¼‘ã€‘ ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ã®æ¤œè¨¼

### ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨

ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ã«ã€ç¾åœ¨ã®Kubernetes ClusterãŒã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

> â†ªï¸ å‚è€ƒï¼š[Before you upgrade](https://istio.io/latest/docs/setup/upgrade/canary/#before-you-upgrade)

### `istioctl x precheck`ã‚³ãƒãƒ³ãƒ‰

`istioctl x precheck`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰è¦ä»¶ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

```sh
$ istioctl x precheck

âœ… No issues found when checking the cluster.Istiois safe to install or upgrade!
  To get started, check out https://istio.io/latest/docs/setup/getting-started/
```

å•é¡ŒãŒãªã‘ã‚Œã°ã€`istioctl`ã‚³ãƒãƒ³ãƒ‰ã¯`No issue ...`ã®æ–‡è¨€ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

ã‚‚ã—ã€å•é¡ŒãŒã‚ã‚‹å ´åˆã€`istioctl`ã‚³ãƒãƒ³ãƒ‰ã¯ã‚¨ãƒ©ãƒ¼æ–‡è¨€ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€Istioã®`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯kube-apiserverã¨é€šä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€kube-apiserverã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã™ãã‚‹ã›ã„ã§IstioãŒéå¯¾å¿œã§ã‚ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

### `kubectl get`ã‚³ãƒãƒ³ãƒ‰

#### â–¼ Istiodã®Deployment

`kubectl get`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ç¾åœ¨ã®Istiodã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¾ã™ğŸ‘€

ã¾ãšã¯Istiodã®Deploymentã‚’ç¢ºèªã™ã‚‹ã¨ã€`1-14-6`ã®DeploymentãŒã‚ã‚Šã¾ã™ã€‚

```sh
$ kubectl get deployment -n istio-system -l app=istiod

NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
istiod-1-14-6          1/1     1            1           47s # 1-14-6
```

`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã§ã„ã†ã¨ã€ä»¥ä¸‹ã®èµ¤æ ã®è¦ç´ ã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_webhook_1-1.png" alt="istio_canary-upgrade_webhook_1-1" style="zoom:100%;">

#### â–¼ `istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®Service

æ¬¡ã«ã€ `istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®Serviceã‚’ç¢ºèªã™ã‚‹ã¨ã€`1-14-6`ã®ServiceãŒã‚ã‚Šã¾ã™ã€‚

```sh
$ kubectl get service -n istio-system -l app=istiod

NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                 AGE
istiod-1-14-6   ClusterIP   10.96.93.151     <none>        15010/TCP,15012/TCP,443/TCP,15014/TCP   109s # 1-14-6
```

ã“ã®Serviceã¯ã€`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ™‚ã«ã€Webhookã‚’ä»²ä»‹ã—ã¾ã™ã€‚

`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã§ã„ã†ã¨ã€ä»¥ä¸‹ã®èµ¤æ ã®è¦ç´ ã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_webhook_1-2.png" alt="istio_canary-upgrade_webhook_1-2" style="zoom:100%;">

#### â–¼ å®›å…ˆã®Serviceã‚’æ±ºã‚ã‚‹MutatingWebhookConfiguration

æœ€å¾Œã«ã€MutatingWebhookConfigurationã‚’ç¢ºèªã™ã‚‹ã¨ã€`istio-revision-tag-<ã‚¨ã‚¤ãƒªã‚¢ã‚¹>`ã¨`istio-sidecar-injector-<ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·>`ã®MutatingWebhookConfigurationãŒã‚ã‚Šã¾ã™ã€‚

```sh
$ kubectl get mutatingwebhookconfigurations

NAME                            WEBHOOKS   AGE
istio-revision-tag-default      2          114s  # ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ç”¨
istio-sidecar-injector-1-14-6   2          2m16s # ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ç”¨ã®ãŸã‚ä»Šå›ã¯è¨€åŠã—ãªã„
```

`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã§ã„ã†ã¨ã€ä»¥ä¸‹ã®èµ¤æ ã®è¦ç´ ã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_webhook_1-3.png" alt="istio_canary-upgrade_webhook_1-3" style="zoom:100%;">

ã“ã‚Œã‚‰ã®ã†ã¡ã€å‰è€… (`istio-revision-tag-<ã‚¨ã‚¤ãƒªã‚¢ã‚¹>`) ã‚’ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚

ã“ã®MutatingWebhookConfigurationã¯ã€Webhookã®å®›å…ˆã®Serviceã‚’æ±ºã‚ã‚‹ãŸã‚ã€çµæœçš„ã«`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ±ºã‚ã¾ã™ã€‚

ã“ã“ã§ã€MutatingWebhookConfigurationã®`istio.io/rev`ãƒ©ãƒ™ãƒ«ã¨`istio.io/tag`ãƒ©ãƒ™ãƒ«ã®å€¤ã‚‚ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚

```sh
$ kubectl get mutatingwebhookconfiguration istio-revision-tag-default -o yaml \
    | yq '.metadata.labels'

...

istio.io/rev: 1-14-6
istio.io/tag: default

...
```

`istio.io/rev`ãƒ©ãƒ™ãƒ«ã¯Istiodã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€`istio.io/tag`ãƒ©ãƒ™ãƒ«ã¯ã“ã‚Œã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

`istio.io/rev`ãƒ©ãƒ™ãƒ«ã«å¿œã˜ã¦ã€Webhookã®å®›å…ˆã®ServiceãŒå¤‰ã‚ã‚Šã¾ã™ã€‚

> â†ªï¸ [https://istio.io/latest/blog/2021/revision-tags/:title]

<br>

## ã€ï¼’ã€‘ æ–°Istiodã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨

ãã‚Œã§ã¯ã€æ–°Istiodã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

> â†ªï¸ å‚è€ƒï¼š[Control plane](https://istio.io/latest/docs/setup/upgrade/canary/#control-plane)

### `istioctl version`ã‚³ãƒãƒ³ãƒ‰

æ–°ã—ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹Istiodã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€`istioctl`ã‚³ãƒãƒ³ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§æ±ºã¾ã‚Šã¾ã™ã€‚

ãã“ã§ã€`istioctl version`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ã“ã‚Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¾ã™ã€‚

```sh
$ istioctl version

client version: 1.15.4        # ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å…ˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
control plane version: 1.14.6 # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
data plane version: 1.14.6
```

### `istioctl install`ã‚³ãƒãƒ³ãƒ‰

ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å ´åˆã€`istioctl install`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯`revision`ã‚­ãƒ¼ã®å€¤ãŒ`canary`ã§ã™ãŒã€ä»Šå›ã¯`1-15-4`ã¨ã—ã¾ã™ã€‚

ã“ã®å€¤ã¯ã€IstioãŒä½¿ç”¨ã™ã‚‹æ§˜ã€…ãªKubernetesãƒªã‚½ãƒ¼ã‚¹ã®æ¥å°¾è¾ã‚„ã€å„ç¨®ãƒªã‚½ãƒ¼ã‚¹ã®`istio.io/rev`ãƒ©ãƒ™ãƒ«ã®å€¤ã«ãªã‚Šã¾ã™ã€‚

```sh
$ istioctl install --set revision=1-15-4

WARNING: Istio is being upgraded from 1.14.6 -> 1.15.4
WARNING: Before upgrading, you may wish to use 'istioctl analyze' to check for IST0002 and IST0135 deprecation warnings.

âœ… Istio core installed
âœ… Istiod installed
âœ… Ingress gateways installed
âœ… Installation complete

Thank you for installing Istio 1.15.  Please take a few minutes to tell us about your install/upgrade experience!
```

### `kubectl get`ã‚³ãƒãƒ³ãƒ‰

#### â–¼ Istiodã®Deployment

`kubectl get`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€`istioctl install`ã‚³ãƒãƒ³ãƒ‰ã§ä½•ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã®ã‹ã‚’ç¢ºèªã—ã¾ã™ğŸ‘€

ã¾ãšã¯Istiodã®Deploymentã‚’ç¢ºèªã™ã‚‹ã¨ã€`1-15-4`ã¨ã„ã†DeploymentãŒæ–°ã—ãå¢—ãˆã¦ã„ã¾ã™ã€‚

```sh
$ kubectl get deployment -n istio-system -l app=istiod

NAME            READY   UP-TO-DATE   AVAILABLE   AGE
istiod-1-14-6   1/1     1            1           47s # 1-14-6
istiod-1-15-4   1/1     1            1           47s # 1-15-4
```

æ¥å°¾è¾ã®`1-15-4`ã¯ã€`revision`ã‚­ãƒ¼ã®å€¤ã§æ±ºã¾ã‚Šã¾ã™ã€‚

ã“ã®æ®µéšã§ã¯ã€æ—§Istiodã¨æ–°IstioãŒä¸¦è¡Œçš„ã«ç¨¼åƒã—ã¦ãŠã‚Šã€kube-apiserverã¯ã¾ã æ—§Istiodã¨é€šä¿¡ã—ã¦ã„ã¾ã™

ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_webhook_2-1.png" alt="istio_canary-upgrade_webhook_2-1" style="zoom:100%;">

#### â–¼ `istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®Service

æ¬¡ã« `istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®Serviceã‚’ç¢ºèªã™ã‚‹ã¨ã€`istiod-1-15-4`ã¨ã„ã†ServiceãŒæ–°ã—ãå¢—ãˆã¦ã„ã¾ã™ã€‚

```sh
$ kubectl get service -n istio-system -l app=istiod

NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                 AGE
istiod-1-14-6   ClusterIP   10.96.93.151     <none>        15010/TCP,15012/TCP,443/TCP,15014/TCP   109s # 1-14-6
istiod-1-15-4   ClusterIP   10.104.186.250   <none>        15010/TCP,15012/TCP,443/TCP,15014/TCP   87s  # 1-15-4
```

ã“ã®æ®µéšã§ã¯ã€ã¾ã Webhookã®å®›å…ˆã¯`istiod-1-14-6`ã®Serviceã§ã™ã€‚

ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_webhook_2-2.png" alt="istio_canary-upgrade_webhook_2-2" style="zoom:100%;">

#### â–¼ å®›å…ˆã®Serviceã‚’æ±ºã‚ã‚‹MutatingWebhookConfiguration

æœ€å¾Œã«MutatingWebhookConfigurationã‚’ç¢ºèªã™ã‚‹ã¨ã€`istio-sidecar-injector-1-15-4`ã¨ã„ã†MutatingWebhookConfigurationãŒæ–°ã—ãå¢—ãˆã¦ã„ã¾ã™ã€‚

```sh
$ kubectl get mutatingwebhookconfigurations

NAME                            WEBHOOKS   AGE
istio-revision-tag-default      2          114s  # ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ä½¿ç”¨ã™ã‚‹
istio-sidecar-injector-1-14-6   2          2m16s # ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ã¯ä½¿ç”¨ã—ãªã„
istio-sidecar-injector-1-15-4   2          2m16s # åŒä¸Š
```

ãŸã ã—ã€ã“ã‚Œã¯ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ã¯ä½¿ç”¨ã›ãšã€`istio-revision-tag-<ã‚¨ã‚¤ãƒªã‚¢ã‚¹>`ã®MutatingWebhookConfigurationã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_webhook_2-3.png" alt="istio_canary-upgrade_webhook_2-3" style="zoom:100%;">

â€» å®Ÿã¯ã€ä»–ã«ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã‚‚ã®ãŒã‚ã‚‹ã®ã§ã™ãŒã€è©±ã‚’ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã«ã€ä»Šå›ã¯è¨€åŠã—ã¦ã„ã¾ã›ã‚“ğŸ™‡ğŸ»â€â™‚ï¸

<br>

## ã€ï¼“ã€‘ ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·ã®å¤‰æ›´

### ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨

å‰è¿°ã®æ‰‹é †ã§ã€MutatingWebhookConfigurationã®`istio.io/rev`ãƒ©ãƒ™ãƒ«ã¨`istio.io/tag`ãƒ©ãƒ™ãƒ«ã®å€¤ã‚’ç¢ºèªã—ãŸã‹ã¨æ€ã„ã¾ã™ã€‚

```sh
$ kubectl get mutatingwebhookconfiguration istio-revision-tag-default -o yaml \
    | yq '.metadata.labels'

...

istio.io/rev: 1-14-6
istio.io/tag: default

...
```

ã“ã®æ‰‹é †ã§ã¯ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®`istio.io/tag`ãƒ©ãƒ™ãƒ«ã¯ãã®ã¾ã¾ã«ã€`istio.io/rev`ãƒ©ãƒ™ãƒ«ã®å€¤ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

> â†ªï¸ å‚è€ƒï¼š
>
> - [Default tag](https://istio.io/latest/docs/setup/upgrade/canary/#default-tag)
> - [Safely upgrade the Istio control plane with revisions and tags](https://istio.io/latest/blog/2021/revision-tags/)

### `istioctl tag set`ã‚³ãƒãƒ³ãƒ‰

`istioctl tag set`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€`istio.io/rev`ãƒ©ãƒ™ãƒ«ã®å€¤ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

```sh
$ istioctl tag set default --revision 1-15-4 --overwrite
```

å®Ÿè¡Œå¾Œã«ã€ã‚‚ã†ä¸€åº¦MutatingWebhookConfigurationã‚’ç¢ºèªã™ã‚‹ã¨ã€`istio.io/rev`ãƒ©ãƒ™ãƒ«ã®å€¤ãŒå¤‰ã‚ã£ã¦ã„ã¾ã™ã€‚

```sh
$ kubectl get mutatingwebhookconfiguration istio-revision-tag-default -o yaml \
    | yq '.metadata.labels'

...

istio.io/rev: 1-15-4
istio.io/tag: default

...
```

ã“ã‚Œã«ã‚ˆã‚Šã€Webhookã®å®›å…ˆãŒ`1-15-4`ã®Serviceã¨ãªã‚‹ãŸã‚ã€`1-15-4`ã®`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_webhook_3.png" alt="istio_canary-upgrade_webhook_3" style="zoom:100%;">

<br>

## ã€ï¼”ã€‘ IngressGatewayã‚’ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰

### ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨

Webhookã®å®›å…ˆãŒ`1-15-4`ã®Serviceã«å¤‰ã‚ã£ãŸã¨ã“ã‚ã§ã€IngressGatewayã‚’ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

> â†ªï¸ å‚è€ƒï¼š[In place upgrade](https://istio.io/latest/docs/setup/additional-setup/gateway/#in-place-upgrade)

### `kubectl rollout restart`ã‚³ãƒãƒ³ãƒ‰

`kubectl rollout restart`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€IngressGatewayã‚’ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```sh
$ kubectl rollout restart deployment istio-ingressgateway-n istio-ingress
```

å†ä½œæˆã—ãŸPodã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã¨ã€`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’`1-15-4`ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã¦ã„ã¾ã™ã€‚

```sh
$ kubectl get pod bar -n bar -o yaml | yq '.spec.containers[].image'

docker.io/istio/proxyv2:1.15.4 # istio-proxyã‚³ãƒ³ãƒ†ãƒŠ
```

ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_rollout-restart_2.png" alt="istio_canary-upgrade_rollout-restart_2" style="zoom:100%;">

ãªãŠã€IngressGatewayã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ™‚ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ãŒé®æ–­ã•ã‚Œã¦ã—ã¾ã†ã¨æ€ã£ãŸæ–¹ãŒã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã“ã®ç‚¹ã«ã¤ã„ã¦ã¯ã€DeploymentãŒãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§IngressGatewayã®Podã‚’å…¥ã‚Œæ›¿ãˆã‚‹ãŸã‚ã€å®‰å¿ƒã—ã¦ã„ãŸã ã„ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“ğŸ™†â€â™‚ï¸

<br>

## ã€ï¼•ã€‘ ä¸€éƒ¨ã®Namespaceã®`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰

### ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨

ç¶šã‘ã¦ã€ä¸€éƒ¨ã®Namespaceã®`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

Podã®å†ä½œæˆã«ã‚ˆã‚Šã€æ–°Istiodã®`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠãŒã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã•ã‚Œã‚‹ãŸã‚ã€‚`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

> â†ªï¸ å‚è€ƒï¼š[Data plane](https://istio.io/latest/docs/setup/upgrade/canary/#data-plane)

### `kubectl rollout restart`ã‚³ãƒãƒ³ãƒ‰

å‰æã«ã‚ã‚‹ã‚ˆã†ã«ã€Namespaceã«ã¯ `foo` `bar` `baz` ãŒã‚ã‚Šã¾ã™ã€‚

`kubectl rollout restart`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€`bar`ã®`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```sh
$ kubectl rollout restart deployment bar -n bar
```

å†ä½œæˆã—ãŸPodã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã¨ã€`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’`1-15-4`ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã¦ã„ã¾ã™ã€‚

```sh
$ kubectl get pod bar -n bar -o yaml | yq '.spec.containers[].image'

bar-app:1.0 # ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹
docker.io/istio/proxyv2:1.15.4 # istio-proxyã‚³ãƒ³ãƒ†ãƒŠ
```

ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_rollout-restart_3.png" alt="istio_canary-upgrade_rollout-restart_3" style="zoom:100%;">

<br>

## ã€ï¼–ã€‘ ãƒ¦ãƒ¼ã‚¶ã®æ‰‹ã‚’å€Ÿã‚ŠãŸãƒ†ã‚¹ãƒˆ

### ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨

Istioã‚’éƒ¨åˆ†çš„ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ãŸã¨ã“ã‚ã§ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå®Œäº†ã—ãŸNamespaceã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰‹ã‚’å€Ÿã‚Šã¦å®Ÿåœ°çš„ã«ãƒ†ã‚¹ãƒˆã—ã¾ã™ (ä¾‹ï¼šè©²å½“ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒåŸºæº–å€¤ã‚’æº€ãŸã™ã‹) ã€‚

ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_rollout-restart_4.png" alt="istio_canary-upgrade_rollout-restart_4" style="zoom:100%;">

### ã‚‚ã—å•é¡ŒãŒèµ·ã“ã£ãŸå ´åˆ

ã‚‚ã—å•é¡ŒãŒèµ·ã“ã£ãŸå ´åˆã€`1-14-6`ã«ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã„ãã¾ã™ã€‚

`istioctl tag set`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€`istio.io/rev`ãƒ©ãƒ™ãƒ«ã®å€¤ã‚’å…ƒã«æˆ»ã—ã¾ã™ã€‚

```sh
$ istioctl tag set default --revision 1-14-6 --overwrite
```

ãã®å¾Œã€`kubectl rollout restart`ã‚³ãƒãƒ³ãƒ‰ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã€`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã¾ã™ã€‚

<br>

## ã€ï¼—ã€‘ `istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã®æ®µéšçš„ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰

### ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨

å…ˆã®Namespaceã§å•é¡ŒãŒèµ·ã“ã‚‰ãªã‘ã‚Œã°ã€æ®‹ã£ãŸNamespace (`foo`ã€`baz`ã€...) ã®`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚‚æ®µéšçš„ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã„ãã¾ã™ã€‚

### `kubectl rollout restart`ã‚³ãƒãƒ³ãƒ‰

åŒæ§˜ã«`kubectl rollout restart`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```sh
$ kubectl rollout restart deployment foo -n foo

$ kubectl rollout restart deployment baz -n baz

...
```

æœ€çµ‚çš„ã«ã€å…¨ã¦ã®Namespacemã®`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠãŒæ–°ã—ããªã‚Šã¾ã™ã€‚

ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_rollout-restart_5.png" alt="istio_canary-upgrade_rollout-restart_5" style="zoom:100%;">

<br>

## ã€ï¼˜ã€‘ æ—§Istiodã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨

æœ€å¾Œã«ã€æ—§Istiodã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

> â†ªï¸ å‚è€ƒï¼š[Uninstall old control plane](https://istio.io/latest/docs/setup/upgrade/canary/#uninstall-old-control-plane)

### `istioctl uninstall`ã‚³ãƒãƒ³ãƒ‰

`istioctl uninstall`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€æ—§Istiodã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
$ istioctl uninstall --revision 1-14-6

âœ… Uninstall complete
```

ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_rollout-restart_6.png" alt="istio_canary-upgrade_rollout-restart_6" style="zoom:100%;">

### `kubectl get`ã‚³ãƒãƒ³ãƒ‰

#### â–¼ Istiodã®Deployment

`kubectl get`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€`istioctl uninstall`ã‚³ãƒãƒ³ãƒ‰ã§ä½•ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã®ã‹ã‚’ç¢ºèªã—ã¾ã™ğŸ‘€

ã¾ãšã¯Istiodã®Deploymentã‚’ç¢ºèªã™ã‚‹ã¨ã€`1-14-6`ã¨ã„ã†DeploymentãŒç„¡ããªã£ã¦ã„ã¾ã™ã€‚

```sh
$ kubectl get deployment -n istio-system -l app=istiod

NAME            READY   UP-TO-DATE   AVAILABLE   AGE
istiod-1-15-4   1/1     1            1           47s # 1-15-4
```

#### â–¼ `istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®Service

æ¬¡ã« `istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®Serviceã‚’ç¢ºèªã™ã‚‹ã¨ã€`istiod-1-14-6`ã¨ã„ã†ServiceãŒç„¡ããªã£ã¦ã„ã¾ã™ã€‚

```sh
$ kubectl get service -n istio-system -l app=istiod

NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                 AGE
istiod-1-15-4   ClusterIP   10.104.186.250   <none>        15010/TCP,15012/TCP,443/TCP,15014/TCP   87s  # 1-15-4
```

#### â–¼ å®›å…ˆã®Serviceã‚’æ±ºã‚ã‚‹MutatingWebhookConfiguration

æœ€å¾Œã«MutatingWebhookConfigurationã‚’ç¢ºèªã™ã‚‹ã¨ã€`istio-sidecar-injector-1-14-6`ã¨ã„ã†MutatingWebhookConfigurationãŒç„¡ããªã£ã¦ã„ã¾ã™ã€‚

```sh
$ kubectl get mutatingwebhookconfigurations

NAME                            WEBHOOKS   AGE
istio-revision-tag-default      2          114s  # æ¬¡ã®ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ã‚‚ä½¿ç”¨ã™ã‚‹
istio-sidecar-injector-1-15-4   2          2m16s
```

ã“ã‚Œã§ã€æ–°Istiodã«å®Œå…¨ã«å…¥ã‚Œæ›¿ã‚ã£ãŸãŸã‚ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯å®Œäº†ã§ã™ã€‚

ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_webhook_4.png" alt="istio_canary-upgrade_webhook_4" style="zoom:100%;">

â€» å®Ÿã¯ã€ä»–ã«ã‚‚ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã‚‚ã®ãŒã‚ã‚‹ã®ã§ã™ãŒã€è©±ã‚’ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã«ã€ä»Šå›ã¯è¨€åŠã—ã¦ã„ã¾ã›ã‚“ğŸ™‡ğŸ»â€â™‚ï¸

<br>

# 02. ãŠã‚ã‚Šã«

[å‰ç·¨](https://hiroki-hasegawa.hatenablog.jp/entry/2023/02/26/202400)ã¨å¾Œç·¨ã«åˆ†ã‘ã¦ã€Istioã®å®‰å…¨ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®ä»•çµ„ã¿ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¾ã—ãŸã€‚

Istioã¸ã®æ„›ãŒæº¢ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚

Istioã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã§ããªã„ã¨ã€æ§˜ã€…ãªå•é¡Œ (ä¾‹ï¼š`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ããšã€ã‚¢ãƒ—ãƒªã®Podè‡ªä½“ã‚’ä½œæˆã§ããªã„) ãŒèµ·ã“ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ğŸ˜­

ã“ã‚Œã‹ã‚‰Istioã‚’æ¡ç”¨äºˆå®šã®æ–¹ã¯ã€å®‰å…¨ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã‚‚åˆã‚ã›ã¦èª¿æŸ»ã—ã¦ãŠãã¨ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ğŸ‘

<br>
