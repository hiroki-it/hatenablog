---
Title: 【Istio⛵️】安全なアップグレード手法の仕組み (前編)
Category:
  - Istio
  - Envoy
Date: 2023-02-26T20:25:48+09:00
URL: https://hiroki-hasegawa.hatenablog.jp/entry/2023/02/26/202400
EditURL: https://blog.hatena.ne.jp/hiroki-hasegawa/hiroki-hasegawa.hatenablog.jp/atom/entry/4207112889966724569
Draft: true
---

<br>

[:contents]

<br>

# 01. はじめに

どーも。

隠しません。好きなラジオは、有吉弘行のサンデーナイトドリーマーです。

今回は、Istioの安全なアップグレード手法の仕組みに関する記事を投稿しました🚀

執筆時点 (2023/02/15) では、Istiodコントロールプレーン (以降、Istiodとします) のアップグレード手法には、『インプレース方式』と『カナリア方式』があります。

また少しややこしいのですが、手順の中で合わせてアップグレードするIngressGatewayにも、その手法に『インプレース方式』と『カナリア方式』があります😵‍💫

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_upgrade_list.png" alt="istio_upgrade_list" style="zoom:3.5%;">

今回は、Istiodでは『カナリアアップグレード』、IngressGatewayでは『インプレースアップグレード』を採用するとします。

それでは、Istioの安全なアップグレード手法の仕組みをもりもり布教しようと思います😗 (沼のまわりに餌をまく)

> ↪️ 参考：
>
> - [https://istio.io/latest/docs/setup/upgrade/canary/:title]
> - [https://istio.io/latest/docs/setup/additional-setup/gateway/#upgrading-gateways:title]

<br>

# 02. Istioのアップグレード手法を説明する前に

## カナリアリリースとは

Istiodのカナリアアップグレードが理解しやすくなるように、カナリアリリースから説明したいと思います。

カナリアリリースは、実際のユーザーにテストしてもらいながらリリースする手法です。

もしカナリアリリースをご存知の方は、 [03. アップグレード手法の概要](#03-アップグレード手法の概要) まで飛ばしてください🙇🏻‍♂️

<br>

## カナリアリリースの手順

カナリアリリースは、一部のユーザーを犠牲にすることになる一方で、アプリを実地的にテストできる点で優れています。

手順を交えながら説明します。

> ↪️ 参考：[https://martinfowler.com/bliki/CanaryRelease.html:title]

#### 【１】

旧環境のアプリを残したまま、新環境をリリースする。ここ段階では、全てのユーザー (`100`%) を旧環境にルーティングする。

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/canary-release_1.png" alt="canary-release_1" style="zoom:2.5%">

#### 【２】

ロードバランサーで重み付けを変更し、一部のユーザー (ここでは`10`%) を新環境にルーティングする。

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/canary-release_2.png" alt="canary-release_2" style="zoom:2.5%;">

#### 【３】

ユーザーの手を借りて新環境を実地的にテストする (例：該当のメトリクスが基準値以下を満たすか) 。

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/canary-release_3.png" alt="canary-release_3" style="zoom:2.5%;">

#### 【３】

新環境に問題が起こらなければ、重み付けを変更し、全てのユーザー (`100`%) を新環境にルーティングする。

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/canary-release_4.png" alt="canary-release_4" style="zoom:2.5%">

<br>

## 『カナリアリリース』の呼称の由来

カナリアリリースについては、その呼称の由来を知ると、より理解が深まります。

カナリアリリースは、20世紀頃の炭坑労働者の危機察知方法に由来します。

炭鉱内には有毒な一酸化炭素が発生する場所がありますが、これは無色無臭なので、気づくことに遅れる可能性があります。

そこで当時の炭鉱労働者は、一酸化炭素に敏感な『カナリア』を炭鉱内に持ち込み、カナリアの様子から一酸化炭素の存在を察知するようにしていたそうです。

つまり、先の『犠牲になる一部のユーザー』が、ここでいうカナリアというわけです😨

<figure><img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/canary_release_origin.png" alt="canary_release_origin" style="zoom:55%;"><figcaption>引用：George McCaa, U.S. Bureau of Mines</figcaption></figure>

> ↪️ 参考：
>
> - [https://www.linkedin.com/pulse/canary-deployment-simple-words-jakub-hajek/:title]
> - [https://earthlymission.com/canary-resuscitation-device-detect-dangerous-gases-carbon-monoxide-coal-mines/]

<br>

# 03. アップグレード手法の概要

## 手順の概要

カナリアリリースについて理解したところで、Istioの安全なアップグレード手法の概要を説明します。

おおよそ以下の手順からなります。

#### 【１】

旧Istiodが稼働しています。

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_1.png" alt="istio_canary-upgrade_1" style="zoom:5%">

#### 【２】

新Istiod (`discovery`コンテナ) をインストールします。

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_2.png" alt="istio_canary-upgrade_2" style="zoom:5%">

#### 【３】

新Istiodの`istio-proxy`コンテナをインジェクションできるように、MutatingWebhookConfigurationのリビジョン番号を変更します。

#### 【４】

IngressGatewayをインプレースアップグレードします。

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_4.png" alt="istio_canary-upgrade_4" style="zoom:5%">

#### 【５】

一部のNamespaceで、`istio-proxy`コンテナをカナリアアップグレードします。

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_5.png" alt="istio_canary-upgrade_5" style="zoom:5%">

ここで、カナリアリリースのような重み付けがなく、カナリアアップグレードの『カナリア』という呼称に違和感を持つ方がいるかもしれません。

これについては、全てのNamespaceの`istio-proxy`コンテナを一斉にアップグレードするのではなく、段階的にアップグレードしていく様子を『カナリア』と呼称している、と個人的に推測しています。

もし『カナリアアップグレード』の由来をご存じの方は、教えていただきたいです🙇🏻‍♂️

#### 【６】

ユーザーの手を借りて、実地的にテストします (例：該当のメトリクスが基準値を満たすか) 。

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_6.png" alt="istio_canary-upgrade_6" style="zoom:5%">

#### 【７】

新Istiodの`istio-proxy`コンテナに問題が起こらなければ、他のNamespaceでも`istio-proxy`
コンテナを段階的にカナリアアップグレードしていきます。

一方でもし問題が起これば、Namespaceの`istio-proxy`コンテナとIngressGatewayをダウングレードします。

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_7.png" alt="istio_canary-upgrade_7" style="zoom:5%">

#### 【８】

最後に、旧Istiodをアンインストールします。

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_canary-upgrade_8.png" alt="istio_canary-upgrade_8" style="zoom:5%">

> ↪️ 参考：[https://istio.io/latest/docs/setup/upgrade/canary/#control-plane:title]

<br>

