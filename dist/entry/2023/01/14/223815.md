---
Title: ã€Istioâ›µï¸ã€‘ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿
Category:
  - Istio
  - Envoy
Date: 2023-01-14T22:38:15+09:00
URL: https://hiroki-hasegawa.hatenablog.jp/entry/2023/01/14/223815
EditURL: https://blog.hatena.ne.jp/hiroki-hasegawa/hiroki-hasegawa.hatenablog.jp/atom/entry/4207112889950248449
---

<br>

[:contents]

<br>

# 01. ã¯ã˜ã‚ã«

ã©ãƒ¼ã‚‚ã€‚

æ­£æœˆã§æ¿€å¤ªã‚Šã—ã¾ã—ãŸãŒã€ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ğŸ™‹ğŸ»â€â™‚ï¸

å‰å›ã®è¨˜äº‹ã®æ™‚ã¨åŒæ§˜ã«ã€æœ€è¿‘ã®æ¥­å‹™ã§ã‚‚ã€ã‚ªãƒ³ãƒ—ãƒ¬ã¨AWSä¸Šã®Istioã‚’ã²ãŸã™ã‚‰å­å®ˆã‚Šã—ã¦ã„ã¾ã™ã€‚

[https://hiroki-hasegawa.hatenablog.jp/entry/2022/12/25/060000:embed]

å­å®ˆã‚Šã®å‰æçŸ¥è­˜ã®å¾©ç¿’ã‚‚ã‹ã­ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã‚’å®Ÿè£…ã™ã‚‹Istioã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹è¨˜äº‹ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸğŸš€

åŸ·ç­†æ™‚ç‚¹ (2023/01/14) ã§ã¯ã€IstioãŒå®Ÿè£…ã™ã‚‹ã‚µãƒ¼ãƒ“ãƒ¡ãƒƒã‚·ãƒ¥ã«ã¯ã€ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥ã€ã¨ã€ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆãƒ¡ãƒƒã‚·ãƒ¥ã€ãŒã‚ã‚Šã¾ã™ã€‚

ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥ã®ä»•çµ„ã¿ã®è»¸ã«ãªã£ã¦ã„ã‚‹ã‚‚ã®ã¯ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã§ã‚ã‚‹`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã§ã™ã€‚

Istioã¯ã€Kubernetesã®Podã®ä½œæˆæ™‚ã«ã€`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’Podå†…ã«è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ (æ³¨å…¥) ã—ã¾ã™

æœ¬è¨˜äº‹ã§ã¯ã€ã“ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ğŸ˜—

<br>

# 02. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥

## ãªãœã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒå¿…è¦ãªã®ã‹

ãã‚‚ãã‚‚ã€ãªãœã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒå¿…è¦ã«ãªã£ãŸã®ã§ã—ã‚‡ã†ã‹ğŸ¤”

ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚·ã‚¹ãƒ†ãƒ ã«ã¯ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›ºæœ‰ã®ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œ (ä¾‹ï¼šã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®å¿…è¦æ€§ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã®æš—å·åŒ–ã€ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ä½œæˆã€ãªã©) ãŒã‚ã‚Šã¾ã™ã€‚

ã‚¢ãƒ—ãƒªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒå„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹å†…ã«ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œã«é–¢ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚Œã°ã€ã“ã‚Œã‚‰ã®å•é¡Œã®è§£æ±ºã§ãã¾ã™ã€‚

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/service-mesh_layer.png" alt="service-mesh_layer" style="zoom:50%;">

ã—ã‹ã—ã€ã‚¢ãƒ—ãƒªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¯ã‚¢ãƒ—ãƒªé ˜åŸŸã®å•é¡Œã«è²¬å‹™ã‚’æŒã¡ã€ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œã¯ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§è§£æ±ºã™ã‚‹ã‚ˆã†ã«ã—ãŸæ–¹ãŒã€äº’ã„ã«åŠ¹ç‡çš„ã«é–‹ç™ºã§ãã¾ã™ã€‚

ãã“ã§ã€ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦åˆ‡ã‚Šåˆ†ã‘ã¾ã™ã€‚

![service-mesh_sidecar](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/service-mesh_sidecar.png)

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®è²¬å‹™ã‚’åˆ†é›¢ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€å‡é›†åº¦ãŒé«˜ããªã‚‹ã€‚

ã¾ãŸã€ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦å„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã«æä¾›ã§ãã‚‹ãŸã‚ã€å˜ç´”æ€§ãŒé«˜ã¾ã‚Šã¾ã™ã€‚

ã“ã†ã„ã£ãŸæµã‚Œã®ä¸­ã§ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ä½¿ç”¨ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ãŒç™»å ´ã—ã¾ã—ãŸã€‚

> â†ªï¸ å‚è€ƒï¼š
>
> - [https://servicemesh.es/:title]
> - [https://www.opsmx.com/blog/what-is-service-mesh-and-why-is-it-necessary/:title]

<br>

## ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥

Istioã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ (ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥) ã¯ã€

- ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ (`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠ) ãŒç¨¼åƒã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ãƒ³
- ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ä¸­å¤®é›†æ¨©çš„ã«ç®¡ç†ã™ã‚‹Istiod (`discovery`ã‚³ãƒ³ãƒ†ãƒŠ) ãŒç¨¼åƒã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³

ã‹ã‚‰ãªã‚Šã¾ã™ã€‚

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_sidecar-mesh_architecture.png" alt="istio_sidecar-mesh_architecture" style="zoom:100%;">

> â†ªï¸ å‚è€ƒï¼š[https://istio.io/latest/docs/ops/deployment/architecture/:title]

<br>

# 03. admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã«ã¤ã„ã¦

## admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã¨ã¯

Istioã®Podå†…ã¸ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®å‰æçŸ¥è­˜ã¨ã—ã¦ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã‚’ç†è§£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã‚‚ã—ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã‚’ã”å­˜çŸ¥ã®æ–¹ã¯ã€ [04. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿](#04-ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿) ã¾ã§é£›ã°ã—ã¦ãã ã•ã„ğŸ™‡ğŸ»â€â™‚ï¸

kube-apiserverã§ã¯ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã¨ã—ã¦æœ‰åŠ¹åŒ–ã§ãã¾ã™ã€‚

æœ‰åŠ¹åŒ–ã™ã‚‹ã¨ã€èªè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã¨èªå¯ã‚¹ãƒ†ãƒƒãƒ—ã®å¾Œã«mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã¨validating-admissionã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã§ãã€admissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç¨®é¡ã«å¿œã˜ãŸå‡¦ç†ã‚’æŒ¿å…¥ã§ãã¾ã™ã€‚

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (`kubectl`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€Kubernetesãƒªã‚½ãƒ¼ã‚¹) ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (ä¾‹ï¼šKubernetesãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ä½œæˆ/æ›´æ–°/å‰Šé™¤ã€kube-apiserverã‹ã‚‰ã®ãƒ—ãƒ­ã‚­ã‚·ã¸ã®è»¢é€) æ™‚ã«ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã§admissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã‚ˆã‚‹å‡¦ç† (ä¾‹ï¼šã‚¢ãƒ‰ã‚ªãƒ³ãƒ“ãƒ«ãƒˆã‚¤ãƒ³å‡¦ç†ã€ç‹¬è‡ªå‡¦ç†) ã‚’ç™ºç«ã•ã›ã‚‰ã‚Œã¾ã™ã€‚

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/kubernetes_admission-controllers_architecture.png" alt="kubernetes_admission-controllers_architecture" style="zoom:100%;">

> â†ªï¸ å‚è€ƒï¼š
>
> - [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/:title]
> - [https://www.amazon.com/dp/1492056472/:title]

<br>

## admissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç¨®é¡

admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã®admissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã¯ã€ãŸãã•ã‚“ã®ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚

IstioãŒPodå†…ã«ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã™ã‚‹æ™‚ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚¢ãƒ‰ã‚ªãƒ³ã¯ã€ã€MutatingAdmissionWebhookã€ã§ã™ã€‚

- CertificateApproval
- CertificateSigning
- CertificateSubjectRestriction
- DefaultIngressClass
- DefaultStorageClass
- DefaultTolerationSeconds
- LimitRanger
- **MutatingAdmissionWebhook** ğŸ‘ˆ ã“ã‚Œï¼
- NamespaceLifecycle
- PersistentVolumeClaimResize
- PodSecurity
- Priority
- ResourceQuota
- RuntimeClass
- ServiceAccount
- StorageObjectInUseProtection
- TaintNodesByCondition
- ValidatingAdmissionWebhook

> â†ªï¸ å‚è€ƒï¼š[https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#which-plugins-are-enabled-by-default:title]

<br>

## MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³

### MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã¯

MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—æ™‚ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’å¤‰æ›´ã™ã‚‹å‡¦ç†ã‚’ãƒ•ãƒƒã‚¯ã§ãã¾ã™ã€‚

ãƒ•ãƒƒã‚¯ã™ã‚‹å…·ä½“çš„ãªå‡¦ç†ã¨ã—ã¦ã€webhookã‚µãƒ¼ãƒãƒ¼ã«AdmissionRequestãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦é€ä¿¡ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®AdmissionResponseã«å¿œã˜ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’å‹•çš„ã«å¤‰æ›´ã—ã¾ã™ã€‚

MutatingWebhookConfigurationã§ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç™ºç«æ¡ä»¶ã‚„webhookã‚µãƒ¼ãƒãƒ¼ã®å®›å…ˆæƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚

MutatingWebhookConfigurationã®å…·ä½“çš„ãªå®Ÿè£…ã«ã¤ã„ã¦ã¯ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã®ä¸­ã§èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

<img src="https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/admission-controllers_mutating-admission.png" alt="admission-controllers_mutating-admission" style="zoom:100%;">

> â†ªï¸ å‚è€ƒï¼š
>
> - [https://medium.com/ibm-cloud/diving-into-kubernetes-mutatingadmissionwebhook-6ef3c5695f74/:title]
> - [https://gashirar.hatenablog.com/entry/2020/10/31/141357/:title]
> - [https://blog.mosuke.tech/entry/2022/05/15/admission-webhook-1/:title]

### AdmissionReviewã€AdmissionRequestã€AdmissionResponse

#### â–¼ AdmissionReview

AdmissionReviewã¯ä»¥ä¸‹ã®ã‚ˆã†ãªJSONã§ã‚ã‚Šã€kube-apiserverã¨webhookã‚µãƒ¼ãƒãƒ¼ã®é–“ã§AdmissionRequestã¨AdmissionResponseã‚’é‹ã³ã¾ã™ã€‚

```yaml
{
  "apiVersion": "admission.k8s.io/v1",
  "kind": "AdmissionReview",
  # AdmissionRequest
  "request": {},
  # AdmissionResponse
  "response": {},
}
```

> â†ªï¸ å‚è€ƒï¼š[https://pkg.go.dev/k8s.io/api@v0.24.3/admission/v1#AdmissionReview:title]

#### â–¼ AdmissionRequest

AdmissionRequestã¯ä»¥ä¸‹ã®ã‚ˆã†ãªJSONã§ã™ã€‚

kube-apiserverãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰å—ä¿¡ã—ãŸæ“ä½œå†…å®¹ãŒæŒã¤ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ä¾‹ã§æŒ™ã’ãŸAdmissionRequestã§ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒDeploymentã‚’CREATEæ“ä½œã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’kube-apiserverã«é€ä¿¡ã—ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```yaml
{
  "apiVersion": "admission.k8s.io/v1",
  "kind": "AdmissionReview",
  # AdmissionRequest
  "request": {

    ...

    # å¤‰æ›´ã•ã‚Œã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚’è¡¨ã™ã€‚
    "resource": {
      "group": "apps",
      "version": "v1",
      "resource": "deployments"
    },
    # kube-apiserverã®æ“ä½œã®ç¨®é¡ã‚’è¡¨ã™ã€‚
    "operation": "CREATE",

    ...

  }
}
```

> â†ªï¸ å‚è€ƒï¼š[https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request:title]

#### â–¼ AdmissionResponse

ä¸€æ–¹ã§AdmissionResponseã¯ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªJSONã§ã™ã€‚

AdmissionResponseã«å¿œã˜ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆå¤‰æ›´å‡¦ç†ã‚’`patch`ã‚­ãƒ¼ã®å€¤ã«æŒã¡ã€ã“ã‚Œã¯base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

```yaml
{
  "apiVersion": "admission.k8s.io/v1",
  "kind": "AdmissionReview",
  # AdmissionResponse
  "response": {
      "uid": "<value from request.uid>",
      # å®›å…ˆã®webhookã‚µãƒ¼ãƒãƒ¼ãŒå—ä¿¡ã—ãŸã‹å¦ã‹ã‚’è¡¨ã™ã€‚
      "allowed": true,
      # Pathã«ã‚ˆã‚‹Patchå‡¦ç†ã‚’è¡Œã†ã€‚
      "patchType": "JSONPatch",
      # Patchå‡¦ç†ã®å¯¾è±¡ã¨ãªã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã¨å‡¦ç†å†…å®¹ã‚’è¡¨ã™ã€‚base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã€‚
      "patch": "W3sib3AiOiAiYWRkIiwgInBhdGgiOiAiL3NwZWMvcmVwbGljYXMiLCAidmFsdWUiOiAzfV0=",
    },
}
```

ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å€¤ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã¿ã‚‹ã¨ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªpatchå‡¦ç†ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

```yaml
# patchã‚­ãƒ¼ã‚’base64æ–¹å¼ã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸå ´åˆ
[{"op": "add", "path": "/spec/replicas", "value": 3}]
```

ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«å¯¾ã™ã‚‹æ“ä½œ (`op`) ã€ã‚­ãƒ¼ (`path`) ã€å€¤ (`value`) ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

kube-apiserverãŒã“ã‚Œã‚’å—ä¿¡ã™ã‚‹ã¨ã€æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ (`.spec.replicas`) ã«å€¤ (`3`) ã«è¿½åŠ ã—ã¾ã™ã€‚

> â†ªï¸ å‚è€ƒï¼š[https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#response:title]

<br>

# 04. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿

## å…¨ä½“ã®ãƒ•ãƒ­ãƒ¼

å‰æçŸ¥è­˜ã‚’è¸ã¾ãˆãŸä¸Šã§ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã®ä»•çµ„ã¿ã®ä¸­ã§ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠãŒã©ã®ã‚ˆã†ã«Podã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã•ã‚Œã‚‹ã®ã‹ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

æœ€åˆã«ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã£ã¦ã„ã¾ã™ã€‚

**ç”»åƒã®æ–‡å­—ãŒå°ã•ããªã£ã¦ã—ã¾ã£ãŸãŸã‚ã€æ‹¡å¤§ã—ã¦ã„ãŸã ã‘ã‚‹ã¨**ğŸ™‡ğŸ»â€â™‚ï¸

![istio_container-injection_flow](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_container-injection_flow.png)

> â†ªï¸ å‚è€ƒï¼š[https://www.amazon.co.jp/dp/B09XN9RDY1/:title]

<br>

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¡ï¸ kube-apiserver

### ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€

ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¡ï¸ kube-apiserverã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚

![istio_container-injection_flow_red_1](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_container-injection_flow_red_1.png)

### ã€ï¼‘ã€‘ Podã®ä½œæˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ã¾ãšã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒkube-apiserverã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ã“ã‚ã§ã™ã€‚

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (Deploymentã€DaemonSetã€StatefulSetã€ã‚’å«ã‚€) ã¯ã€Podã®ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’kube-apiserverã«é€ä¿¡ã—ã¾ã™ã€‚

ã“ã®æ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã¨ã—ã¾ã™ã€‚

```sh
# Podã‚’ä½œæˆã™ã‚‹ã€‚
$ kubectl apply -f foo-pod.yaml
```

```yaml
# foo-pod.yamlãƒ•ã‚¡ã‚¤ãƒ«
apiVersion: v1
kind: Pod
metadata:
  name: foo-pod
  namespace: foo-namespace
spec:
  containers:
    - name: foo
      image: foo:1.0.0
      ports:
        - containerPort: 80
```

ã¾ãŸNamespaceã§ã¯ã€ã‚ã‚‰ã‹ã˜ã‚`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚

Istioã§ã¯`v1.10`ä»¥é™ã€ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã®ç•ªå·ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ã©ã‚“ãªå€¤ã§ã‚‚å•é¡Œãªãã€ã‚ˆãã‚ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦`default`ã‚„`stable`ãªã©ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: foo-namespace
  labels:
    # istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã€‚
    # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯è‡ªç”±
    istio.io/rev: <ã‚¨ã‚¤ãƒªã‚¢ã‚¹>
```

> â†ªï¸ å‚è€ƒï¼š[https://istio.io/latest/blog/2021/direct-upgrade/#upgrade-from-18-to-110:title]

<br>

## kube-apiserver â¡ï¸ Service

### ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€

ã€kube-apiserver â¡ï¸ Serviceã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚

![istio_container-injection_flow_red_2](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_container-injection_flow_red_2.png)

### ã€ï¼’ã€‘ èªè¨¼/èªå¯å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«

kube-apiserverã¯ã€èªè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã¨èªå¯ã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã—ã¾ã™ã€‚

### ã€ï¼“ã€‘ ã‚¢ãƒ‰ã‚ªãƒ³ã®å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«

kube-apiserverã¯ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«ã—ã¾ã™ã€‚

å‰æçŸ¥è­˜ã®éƒ¨åˆ†ã§å…·ä½“çš„ãªå®Ÿè£…ã‚’çœç•¥ã—ã¾ã—ãŸãŒã€Istioã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³`1.14.3`æ™‚ç‚¹ã§ã€MutatingWebhookConfigurationã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

Namespaceã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹æ™‚ã«ä½¿ç”¨ã—ãŸã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ã€ã“ã®MutatingWebhookConfigurationã§å®Ÿä½“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·ã¨ç´ã¥ã„ã¦ã„ã¾ã™ã€‚

```sh
$ kubectl get mutatingwebhookconfiguration istio-revision-tag-default -o yaml
```

```yaml
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: istio-revision-tag-default
  labels:
    app: sidecar-injector
    # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®å®Ÿä½“
    istio.io/rev: <ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·>
    # ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
    istio.io/tag: <ã‚¨ã‚¤ãƒªã‚¢ã‚¹>
webhooks:
  - name: rev.namespace.sidecar-injector.istio.io
    # MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã®ç™ºç«æ¡ä»¶ã‚’ç™»éŒ²ã™ã‚‹ã€‚
    rules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE"]
        resources: ["pods"]
        scope: "*"
    # Webhookã®å‰æ®µã«ã‚ã‚‹Serviceã®æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ã€‚
    clientConfig:
      service:
        name: istiod-<ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·>
        namespace: istio-system
        path: "/inject" # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        port: 443
      caBundle: Ci0tLS0tQk ...
    # Namespaceå˜ä½ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
    # ç‰¹å®šã®Namespaceã§MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã‚’ç™ºç«ã•ã›ã‚‹ã€‚
    namespaceSelector:
      matchExpressions:
        - key: istio.io/rev
          operator: DoesNotExist
        - key: istio-injection
          operator: DoesNotExist
    # Podå˜ä½ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
    # ç‰¹å®šã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã‚’ç™ºç«ã•ã›ã‚‹ã€‚
    objectSelector:
      matchExpressions:
        - key: sidecar.istio.io/inject
          operator: NotIn
          values:
            - "false"
        - key: istio.io/rev
          operator: In
          values:
            - <ã‚¨ã‚¤ãƒªã‚¢ã‚¹>

    ...
```

MutatingWebhookConfigurationã«ã¯ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç™ºç«æ¡ä»¶ã‚„webhookã‚µãƒ¼ãƒãƒ¼ã®å®›å…ˆæƒ…å ±ã‚’å®šç¾©ã—ã¾ã™ã€‚

MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç™ºç«æ¡ä»¶ã«é–¢ã—ã¦ã€ä¾‹ãˆã°Istioã§ã¯ã€ [Namespaceã‚„Pod`.metadata.labels`ã‚­ãƒ¼ã«å¿œã˜ã¦ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ã](https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#controlling-the-injection-policy)ã€ã“ã‚Œã‚’MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§åˆ¶å¾¡ã—ã¦ã„ã¾ã™ã€‚

webhookã‚µãƒ¼ãƒãƒ¼ã®å®›å…ˆæƒ…å ±ã«é–¢ã—ã¦ã€Istioã§ã¯webhookã‚µãƒ¼ãƒãƒ¼ã®å‰æ®µã«Serviceã‚’é…ç½®ã—ã¦ã„ã¾ã™ã€‚

![istio_admission-controllers_mutating-admission](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_admission-controllers_mutating-admission.png)

MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒç™ºç«ã—ãŸå ´åˆã€Serviceã®`/inject:443`ã«HTTPSãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€å®›å…ˆã®Serviceã®åå‰ãŒ`istiod-<ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·>`ã¨ãªã£ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã‚‚ã‚ã‹ã‚‹ã‚ˆã†ã«ã€Serviceã¯ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Istiodã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã«å¯¾å¿œã—ã¦ãŠã‚Šã€æƒ³å®šå¤–ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Istiodã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’æŒ‡å®šã—ãªã„ã‚ˆã†ã«åˆ¶å¾¡ã—ã¦ã„ã¾ã™ã€‚

ä¸€æ–¹ã§ç™ºç«ã—ãªã‹ã£ãŸå ´åˆã«ã¯ã€ä»¥é™ã®AdmissionReviewã®å‡¦ç†ã«ã¯é€²ã¿ã¾ã›ã‚“ã€‚

### ã€ï¼”ã€‘ AdmissionRequestã«å€¤ã‚’è©°ã‚ã‚‹

kube-apiserverã¯ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ (Podã®ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ) ã‚’AdmissionReveiewæ§‹é€ ä½“ã®AdmissionRequestã«è©°ã‚ã¾ã™ã€‚

```yaml
{
  "apiVersion": "admission.k8s.io/v1",
  "kind": "AdmissionReview",
  # AdmissionRequest
  "request": {

    ...

    # å¤‰æ›´ã•ã‚Œã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚’è¡¨ã™ã€‚
    "resource": {
      "group": "core",
      "version": "v1",
      "resource": "pods"
    },
    # kube-apiserverã®æ“ä½œã®ç¨®é¡ã‚’è¡¨ã™ã€‚
    "operation": "CREATE",

    ...

  }
}
```

### ã€ï¼•ã€‘ AdmissionReviewã‚’é€ä¿¡

kube-apiserverã¯ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€Serviceã®`/inject:443`ã«AdmissionReviewæ§‹é€ ä½“ã‚’é€ä¿¡ã—ã¾ã™ã€‚

<br>

## Service â¡ï¸ webhookã‚µãƒ¼ãƒãƒ¼

### ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€

ã€Service â¡ï¸ webhookã‚µãƒ¼ãƒãƒ¼ã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚

![istio_container-injection_flow_red_3](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_container-injection_flow_red_3.png)

### ã€ï¼–ã€‘ `15017`ç•ªãƒãƒ¼ãƒˆã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

Serviceã¯ã€`/inject:443`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ã€`discovery`ã‚³ãƒ³ãƒ†ãƒŠã®`15017`ç•ªãƒãƒ¼ãƒˆã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚

![istio_admission-controllers_mutating-admission](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_admission-controllers_mutating-admission.png)

Istioã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³`1.14.3`æ™‚ç‚¹ã§ã€Serviceã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```sh
$ kubectl get svc istiod-service -n istio-system -o yaml
```

```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: istiod
  name: istiod-<ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·>
  namespace: istio-system
spec:
  type: ClusterIP
  selector:
    app: istiod
    istio.io/rev: <ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·>
  ports:
    - name: grpc-xds
      port: 15010
      protocol: TCP
      targetPort: 15010
    - name: https-dns
      port: 15012
      protocol: TCP
      targetPort: 15012
    # webhookã‚µãƒ¼ãƒãƒ¼ã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã€‚
    - name: https-webhook
      port: 443
      protocol: TCP
      targetPort: 15017
    - name: http-monitoring
      port: 15014
      protocol: TCP
      targetPort: 15014
```

`.spec.selector.istio.io/rev`ã‚­ãƒ¼ã«ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å…ˆã®Podã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·ãŒè¨­å®šã•ã‚Œã¦ãŠã‚Šã€ã“ã®Podã¯`discovery`ã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¡ã¾ã™ã€‚

Istioã¯ã€`discovery`ã‚³ãƒ³ãƒ†ãƒŠå†…ã§webhookã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè¡Œã—ã€`15017`ç•ªãƒãƒ¼ãƒˆã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¾…ã¡å—ã‘ã¾ã™ã€‚

ã“ã“ã§ã€`discovery`ã‚³ãƒ³ãƒ†ãƒŠãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¾…ã¡å—ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒˆç•ªå·ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€`15017`ç•ªãƒãƒ¼ãƒˆã§ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```sh
$ kubectl exec foo-istiod -n istio-system -- netstat -tulpn

Active Internet connections (only servers)

Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.1:9876          0.0.0.0:*               LISTEN      1/pilot-discovery
tcp6       0      0 :::15017                :::*                    LISTEN      1/pilot-discovery
tcp6       0      0 :::8080                 :::*                    LISTEN      1/pilot-discovery
tcp6       0      0 :::15010                :::*                    LISTEN      1/pilot-discovery
tcp6       0      0 :::15012                :::*                    LISTEN      1/pilot-discovery
tcp6       0      0 :::15014                :::*                    LISTEN      1/pilot-discovery
```

> â†ªï¸ å‚è€ƒï¼š
>
> - [https://github.com/istio/istio/blob/1.14.3/pkg/kube/inject/webhook.go#L171-L172:title]
> - [https://istio.io/latest/docs/ops/deployment/requirements/#ports-used-by-istio:title]

<br>

## kube-apiserver â¬…ï¸ Service â¬…ï¸ webhookã‚µãƒ¼ãƒãƒ¼

### ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€

ã€kube-apiserver â¬…ï¸ Service â¬…ï¸ webhookã‚µãƒ¼ãƒãƒ¼ã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚

![istio_container-injection_flow_red_4](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_container-injection_flow_red_4.png)

### ã€ï¼—ã€‘ patchå‡¦ç†ã‚’å®šç¾©

ä»•çµ„ã¿ã®ä¸­ã§ã‚‚ã€ã“ã“ã¯é‡è¦ãªéƒ¨åˆ†ã§ã™ã€‚

`discovery`ã‚³ãƒ³ãƒ†ãƒŠå†…ã®webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’æ›¸ãæ›ãˆã‚‹ãŸã‚ã®patchå‡¦ç†ã‚’å®šç¾©ã—ã¾ã™ã€‚

webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®`.spec.containers[1]`ãƒ‘ã‚¹ã«`istio-proxy`ã‚­ãƒ¼ã‚’è¿½åŠ ã•ã›ã‚‹ã‚ˆã†ãªpatchå‡¦ç†ã‚’å®šç¾©ã—ã¾ã™ã€‚

ã“ã®å®šç¾©ã«ã‚ˆã£ã¦ã€çµæœçš„ã«ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒèµ·ã“ã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```yaml
[

  ...

  {
    "op": "add",
    # .spec.initContainers[1] ã‚’æŒ‡å®šã™ã‚‹ã€‚
    "path": "/spec/initContainers/1",
    # ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã‚‹æ§‹é€ ã‚’è¡¨ã™ã€‚
    "value": {
      "name": "istio-init",
      "resources": {
                     ...
      }
    }
  },
  {
    "op": "add",
    # .spec.containers[1] ã‚’æŒ‡å®šã™ã‚‹ã€‚
    "path": "/spec/containers/1",
    # ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã‚‹æ§‹é€ ã‚’è¡¨ã™ã€‚
    "value": {
      "name": "istio-proxy",
      "resources": {
                     ...
      }
    }
  }

  ...

]
```

> â†ªï¸ å‚è€ƒï¼š
>
> - [https://github.com/istio/istio/blob/a19b2ac8af3ad937640f6e29eed74472034de2f5/pkg/kube/inject/webhook.go#L171-L172:title]
> - [https://github.com/istio/istio/blob/1.14.3/pkg/kube/inject/webhook_test.go#L960-L975:title]

æœ¬é¡Œã¨è©±ãŒé€¸ã‚Œã‚‹ãŸã‚ä»Šå›ã¯è©³ã—ãè¨€åŠã—ã¾ã›ã‚“ãŒã€ä¸Šè¨˜ã®pathcå‡¦ç†ã§ã¯ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã®ä»–ã«ã€initã‚³ãƒ³ãƒ†ãƒŠã®`istio-init`ã‚³ãƒ³ãƒ†ãƒŠã‚‚ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã“ã®`istio-init`ã‚³ãƒ³ãƒ†ãƒŠã¯ã€`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¤Podã§ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰/ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ã®çµŒè·¯ã‚’åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ã€Podå†…ã«iptablesã®ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã™ã‚‹è²¬å‹™ã‚’æ‹…ã£ã¦ã„ã¾ã™ğŸ’ªğŸ»

> â†ªï¸ å‚è€ƒï¼š[https://www.sobyte.net/post/2022-07/istio-sidecar-proxy/#sidecar-traffic-interception-basic-process:title]

### ã€ï¼˜ã€‘ AdmissionResponseã«å€¤ã‚’è©°ã‚ã‚‹

`discovery`ã‚³ãƒ³ãƒ†ãƒŠå†…ã®webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€patchå‡¦ç†ã®å®šç¾©ã‚’AdmissionReveiewæ§‹é€ ä½“ã®AdmissionResponseã«è©°ã‚ã¾ã™ã€‚

`patch`ã‚­ãƒ¼ã®å€¤ã«ã€å…ˆã»ã©ã®patchå‡¦ç†ã®å®šç¾©ã‚’base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸæ–‡å­—åˆ—ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

```yaml
{
  "apiVersion": "admission.k8s.io/v1",
  "kind": "AdmissionReview",
  # AdmissionResponse
  "response": {
      "uid": "*****",
      "allowed": true,
      "patchType": "JSONPatch",
      # Patchå‡¦ç†ã®å¯¾è±¡ã¨ãªã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã¨å‡¦ç†å†…å®¹ã‚’è¡¨ã™ã€‚base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã€‚
      "patch": "<å…ˆã»ã©ã®patchå‡¦ç†ã®å®šç¾©ã‚’base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸæ–‡å­—åˆ—>",
    },
}
```

> â†ªï¸ å‚è€ƒï¼š[https://github.com/istio/istio/blob/1.14.3/pkg/kube/inject/webhook.go#L908-L915:title]

### ã€ï¼™ã€‘ AdmissionReviewã‚’è¿”ä¿¡

`discovery`ã‚³ãƒ³ãƒ†ãƒŠå†…ã®webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€AdmissionReviewæ§‹é€ ä½“ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦kube-apiserverã«è¿”ä¿¡ã—ã¾ã™ã€‚

<br>

## kube-apiserver â¡ï¸ etcd

### ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€

ã€kube-apiserver â¡ï¸ etcdã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚

![istio_container-injection_flow_red_5](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_container-injection_flow_red_5.png)

### ã€ï¼‘ï¼ã€‘ patchå‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«

kube-apiserverã¯ã€AdmissionReviewæ§‹é€ ä½“ã‚’å—ä¿¡ã—ã€AdmissionResponseã«å¿œã˜ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚

patchå‡¦ç†ã®å®šç¾©ã‚’AdmissionReviewæ§‹é€ ä½“ã‹ã‚‰å–ã‚Šå‡ºã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã¨`istio-init`ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã§ãã‚‹ã‚ˆã†ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®è©²å½“ç®‡æ‰€ã«ã‚­ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: foo-pod
  namespace: foo-namespace
spec:
  containers:
    - name: foo
      image: foo:1.0.0
      ports:
        - containerPort: 80
    # kube-apiserverãŒè¿½åŠ 
    - name: istio-proxy

      ...

  # kube-apiserverãŒè¿½åŠ 
  initContainers:
    - name: istio-init

    ...

```

### ã€ï¼‘ï¼‘ã€‘ ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ°¸ç¶šåŒ–

kube-apiserverã¯ã€etcdã«Podã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ°¸ç¶šåŒ–ã—ã¾ã™ã€‚

<br>

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¬…ï¸ kube-apiserver

### ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€

ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¬…ï¸ kube-apiserverã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚

![istio_container-injection_flow_red_6](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_container-injection_flow_red_6.png)

### ã€ï¼‘ï¼’ã€‘ ã‚³ãƒ¼ãƒ«å®Œäº†ã‚’è¿”ä¿¡

kube-apiserverã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã—ã¾ã™ã€‚

```sh
$ kubectl apply -f foo-pod.yaml

# kube-apiserverã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹
pod "foo-pod" created
```

<br>

## ä»¥é™ã®ä»•çµ„ã¿

![istio_container-injection_flow_red_7](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/istio_container-injection_flow_red_7.png)

kube-apiserverã¯ã€ä»–ã®Nodeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (kube-controlleretcdã€kube-schedulerã€kubeletã€ãªã©) ã¨é€šä¿¡ã—ã€Podã‚’ä½œæˆã—ã¾ã™ã€‚

ã“ã®Podã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¯ã€ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠã®ä»–ã«ã€`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã¨`istio-init`ã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¡ã¾ã™ã€‚

çµæœã¨ã—ã¦ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®`istio-proxy`ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã—ãŸã“ã¨ã«ãªã‚Šã¾ã™ã€‚

æœ¬é¡Œã¨è©±ãŒé€¸ã‚Œã‚‹ãŸã‚ä»Šå›ã¯è©³ã—ãè¨€åŠã—ã¾ã›ã‚“ãŒã€kube-apiserverã¨ä»–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é€šä¿¡ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®æ–¹ã®è¨˜äº‹ã¨å›³ãŒéå¸¸ã«å‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ğŸ™‡ğŸ»â€â™‚ï¸

![kubernetes_kube-apiserver_communication](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/kubernetes_kube-apiserver_communication.png)

> â†ªï¸ å‚è€ƒï¼š[https://medium.com/jorgeacetozi/kubernetes-master-components-etcd-api-server-controller-manager-and-scheduler-3a0179fc8186/:title]

<br>

# 05. ãŠã‚ã‚Šã«

Istioã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¾ã—ãŸã€‚

Istioã¸ã®æ„›ãŒæº¢ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚

ä»Šå›ç™»å ´ã—ãŸMutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«é–¢ã—ã¦ã€ç§ã®é–¢ã‚ã£ã¦ã„ã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã¯Istioä»¥å¤– (ä¾‹ï¼šCertManagerã€Prometheusã€AWSã®aws-eks-vpc-cniã‚¢ãƒ‰ã‚ªãƒ³ã€ãªã©) ã§ã‚‚ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã©ã®ã‚ˆã†ã«ä½¿ã£ã¦ã„ã‚‹ã®ã‹ã‚’ä¸€åº¦çŸ¥ã‚Œã°ã€çŸ¥è­˜ã®æ±ç”¨æ€§ãŒé«˜ã„ã¨è€ƒãˆã¦ã„ã¾ã™âœŒğŸ»

ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¯Istioã§ã‚‚åŸºæœ¬çš„ãªæ©Ÿèƒ½ã§ã‚ã‚Šã€ã‚‚ã—æœªä½“é¨“ã®æ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã‚Œã°ã€ãŠæ‰‹å…ƒã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã„ãŸã ãã¨ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ğŸ‘

<br>
