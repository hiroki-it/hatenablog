---
Title: ã€TerraformğŸ§‘ğŸ»â€ğŸš€ã€‘Terraformã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²æ‰‹æ³•
Category:
  - AWS
  - Terraform
---

<br>

[:contents]

<br>

# 01. ã¯ã˜ã‚ã«

å‰ä¸–ã®ä¿ºãŒå¾³ã‚’ç©ã¾ãªã‹ã£ãŸã›ã„ã§ã€Mitchell Hashimoto ã¨ã—ã¦ç¾ä¸–ã«ç”Ÿã¾ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã—ãŸğŸ˜­

ã•ã¦æœ€è¿‘ã®æ¥­å‹™ã§ã€å…¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®æŠ€è¡“åŸºç›¤é–‹ç™ºãƒãƒ¼ãƒ ã«æºã‚ã£ã¦ãŠã‚Šã€ãƒãƒ¼ãƒ ãŒä½¿ã£ã¦ã„ã‚‹TerraformğŸ§‘ğŸ»â€ğŸš€ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒªãƒ—ãƒ¬ã‚¤ã‚¹ã™ã‚‹ä½œæ¥­ã‚’æ‹…å½“ã—ã¾ã—ãŸã€‚

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã§ã¯å˜ä¸€ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒçŠ¶æ…‹ã‚’æŒã¡éãã¦ã„ã‚‹èª²é¡Œã‚’æŠ±ãˆã¦ã„ãŸãŸã‚ã€èª²é¡Œã«åˆã£ãŸé©åˆ‡ãªåˆ†å‰²æ‰‹æ³•ã§ãƒªãƒ—ãƒ¬ã‚¤ã‚¹ã—ã¾ã—ãŸã€‚

ä»Šå›ã¯ã€ã“ã®æ™‚ã«æ•´ç†ã—ãŸåˆ†å‰²æ‰‹æ³•ã‚’è¨˜äº‹ã§ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ãªãŠã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ä¸­ã§ã‚‚AWSå‘ã‘ã®èª¬æ˜ã¨ãªã£ã¦ã—ã¾ã†ã“ã¨ã‚’ã”å®¹èµ¦ãã ã•ã„ã€‚

ãã‚Œã§ã¯ã€ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¦ã„ãã¾ã™ğŸ˜—

<br>

# 02. ãªãœ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã™ã‚‹ã®ã‹

ãã‚‚ãã‚‚ã€ãªãœ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã™ã‚‹å¿…è¦ãªã®ã§ã—ã‚‡ã†ã‹ã€‚

æ§˜ã€…ãªã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å˜ä¸€ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã§çŠ¶æ…‹ã‚’æŒã¤ã¨ã€1å›ã®`terraform`ã‚³ãƒãƒ³ãƒ‰å…¨ã¦ã®çŠ¶æ…‹ã‚’æ“ä½œã§ãã¦æ¥½ã§ã™ã€‚

ãã®ä¸€æ–¹ã§ã€è‡ªèº«ã®ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒä»¥å¤–ã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çŠ¶æ…‹ã‚’å¤‰æ›´ã—ã‹ã‘ã¦ã„ã‚‹ã¨ã€`terraform`ã‚³ãƒãƒ³ãƒ‰ã§`target`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

![terraform_architecture_same-tfstate](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_same-tfstate.png)

<br>

ã“ã®æ™‚ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã„ã„æ„Ÿã˜ã«åˆ†å‰²ã™ã‚‹ã¨ã€ã¾ã‚‹ã§æš—é»™çš„ã«`target`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã¤ã„ãŸã‚ˆã†ã«ã€ä»–ã®ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã®å½±éŸ¿ã‚’å—ã‘ãšã«`terraform`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

![terraform_architecture_different-tfstate](https://raw.githubusercontent.com/hiroki-it/tech-notebook-images/master/images/drawio/blog/terraform/terraform_architecture_different-tfstate.png)

<br>

# 03. `tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²

## `tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²

ãã‚Œã§ã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã®å¢ƒç›®ã¯ã©ã®ã‚ˆã†ã«ã—ã¦è¦‹ã¤ã‘ã‚Œã°ã‚ˆã„ã®ã§ã—ã‚‡ã†ã‹ã€‚

ã“ã‚Œã‚’è¦‹ã¤ã‘ã‚‹ã‚³ãƒ„ã¯ã€**ä»–ã®çŠ¶æ…‹ã«ã§ãã‚‹ã ã‘ä¾å­˜ã—ãªã„ãƒªã‚½ãƒ¼ã‚¹ã®é–¢ä¿‚**ã«æ³¨ç›®ã™ã‚‹ã“ã¨ã ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒä»–ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ãã‚Œã‚’ã€**ä¾å­˜**ã€ã¨è¡¨ç¾ã™ã‚‹ã“ã¨ã¨ã—ã¾ã™ã€‚

ã“ã‚Œã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã§ã„ã†ã¨ã“ã‚ã®ã€**ä¾å­˜**ã€ã¨åŒã˜ã‚ˆã†ãªè€ƒãˆæ–¹ã¨æ€ã£ã¦ã„ãŸã ã„ã¦ã‚ˆã„ã§ã™

ä¾‹ãˆã°ã€AWSãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰ãªã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’ã„ãã¤ã‹ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ« (`foo-tfstate`ã€`bar-tfstate`ã€`baz-tfstate`) ã«åˆ†å‰²ã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚

ã“ã®æ™‚ã€ã“ã‚Œã‚‰ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®é–“ã§ä½¿ç”¨ã™ã‚‹é–¢ä¿‚ãŒãªã„ã»ã©ã‚ˆã„ã§ã™ã€‚

```mermaid
---
title: tfstateãƒ•ã‚¡ã‚¤ãƒ«ã¯äº’ã„ã«ä¾å­˜ã—ãªã„é–¢ä¿‚ã«ã‚ã‚‹
---
%%{init:{'theme':'natural'}}%%
flowchart TB
    subgraph aws
        Foo[foo-tfstate]
        Bar[bar-tfstate]
    end
```

<br>

## `tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ãŸä»–ã®æ§‹æˆ

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦æ§‹æˆã—ã¾ã—ã‚‡ã†ã€‚

```yaml
repository/
â”œâ”€â”€ foo/
â”‚   â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo/terraform.tfstate
â”‚   ...
â”‚
â””â”€â”€ bar/
    â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar/terraform.tfstate
    ...
```

<br>

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚‚ã€Terraformã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¨ãŠãŠã‚ˆãåŒã˜ã§ã‚ã‚‹æ–¹ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚

```sh
bucket/
â”œâ”€â”€ foo/
â”‚   â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ bar/
    â””â”€â”€ terraform.tfstate
```

<br>

###

[05. åˆ†å‰²æ‰‹æ³•]() ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è‡ªä½“ã‚’åˆ¥ã€…ã«ã™ã‚‹

<br>

# 04. `tfstate`ãƒ•ã‚¡ã‚¤ãƒ«é–“ã®ä¾å­˜é–¢ä¿‚ã«ã¤ã„ã¦

## ä¾å­˜é–¢ä¿‚å›³

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«é–“ã§ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹å ´åˆã«ã¯ã€ä¾å­˜é–¢ä¿‚å›³ã‚’è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€AWSãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰ãªã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’ã„ãã¤ã‹ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ« (`foo-tfstate`ã€`bar-tfstate`) ã«åˆ†å‰²ã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚

ã“ã®æ™‚ã€`foo-tfstate` â¡ï¸ `bar-tfstate` ã®æ–¹å‘ã«ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹ã¨ã€ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```mermaid
%%{init:{'theme':'natural'}}%%
flowchart TD
    subgraph aws
        Foo[foo-tfstate]
        Bar[bar-tfstate]
    end
    Foo -. ä¾å­˜ .-> Bar
```

<br>

## `terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ

### `terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹ä¾å­˜

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒä»–ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ã€`terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã™ã€‚

**ä»Šå›ã¯ã“ã¡ã‚‰ã‚’ä½¿ç”¨ã—ã¦ã€ä¾å­˜é–¢ä¿‚ã‚’å®Ÿè£…ã—ã¾ã™ã€‚**

`terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

- ä¾å­˜å…ˆã®AWSãƒªã‚½ãƒ¼ã‚¹ã«é–¢ã‚ã‚‰ãšã€åŒã˜`terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ã„å›ã™ã“ã¨ãŒã§ãã‚‹

ä¸€æ–¹ã§ã€ä»¥ä¸‹ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

- åˆ¥é€”`output`ãƒ–ãƒ­ãƒƒã‚¯ã®å®šç¾©ãŒå¿…è¦ã«ãªã‚Šã€å¯èª­æ€§ãŒä½ããªã‚‹ã€‚
- ä¾å­˜å…ˆã¨ä¾å­˜å…ƒã®é–“ã§Terraformã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å·®ãŒã‚ã‚Šã™ãã‚‹ã¨ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«é–“ã§äº’æ›æ€§ãŒãªããªã‚Šã€`terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ã§çŠ¶æ…‹ã«ä¾å­˜ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

### ä¾å­˜é–¢ä¿‚å›³

ä¾‹ãˆã°ã€AWSãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰ãªã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’ã„ãã¤ã‹ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ« (`foo-tfstate`ã€`bar-tfstate`) ã«åˆ†å‰²ã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚

`foo-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€VPCã®çŠ¶æ…‹ã‚’æŒã£ã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚

`bar-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã¯`foo-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒã¤VPCã«ä¾å­˜ã™ã‚‹ã“ã¨ã¨ãªã‚Šã€ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```mermaid
%%{init:{'theme':'natural'}}%%
flowchart TD
    subgraph bucket
        Foo[foo-tfstate]
        Bar[bar-tfstate]
    end
    Bar -. VPCã®çŠ¶æ…‹ã«ä¾å­˜ .-> Foo
```

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
repository/
â”œâ”€â”€ foo/
â”‚   â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo/terraform.tfstate
â”‚   â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚   â”œâ”€â”€ provider.tf
â”‚   ...
â”‚
â””â”€â”€ bar/
    â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar/terraform.tfstate
    â”œâ”€â”€ remote_state.tf # terraform_remote_stateãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã€foo-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
    â”œâ”€â”€ resource.tf
    â”œâ”€â”€ provider.tf
    ...
```

`bar-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒ`foo-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹ãŸã‚ã«å¿…è¦ãªå®Ÿè£…ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```terraform
# VPCã®çŠ¶æ…‹ã¯ã€foo-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã§æŒã¤
data "terraform_remote_state" "foo" {

  backend = "s3"

  config = {
    bucket = "foo-tfstate"
    key    = "foo/terraform.tfstate"
    region = "ap-northeast-1"
  }
}


# barãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã¯ã€bar-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã§æŒã¤
resource "example" "bar" {

  # barãƒªã‚½ãƒ¼ã‚¹ã¯ã€foo-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®VPCã«ä¾å­˜ã™ã‚‹
  vpc_id = data.terraform_remote_state.foo.outputs.vpc_id

  ...
}
```

```terraform
# VPCã®çŠ¶æ…‹ã¯ã€foo-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã§æŒã¤
output "vpc_id" {
  value = aws_vpc.vpc.id
}
```

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
bucket/
â”œâ”€â”€ foo
â”‚   â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ bar
    â””â”€â”€ terraform.tfstate
```

<br>

## `data`ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ

### `data`ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹ä¾å­˜ã¨ã¯

ä»–ã®æ–¹æ³•ã¨ã—ã¦ã€`data`ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã™ã€‚

`data`ãƒ–ãƒ­ãƒƒã‚¯ã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªèº«ä»¥å¤– (ä¾‹ï¼šã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã€ä»–ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«) ã§ä½œæˆã•ã‚ŒãŸAWSãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã«ä¾å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚

`data`ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

- `output`ãƒ–ãƒ­ãƒƒã‚¯ãŒä¸è¦ã§å¯èª­æ€§ãŒé«˜ã„ã€‚

ä¸€æ–¹ã§ä»¥ä¸‹ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

- ä¾å­˜å…ˆã®AWSãƒªã‚½ãƒ¼ã‚¹ã”ã¨ã«`data`ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

`terraform_remote_state`ãƒ–ãƒ­ãƒƒã‚¯ã¨ã¯ç•°ãªã‚Šã€ç›´æ¥çš„ã«ã¯`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã—ã¾ã›ã‚“ã€‚

`data`ãƒ–ãƒ­ãƒƒã‚¯ã®å ´åˆã¯ã€å®Ÿéš›ã®AWSãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã«ä¾å­˜ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€é–“æ¥çš„ã«AWSãƒªã‚½ãƒ¼ã‚¹ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

### ä¾å­˜é–¢ä¿‚å›³

`data`ãƒ–ãƒ­ãƒƒã‚¯ã‚‚åŒæ§˜ã«ã—ã¦ã€AWSãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰ãªã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’ã„ãã¤ã‹ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ« (`foo-tfstate`ã€`bar-tfstate`) ã«åˆ†å‰²ã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚

ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```mermaid
%%{init:{'theme':'natural'}}%%
flowchart TD
    subgraph bucket
        Foo[foo-tfstate]
        Bar[bar-tfstate]
    end
    Bar -. VPCã®çŠ¶æ…‹ã«ä¾å­˜ .-> Foo
```

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
repository/
â”œâ”€â”€ foo/
â”‚   â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/foo/terraform.tfstate
â”‚   â”œâ”€â”€ provider.tf
â”‚   ...
â”‚
â””â”€â”€ bar/
    â”œâ”€â”€ backend.tf # ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®/bar/terraform.tfstate
    â”œâ”€â”€ data.tf # dataãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã€foo-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
    â”œâ”€â”€ resource.tf
    â”œâ”€â”€ provider.tf
    ...
```

`bar-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ãŒ`foo-tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹ãŸã‚ã«å¿…è¦ãªå®Ÿè£…ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```terraform
# VPCã®çŠ¶æ…‹ã¯ã€foo-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã§æŒã¤
data "aws_vpc" "foo" {

  filter {
    name   = "tag:Name"
    values = ["<foo-tfstateãŒæŒã¤VPCã®åå‰>"]
  }
}

# barãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã¯ã€bar-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã§æŒã¤
resource "example" "bar" {

  # barãƒªã‚½ãƒ¼ã‚¹ã¯ã€foo-tfstateãƒ•ã‚¡ã‚¤ãƒ«ã®VPCã«ä¾å­˜ã™ã‚‹
  vpc_id     = data.aws_vpc.foo.id
}
```

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
bucket/
â”œâ”€â”€ foo
â”‚   â””â”€â”€ terraform.tfstate
â”‚
â””â”€â”€ bar
    â””â”€â”€ terraform.tfstate
```

<br>

# 05. åˆ†å‰²æ‰‹æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¦‚è¦

éšå±¤ã”ã¨ã«ã„ãã¤ã‹ã®åˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

<table>
<thead>
  <tr>
    <th>å¿…é ˆ<br>ã¾ãŸã¯<br>ä»»æ„</th><th>ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªéšå±¤</th><th>ãƒ‘ã‚¿ãƒ¼ãƒ³</th><th>ãŠã™ã™ã‚</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td rowspan="3">å¿…é ˆ</td>
  </tr>
  <tr>
    <td>ãƒªãƒã‚¸ãƒˆãƒªæ§‹æˆ<br>ã¾ãŸã¯<br>ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæœ€ä¸Šå±¤ã®æ§‹æˆ</td><td>ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥</td><td align=center><code>â­•ï¸</code></td>
  </tr>
  <tr>
    <td>ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæœ€ä¸‹å±¤ã®æ§‹æˆ</td><td>å®Ÿè¡Œç’°å¢ƒåˆ¥</td><td align=center><code>â­•ï¸</code></td>
  </tr>
  <tr>
    <td rowspan="6">ä»»æ„</td><td rowspan="7">ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸­é–“å±¤ã®æ§‹æˆ</td><td>åŒã˜ãƒ†ãƒŠãƒ³ãƒˆå†…ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåˆ¥</td><td></td>
  </tr>
  <tr>
    <td>é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥</td><td align=center><code>â­•ï¸</code></td>
  </tr>
  <tr>
    <td>ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥</td><td align=center><code>â­•ï¸</code></td>
  </tr>
  <tr>
    <td>AWSãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡åˆ¥</td><td></td>
  </tr>
  <tr>
    <td>AWSãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã®å¤‰æ›´é »åº¦åˆ¥</td><td></td>
  </tr>
  <tr>
    <td>é‹ç”¨ãƒãƒ¼ãƒ è²¬å‹™ç¯„å›²åˆ¥ã¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥ã®çµ„ã¿åˆã‚ã›</td><td align=center><code>â­•ï¸</code></td>
  </tr>
</tbody>
</table>
<br>

# 06. æœ€ä¸Šå±¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹æˆ

## ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥

ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã€æœ€ä¸Šå±¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚ã“ã‚Œã«åŸºã¥ã„ã¦åˆ†å‰²ã—ã¾ã™ã€‚

### ä¾å­˜é–¢ä¿‚å›³

ä¾å­˜é–¢ä¿‚å›³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```mermaid
%%{init:{'theme':'natural'}}%%
flowchart LR
    subgraph akamai / cloudflare
        Akamai_Cloudflare[tfstate]
    end
    subgraph pagerduty
        PagerDuty["tfstate"]
    end
    subgraph healthchecks
        Healthchecks[tfstate]
    end
    subgraph newrelic / datadog
        Newrelic_Datadog[tfstate]
    end
    subgraph aws
        Aws[tfstate]
    end
    Aws -..-> Newrelic_Datadog
    Aws -..-> Akamai_Cloudflare
    Aws -..-> Healthchecks
    Aws -..-> PagerDuty
```

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹å ´åˆã§ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
aws-repository/
â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®awsç”¨terraform.tfstate
â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”œâ”€â”€ provider.tf
...
```

```sh
<newrelicã€datadog>-repository/
â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®newrelicã€datadogç”¨terraform.tfstate
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ provider.tf
...
```

```sh
<healthchecks>-repository/
â”œâ”€â”€ backend.tf # healthchecksç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®terraform.tfstate
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ provider.tf
...
```

```sh
<pagerDuty>-repository/
â”œâ”€â”€ backend.tf # pagerdutyç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®terraform.tfstate
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ provider.tf
...
```

```sh
<akamaiã€cloudflare>-repository/
â”œâ”€â”€ backend.tf # akamaiã€cloudflareç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®terraform.tfstate
â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”œâ”€â”€ provider.tf
...
```

#### åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«åˆ†å‰²ã—ãŸ`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹å ´åˆã§ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
repository/
â”œâ”€â”€ aws/
â”‚   â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®awsç”¨terraform.tfstate
â”‚   â”œâ”€â”€ remote_state.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ã™ã‚‹
â”‚   â”œâ”€â”€ provider.tf
â”‚   ...
â”‚
â”œâ”€â”€ <newrelicã€datadog>/
â”‚   â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®datadogç”¨terraform.tfstate
â”‚   â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚   â”œâ”€â”€ provider.tf
â”‚   ...
â”‚
â”œâ”€â”€ <healthchecks>/
â”‚   â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®healthchecksç”¨terraform.tfstate
â”‚   â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚   â”œâ”€â”€ provider.tf
â”‚   ...
â”‚
â”œâ”€â”€ <pagerduty>/
â”‚    â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®pagerdutyç”¨terraform.tfstate
â”‚    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
â”‚    â”œâ”€â”€ provider.tf
â”‚    ...
â”‚
â””â”€â”€ <akamaiã€cloudflare>/
    â”œâ”€â”€ backend.tf # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®datadogç”¨terraform.tfstate
    â”œâ”€â”€ output.tf # ä»–ã®tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¾å­˜ã•ã‚Œã‚‹
    â”œâ”€â”€ provider.tf
    ...
```

<br>

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

å„ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
aws-bucket/
â””â”€â”€ terraform.tfstate # AWSã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
<newrelicã€datadog>-bucket/
â””â”€â”€ terraform.tfstate # NewRelicã€Datadogã€ã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
<healthchecks>-bucket/
â””â”€â”€ terraform.tfstate # Healthchecksã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
<pagerduty>-bucket/
â””â”€â”€ terraform.tfstate # PagerDutyã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
<akamaiã€cloudflare>-bucket/
â””â”€â”€ terraform.tfstate # Akamaiã€Cloudflareã€ã®çŠ¶æ…‹ã‚’æŒã¤
```

#### åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

å„ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
bucket/
â”œâ”€â”€ aws
â”‚   â””â”€â”€ terraform.tfstate # AWSã®çŠ¶æ…‹ã‚’æŒã¤
â”‚
â”œâ”€â”€ <newrelicã€datadog>
â”‚   â””â”€â”€ terraform.tfstate # NewRelicã€Datadogã€ã®çŠ¶æ…‹ã‚’æŒã¤
â”‚
â”œâ”€â”€ <healthchecks>
â”‚   â””â”€â”€ terraform.tfstate # Healthchecksã®çŠ¶æ…‹ã‚’æŒã¤
â”‚
â”œâ”€â”€ <pagerduty>
â”‚   â””â”€â”€ terraform.tfstate # PagerDutyã®çŠ¶æ…‹ã‚’æŒã¤
â”‚
â””â”€â”€ <akamaiã€cloudflare>
    â””â”€â”€ terraform.tfstate # Akamaiã€Cloudflareã€ã®çŠ¶æ…‹ã‚’æŒã¤

```

<br>

# 07. æœ€ä¸‹å±¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹æˆ

## å®Ÿè¡Œç’°å¢ƒåˆ¥

å®Ÿè¡Œç’°å¢ƒåˆ¥ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã€æœ€ä¸‹å±¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚ã“ã‚Œã«åŸºã¥ã„ã¦åˆ†å‰²ã—ã¾ã™ã€‚

### ä¾å­˜é–¢ä¿‚å›³

```mermaid
%%{init:{'theme':'natural'}}%%
flowchart TB
    subgraph aws
        subgraph dev-bucket
            Dev[tfstate]
        end
        subgraph stg-bucket
            Stg[tfstate]
        end
        subgraph prd-bucket
            Prd[tfstate]
        end
    end
```

### ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### ç•°ãªã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã™ã‚‹ã“ã¨ã¯å¿…é ˆã¨ã—ã¦ã„ã‚‹ãŸã‚ã€ãã®ä¸Šã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’è€ƒãˆã¾ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
aws-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ dev/ # æ¤œè¨¼ç’°å¢ƒ
â”‚   â”œâ”€â”€ backend.tfvars # awsç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®terraform.tfstate
â”‚   ...
â”‚
â”œâ”€â”€ stg/ # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
â””â”€â”€ prd/ # æœ¬ç•ªç’°å¢ƒ
```

```sh
<newrelicã€datadog>-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ dev/
â”œâ”€â”€ stg/
â””â”€â”€ prd/
```

```sh
<healthchecks>-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ dev/
â”œâ”€â”€ stg/
â””â”€â”€ prd/
```

```sh
<pagerduty>-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ dev/
â”œâ”€â”€ stg/
â””â”€â”€ prd/
```

```sh
<akamaiã€cloudflare>-repository/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ dev/
â”œâ”€â”€ stg/
â””â”€â”€ prd/
```

#### åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ

ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã™ã‚‹ã“ã¨ã¯å¿…é ˆã¨ã—ã¦ã„ã‚‹ãŸã‚ã€ãã®ä¸Šã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’è€ƒãˆã¾ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
repository/
â”œâ”€â”€ aws/
â”‚   â”œâ”€â”€ dev/ # æ¤œè¨¼ç’°å¢ƒ
â”‚   â”‚   â”œâ”€â”€ backend.tfvars # awsç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®terraform.tfstate
â”‚   â”‚   ...
â”‚   â”‚
â”‚   â”œâ”€â”€ stg/ # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
â”‚   â””â”€â”€ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚
â”œâ”€â”€ <newrelicã€datadog>/
â”‚   â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ stg/
â”‚   â””â”€â”€ prd/
â”‚
â”œâ”€â”€ <healthchecks>/
â”‚   â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ stg/
â”‚   â””â”€â”€ prd/
â”‚
â”œâ”€â”€ <pagerduty>/
â”‚   â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ stg/
â”‚   â””â”€â”€ prd/
â”‚
â””â”€â”€ <akamaiã€cloudflare>/
    â”œâ”€â”€ dev/
    â”œâ”€â”€ stg/
    â””â”€â”€ prd/
```

### ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

#### ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

å®Ÿè¡Œç’°å¢ƒåˆ¥ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ç•°ãªã‚‹ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ãªãŠã€**AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã”ã¨ã«ç•°ãªã‚‹å®Ÿè¡Œç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹ã‹ã€å˜ä¸€ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã«å…¨å®Ÿè¡Œç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹ã‹ã€ã¯ã“ã“ã§ã¯é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚**

```sh
dev-aws-bucket/
â””â”€â”€ terraform.tfstate # AWSã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
dev-<newrelicã€datadog>-bucket/
â””â”€â”€ terraform.tfstate # NewRelicã€Datadogã€ã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
dev-<healthchecks>-bucket/
â””â”€â”€ terraform.tfstate # Healthchecksã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
dev-<pagerduty>-bucket/
â””â”€â”€ terraform.tfstate # PagerDutyã®çŠ¶æ…‹ã‚’æŒã¤
```

```sh
dev-<akamaiã€cloudflare>-bucket/
â””â”€â”€ terraform.tfstate # Akamaiã€Cloudflareã€ã®çŠ¶æ…‹ã‚’æŒã¤
```

#### åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å ´åˆ

å„ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€åŒã˜ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ã—ã¾ã™ã€‚

`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã«åŸºã¥ã„ã¦ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
bucket/
â”œâ”€â”€ aws/
â”‚   â”œâ”€â”€ dev/ # æ¤œè¨¼ç’°å¢ƒ
â”‚   â”‚   â””â”€â”€ terraform.tfstate # AWSã®çŠ¶æ…‹ã‚’æŒã¤
â”‚   â”‚
â”‚   â”œâ”€â”€ stg/ # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
â”‚   â””â”€â”€ prd/ # æœ¬ç•ªç’°å¢ƒ
â”‚
â”œâ”€â”€ <newrelicã€datadog>/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â””â”€â”€ terraform.tfstate # NewRelicã€Datadogã€ã®çŠ¶æ…‹ã‚’æŒã¤
â”‚   â”‚
â”‚   â”œâ”€â”€ stg/
â”‚   â””â”€â”€ prd/
â”‚
â”œâ”€â”€ <healthchecks>/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â””â”€â”€ terraform.tfstate # Healthchecksã®çŠ¶æ…‹ã‚’æŒã¤
â”‚   â”‚
â”‚   â”œâ”€â”€ stg/
â”‚   â””â”€â”€ prd/
â”‚
â”œâ”€â”€ <pagerduty>/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â””â”€â”€ terraform.tfstate # PagerDutyã®çŠ¶æ…‹ã‚’æŒã¤
â”‚   â”‚
â”‚   â”œâ”€â”€ stg/
â”‚   â””â”€â”€ prd/
â”‚
â””â”€â”€ <akamaiã€cloudflare>/
    â”œâ”€â”€ dev/
    â”‚   â””â”€â”€ terraform.tfstate # Akamaiã€Cloudflareã€ã®çŠ¶æ…‹ã‚’æŒã¤
    â”‚
    â”œâ”€â”€ stg/
    â””â”€â”€ prd/
```

<br>

# ãŠã‚ã‚Šã«

Terraformã®`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²æ‰‹æ³•ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¾ã—ãŸã€‚

ãŸã æ­£ç›´ãªã¨ã“ã‚ã€Terraformã®é–‹ç™ºç¾å ´ã®å…·ä½“çš„ãªè¦ä»¶ã¯åƒå·®ä¸‡åˆ¥ã§ã‚ã‚Šã€ç‰¹ã«`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«é–“ã®ä¾å­˜é–¢ä¿‚ã¯æ§˜ã€…ã§ã™ã€‚

ãã®ãŸã‚ã€ã‚ã‚‰ã‚†ã‚‹è¦ä»¶ã‚’æŠ½è±¡åŒ–ã—ãŸåˆ†å‰²æ‰‹æ³•ã‚’è€ƒãˆã‚‹ã“ã¨ã¯ä¸å¯èƒ½ã ã¨æ€ã£ã¦ã„ã¾ã™ğŸ˜‡

ã‚‚ã—ã€ã“ã®è¨˜äº‹ã‚’å‚è€ƒã«è¨­è¨ˆã—ã¦ãã ã•ã‚‹æ–¹ã¯ã€åˆ†å‰²æ‰‹æ³•ã‚’ç¾å ´ã«è½ã¨ã—è¾¼ã‚“ã§è§£é‡ˆã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

ãªãŠã€`tfstate`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²ã®è€ƒãˆæ–¹ã¯ã€â€State File Isolationâ€ ã¨ã„ã†ãƒ†ãƒ¼ãƒã§ä»¥ä¸‹ã®æ›¸ç±ã«ã‚‚è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã®ã§ã€ãœã²ã”ä¸€èª­ã„ãŸã ã‘ã‚‹ã¨ğŸ™‡ğŸ»â€

> â†ªï¸ï¼š
>
> - [isbn:1098116747:title]
> - [https://www.oreilly.com/library/view/terraform-up-and/9781098116736/ch03.html:title]

<br>

æœ€å¾Œã«ã€ãŠå‹é”ã®è¨˜äº‹å†…ã®è¨€è‘‰ã‚’å¼•ç”¨ã—ã¦ãŠãã¾ã™ã€‚

> ã€Œè‡ªåˆ†ã‚’ä¿¡ã˜ã¦ã‚‚â€¦ä¿¡é ¼ã«è¶³ã‚‹ä»²é–“ã‚’ä¿¡ã˜ã¦ã‚‚â€¦èª°ã«ã‚‚ã‚ã‹ã‚‰ãªã„â€¦ã€
>
> ([`@nwiizo`](https://twitter.com/nwiizo), 2023, https://syu-m-5151.hatenablog.com/entry/2023/05/19/154346:title)

<br>

# è¬è¾

ä»Šå›ã€Terraformã®åˆ†å‰²æ‰‹æ³•ã®åé›†ã«ã‚ãŸã‚Šã€ä»¥ä¸‹ã®æ–¹ã€…ã‹ã‚‰ã®æ„è¦‹ã‚„å®Ÿè£…æ–¹æ³•ã‚‚å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

- [`@kiyo_12_07`](https://twitter.com/kiyo_12_07)
- [`@masasuzu`](https://twitter.com/masasuz)
- [`@tozastation`](https://twitter.com/tozastation)

(ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †)

ã“ã®å ´ã§æ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ğŸ™‡ğŸ»â€

<br>
