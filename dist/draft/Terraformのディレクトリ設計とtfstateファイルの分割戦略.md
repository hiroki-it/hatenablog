---
Title: 【Terraform🌏】Terraformのディレクトリ構成とtfstateファイル分割の設計パターン
Category:
  - AWS
  - Terraform
---

<br>

[:contents]

<br>

# 01. はじめに

前世の俺が徳を積まなかったせいで、Mitchell Hashimoto として現世に生まれることができませんでした...

さて最近の業務で、全プロダクト基盤開発チームがAWSをコード化するために使っているTerraform 🌏のリポジトリを、丸々リプレイスしました。

この時、ディレクトリ構成と`tfstate`ファイル分割の設計パターンをざっと整理し、その上で適切な新設計を採用しました。

今回は、この設計パターンを記事で紹介しました。

なお、クラウドプロバイダーの中でも、AWS向けの説明となってしまうことをご容赦ください。

それでは、もりもり布教していきます😗

<br>

# 02. `tfstate`ファイルの分割とは

そもそも、`tfstate`ファイルを分割する理由はなんでしょうか。

様々なインフラコンポーネントを単一のtfstateファイルで状態を管理すると、一回の`terraform`コマンド全ての状態を操作できて楽である。

この時に一つのバケット内で`tfstate`ファイルをいい感じに分割すると、他の作業ブランチの影響を受けずに`terraform`コマンドを実行できる。

そのため、全プロダクト基盤開発チームの各メンバーは、『`terraform plan`で自分の作業とは無関係な状態差分が出てしまう』という状況に悩んでいました。

# おわりに

Terraformのディレクトリ構成と`tfstate`ファイル分割の設計パターンをもりもり布教しました。

ただ正直なところ、Terraformの開発現場の具体的な要件は千差万別であり、特に`tfstate`ファイル間の依存関係は様々です。

そのため、あらゆる要件を抽象化した設計パターンを考えることは不可能だと思っています😇

もし、この記事を参考に設計してくださる方は、設計パターンを現場に落とし込んで解釈いただけると幸いです。

> 「自分を信じても…信頼に足る仲間を信じても…誰にもわからない…」([`@nwiizo`](https://twitter.com/nwiizo), 2023)
>
> [https://syu-m-5151.hatenablog.com/entry/2023/05/19/154346:title]

<br>

# 謝辞

今回のTerraformの設計パターンの収集にあたり、現場でお世話になっている [@tozastation](https://twitter.com/tozastation) さんの実装方法も参考にさせていただきました。

この場で感謝申し上げます🙇🏻‍

<br>
