---
Title: 【Kubernetes☸️】CNCFとAWSを組み合わせたマイクロサービスアーキテクチャ設計の考察
Category:
  - AWS
  - Kubernetes
  - ソフトウェアアーキテクチャ
---

<br>

# この記事から得られる知識

この記事を読むと、以下を **"完全に理解"** できます✌️

<br>

[:contents]

<br>

# 01. はじめに

<br>

どうも、日給3500ペリカの地下強制労働者です。

普段は、マイクロサービスアーキテクチャのインフラ領域に軸足を置きつつ、アプリ領域にもちょっと携わっています。

マイクロサービスアーキテクチャの設計に関する知見を探してみると、フルスクラッチの例は見つかりますが、ツール (OSS、マネージドサービス、など) を使用した具体例の記事は少ないです。

そこで、様々な情報 (今まで/現在携わっているプロダクト、書籍、事例記事、ドキュメント、GitHubのサンプル実装) を集約しつつ、どんなツールを使用すれば、マイクロサービスアーキテクチャを効率的に設計できそうかを考察してみました。

なお、OSSとしてはCNCF、マネージドサービスとしてはAWSを使用するを想定しています。

考察記事ということで動かせるサンプル実装を用意できていないため、『それやってみたけど、無理やったで』『こっちのツールのほうがええで』みたいな知見も大募集です！

それでは、もりもり布教していきます😗

<br>

# 02. 題材にするマイクロサービスアーキテクチャ

## AWSアーキテクチャ

アーキテクチャは以下の通りです。

AWSリソースで代替しても不都合のない機能は、AWSリソースを使うことを想定しています。

## アプリ領域の設計

AWS ALBとIstio IngressGatewayを繋ぐ時に、AWS Load Balancer Controllerを使用してもいいですが、なくても良いと考えています。

Istio IngressGatewayにNodePort Serviceを使用すれば、AWS Load Balancer Controllerが不要になります。

Istio IngressGatewayはKubernetesで、ALBはTerraformで管理します。

<br>

## インフラ領域の設計

<br>


# 03. 認証認可

## 全体像

```mermaid
---
title: OIDC (認可コードフロー)
---
sequenceDiagram
    ブラウザ (PC、スマホ) ->> Istio IngressGateway: リクエスト<br>(ホーム画面)

    Istio IngressGateway ->> フロントエンドアプリ (PC、スマホ) : リクエスト

    フロントエンドアプリ (PC、スマホ) ->> OAuth2 Proxy: 認可リクエスト

    OAuth2 Proxy ->> IDプロバイダー (Keycloak、Google) : 転送

    IDプロバイダー (Keycloak、Google) -->> ブラウザ (PC、スマホ) : コールバックURL宛の認可レスポンス<br>(アカウント連携確認ページ)

    ブラウザ (PC、スマホ) ->> Istio IngressGateway: リダイレクト

    Istio IngressGateway ->> フロントエンドアプリ (PC、スマホ) : リダイレクト

    フロントエンドアプリ (PC、スマホ) ->> OAuth2 Proxy: リダイレクト

    OAuth2 Proxy ->> IDプロバイダー (Keycloak、Google) : 転送

    IDプロバイダー (Keycloak、Google) -->> ブラウザ (PC、スマホ) : 認可コード<br>レスポンス

    ブラウザ (PC、スマホ) ->> Istio IngressGateway: リダイレクト

    Istio IngressGateway ->> フロントエンドアプリ (PC、スマホ) : リダイレクト

    フロントエンドアプリ (PC、スマホ) ->> OAuth2 Proxy: トークンリクエスト

    OAuth2 Proxy ->> IDプロバイダー (Keycloak、Google) : 転送

    IDプロバイダー (Keycloak、Google) -->> OAuth2 Proxy : アクセストークン、リフレッシュトークン、IDトークン

    OAuth2 Proxy -->> フロントエンドアプリ (PC、スマホ) : 転送

    フロントエンドアプリ (PC、スマホ) ->> フロントエンドアプリ (PC、スマホ) : IDトークン検証

フロントエンドアプリ (PC、スマホ) -->> Istio IngressGateway : 

Istio IngressGateway -->> ブラウザ (PC、スマホ) :

ブラウザ (PC、スマホ) ->> ブラウザ (PC、スマホ) : LocalStorage等<br>アクセストークン保存

フロントエンドアプリ (PC、スマホ) ->> OAuth2 Proxy: リクエスト<br>(Authorizationヘッダー: "アクセストークン")

OAuth2 Proxy ->> IDプロバイダー (Keycloak、Google) : 転送

IDプロバイダー (Keycloak、Google) -->> OAuth2 Proxy : レスポンス<br>(ユーザー情報)

OAuth2 Proxy -->> フロントエンドアプリ (PC、スマホ) : 転送

フロントエンドアプリ (PC、スマホ) ->> BFF (PCブラウザ用API Gateway): リクエスト<br>(Authorizationヘッダー: "アクセストークン")

BFF (PCブラウザ用API Gateway) ->> マイクロサービス : リクエスト

マイクロサービス -->> IDプロバイダー (Keycloak、Google) : リクエスト<br>(アクセストークン検証)

IDプロバイダー (Keycloak、Google) ->> IDプロバイダー (Keycloak、Google) : アクセストークン検証

IDプロバイダー (Keycloak、Google) ->> マイクロサービス : レスポンス<br>(トークン検証結果)

マイクロサービス ->> マイクロサービス : 認可実行<br>(ドメイン層など)

マイクロサービス ->> DB (Aurora): SQL実行

DB (Aurora) -->> マイクロサービス : データ取得

マイクロサービス -->> BFF (PCブラウザ用API Gateway) : レスポンス<br>(データ)

BFF (PCブラウザ用API Gateway) -->> フロントエンドアプリ (PC、スマホ) : レスポンス<br>(ホーム画面情報)

フロントエンドアプリ (PC、スマホ) ->> フロントエンドアプリ (PC、スマホ) : HTML生成

フロントエンドアプリ (PC、スマホ) -->> Istio IngressGateway: レスポンス<br>(ホーム画面)

Istio IngressGateway -->> ブラウザ (PC、スマホ): レスポンス
```



## マイクロサービス

RequestAuthenticationリソースを使用して、`istio-proxy`コンテナに認証ロジックを切り分けてもよいです。

ただ、アプリチームとしては、`istio-proxy`コンテナ側に認証ロジックがあるよりも、アプリ側にロジックがある方が直感的かと思います。

<br>

# 03. AWS EKS以外の選択肢

ここまで、マイクロサービスアーキテクチャをAWS EKSで動かす例を解説しました。

ここでは、他のAWSリソースの選択肢と、マイクロサービスアーキテクチャとの相性を考えようと思います。

あくまで僕の宗派ですので、以下のAWSリソースでマイクロサービスアーキテクチャを作るべきだという方もいると思います。

### AWS ECS

AWS ECSを使用して、マイクロサービスアーキテクチャを動かします。

この場合、マイクロサービスをAWS ECSサービスに対応させ、AWS ECSタスクでマイクロサービスをスケーリングすることになります。

また、マイクロサービス間の通信はリクエストリプライ方式になります。

AWS ECSは、AWS EKSよりもアプリ領域とインフラ領域の責務がより曖昧になります。

アプリ領域とインフラ領域が分業が進んでいない組織では、責務の境界が曖昧でも問題は起こりにくいです。

その一方で、組織が大きくなるほどAWS ECSの管理者がボトルネックになります。

例えば、AWS ECSを管理しているのがインフラチームだとして、ただアプリチームのコンテナの設定はAWS ECSに反映しないといけないです。

この時、インフラチームに依頼することになるのですが、インフラチームが手一杯であれば、スピード感が落ちます。

システムの将来的な拡張性を想定してマイクロサービスアーキテクチャを採用したはずなのに、これでは本末転倒かなと思います。

ただ、AWS EKSに至るまでの中継地点として、AWS ECSを採用することはアリと考えています。

<br>

### AWS Lambda

AWS Lambdaを使用して、マイクロサービスアーキテクチャを動かします。

この場合、マイクロサービスをAWS Lambdaに対応させることになります。

また、マイクロサービス間の通信はイベント駆動方式になります。

AWS Lambdaは、AWS EKSやAWS ECSよりもさらにアプリ領域とインフラ領域の責務がより曖昧になります。

組織が大きくなるほどAWS Lambdaの管理者がボトルネックになり、AWS ECSよりも拡張性の問題は顕著です。

また、イベント駆動方式とリクエストリプライ方式はドメインのモデリング方法が大きくことなります。

そのため、AWS EKSやAWS ECSに至るまでの中継地点としても採用する場合、イベント駆動方式を採用し続けることになります。

これらのことから、AWS Lambdaでマイクロサービスアーキテクチャを採用するべきではないと考えています。

<br>

# 04. おわりに

今回は設計の概要しか解説できませんでした。

それぞれのトピックをもう少し丁寧に解説した記事も出したいです。

借金全額返済まで残り1050年っ...！

<br>
